var Si=Object.defineProperty;var Ii=(X,Q,ae)=>Q in X?Si(X,Q,{enumerable:!0,configurable:!0,writable:!0,value:ae}):X[Q]=ae;var N=(X,Q,ae)=>(Ii(X,typeof Q!="symbol"?Q+"":Q,ae),ae);(function(){"use strict";var X={};Object.defineProperty(X,"__esModule",{value:!0}),X.bech32m=Y=X.bech32=void 0;const Q="qpzry9x8gf2tvdw0s3jn54khce6mua7l",ae={};for(let e=0;e<Q.length;e++){const t=Q.charAt(e);ae[t]=e}function Ae(e){const t=e>>25;return(e&33554431)<<5^-(t>>0&1)&996825010^-(t>>1&1)&642813549^-(t>>2&1)&513874426^-(t>>3&1)&1027748829^-(t>>4&1)&705979059}function St(e){let t=1;for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);if(r<33||r>126)return"Invalid prefix ("+e+")";t=Ae(t)^r>>5}t=Ae(t);for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);t=Ae(t)^r&31}return t}function Ve(e,t,n,r){let s=0,i=0;const o=(1<<n)-1,a=[];for(let c=0;c<e.length;++c)for(s=s<<t|e[c],i+=t;i>=n;)i-=n,a.push(s>>i&o);if(r)i>0&&a.push(s<<n-i&o);else{if(i>=t)return"Excess padding";if(s<<n-i&o)return"Non-zero padding"}return a}function Pn(e){return Ve(e,8,5,!0)}function Mn(e){const t=Ve(e,5,8,!1);if(Array.isArray(t))return t}function Hn(e){const t=Ve(e,5,8,!1);if(Array.isArray(t))return t;throw new Error(t)}function It(e){let t;e==="bech32"?t=1:t=734539939;function n(o,a,c){if(c=c||90,o.length+7+a.length>c)throw new TypeError("Exceeds length limit");o=o.toLowerCase();let u=St(o);if(typeof u=="string")throw new Error(u);let h=o+"1";for(let f=0;f<a.length;++f){const b=a[f];if(b>>5)throw new Error("Non 5-bit word");u=Ae(u)^b,h+=Q.charAt(b)}for(let f=0;f<6;++f)u=Ae(u);u^=t;for(let f=0;f<6;++f){const b=u>>(5-f)*5&31;h+=Q.charAt(b)}return h}function r(o,a){if(a=a||90,o.length<8)return o+" too short";if(o.length>a)return"Exceeds length limit";const c=o.toLowerCase(),u=o.toUpperCase();if(o!==c&&o!==u)return"Mixed-case string "+o;o=c;const h=o.lastIndexOf("1");if(h===-1)return"No separator character for "+o;if(h===0)return"Missing prefix for "+o;const f=o.slice(0,h),b=o.slice(h+1);if(b.length<6)return"Data too short";let T=St(f);if(typeof T=="string")return T;const A=[];for(let w=0;w<b.length;++w){const m=b.charAt(w),E=ae[m];if(E===void 0)return"Unknown character "+m;T=Ae(T)^E,!(w+6>=b.length)&&A.push(E)}return T!==t?"Invalid checksum for "+o:{prefix:f,words:A}}function s(o,a){const c=r(o,a);if(typeof c=="object")return c}function i(o,a){const c=r(o,a);if(typeof c=="object")return c;throw new Error(c)}return{decodeUnsafe:s,decode:i,encode:n,toWords:Pn,fromWordsUnsafe:Mn,fromWords:Hn}}var Y=X.bech32=It("bech32");X.bech32m=It("bech32m");var Rt={};(function(e){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0;function t(l){if(!Number.isSafeInteger(l))throw new Error(`Wrong integer: ${l}`)}e.assertNumber=t;function n(...l){const g=(d,p)=>v=>d(p(v)),y=Array.from(l).reverse().reduce((d,p)=>d?g(d,p.encode):p.encode,void 0),I=l.reduce((d,p)=>d?g(d,p.decode):p.decode,void 0);return{encode:y,decode:I}}function r(l){return{encode:g=>{if(!Array.isArray(g)||g.length&&typeof g[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return g.map(y=>{if(t(y),y<0||y>=l.length)throw new Error(`Digit index outside alphabet: ${y} (alphabet: ${l.length})`);return l[y]})},decode:g=>{if(!Array.isArray(g)||g.length&&typeof g[0]!="string")throw new Error("alphabet.decode input should be array of strings");return g.map(y=>{if(typeof y!="string")throw new Error(`alphabet.decode: not string element=${y}`);const I=l.indexOf(y);if(I===-1)throw new Error(`Unknown letter: "${y}". Allowed: ${l}`);return I})}}}function s(l=""){if(typeof l!="string")throw new Error("join separator should be string");return{encode:g=>{if(!Array.isArray(g)||g.length&&typeof g[0]!="string")throw new Error("join.encode input should be array of strings");for(let y of g)if(typeof y!="string")throw new Error(`join.encode: non-string input=${y}`);return g.join(l)},decode:g=>{if(typeof g!="string")throw new Error("join.decode input should be string");return g.split(l)}}}function i(l,g="="){if(t(l),typeof g!="string")throw new Error("padding chr should be string");return{encode(y){if(!Array.isArray(y)||y.length&&typeof y[0]!="string")throw new Error("padding.encode input should be array of strings");for(let I of y)if(typeof I!="string")throw new Error(`padding.encode: non-string input=${I}`);for(;y.length*l%8;)y.push(g);return y},decode(y){if(!Array.isArray(y)||y.length&&typeof y[0]!="string")throw new Error("padding.encode input should be array of strings");for(let d of y)if(typeof d!="string")throw new Error(`padding.decode: non-string input=${d}`);let I=y.length;if(I*l%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;I>0&&y[I-1]===g;I--)if(!((I-1)*l%8))throw new Error("Invalid padding: string has too much padding");return y.slice(0,I)}}}function o(l){if(typeof l!="function")throw new Error("normalize fn should be function");return{encode:g=>g,decode:g=>l(g)}}function a(l,g,y){if(g<2)throw new Error(`convertRadix: wrong from=${g}, base cannot be less than 2`);if(y<2)throw new Error(`convertRadix: wrong to=${y}, base cannot be less than 2`);if(!Array.isArray(l))throw new Error("convertRadix: data should be array");if(!l.length)return[];let I=0;const d=[],p=Array.from(l);for(p.forEach(v=>{if(t(v),v<0||v>=g)throw new Error(`Wrong integer: ${v}`)});;){let v=0,_=!0;for(let B=I;B<p.length;B++){const M=p[B],k=g*v+M;if(!Number.isSafeInteger(k)||g*v/g!==v||k-M!==g*v)throw new Error("convertRadix: carry overflow");if(v=k%y,p[B]=Math.floor(k/y),!Number.isSafeInteger(p[B])||p[B]*y+v!==k)throw new Error("convertRadix: carry overflow");if(_)p[B]?_=!1:I=B;else continue}if(d.push(v),_)break}for(let v=0;v<l.length-1&&l[v]===0;v++)d.push(0);return d.reverse()}const c=(l,g)=>g?c(g,l%g):l,u=(l,g)=>l+(g-c(l,g));function h(l,g,y,I){if(!Array.isArray(l))throw new Error("convertRadix2: data should be array");if(g<=0||g>32)throw new Error(`convertRadix2: wrong from=${g}`);if(y<=0||y>32)throw new Error(`convertRadix2: wrong to=${y}`);if(u(g,y)>32)throw new Error(`convertRadix2: carry overflow from=${g} to=${y} carryBits=${u(g,y)}`);let d=0,p=0;const v=2**y-1,_=[];for(const B of l){if(t(B),B>=2**g)throw new Error(`convertRadix2: invalid data word=${B} from=${g}`);if(d=d<<g|B,p+g>32)throw new Error(`convertRadix2: carry overflow pos=${p} from=${g}`);for(p+=g;p>=y;p-=y)_.push((d>>p-y&v)>>>0);d&=2**p-1}if(d=d<<y-p&v,!I&&p>=g)throw new Error("Excess padding");if(!I&&d)throw new Error(`Non-zero padding: ${d}`);return I&&p>0&&_.push(d>>>0),_}function f(l){return t(l),{encode:g=>{if(!(g instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return a(Array.from(g),2**8,l)},decode:g=>{if(!Array.isArray(g)||g.length&&typeof g[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(a(g,l,2**8))}}}function b(l,g=!1){if(t(l),l<=0||l>32)throw new Error("radix2: bits should be in (0..32]");if(u(8,l)>32||u(l,8)>32)throw new Error("radix2: carry overflow");return{encode:y=>{if(!(y instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return h(Array.from(y),8,l,!g)},decode:y=>{if(!Array.isArray(y)||y.length&&typeof y[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(h(y,l,8,g))}}}function T(l){if(typeof l!="function")throw new Error("unsafeWrapper fn should be function");return function(...g){try{return l.apply(null,g)}catch{}}}function A(l,g){if(t(l),typeof g!="function")throw new Error("checksum fn should be function");return{encode(y){if(!(y instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const I=g(y).slice(0,l),d=new Uint8Array(y.length+l);return d.set(y),d.set(I,y.length),d},decode(y){if(!(y instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const I=y.slice(0,-l),d=g(I).slice(0,l),p=y.slice(-l);for(let v=0;v<l;v++)if(d[v]!==p[v])throw new Error("Invalid checksum");return I}}}e.utils={alphabet:r,chain:n,checksum:A,radix:f,radix2:b,join:s,padding:i},e.base16=n(b(4),r("0123456789ABCDEF"),s("")),e.base32=n(b(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),i(5),s("")),e.base32hex=n(b(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),i(5),s("")),e.base32crockford=n(b(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),o(l=>l.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=n(b(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),i(6),s("")),e.base64url=n(b(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),i(6),s(""));const w=l=>n(f(58),r(l),s(""));e.base58=w("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=w("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=w("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const m=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(l){let g="";for(let y=0;y<l.length;y+=8){const I=l.subarray(y,y+8);g+=e.base58.encode(I).padStart(m[I.length],"1")}return g},decode(l){let g=[];for(let y=0;y<l.length;y+=11){const I=l.slice(y,y+11),d=m.indexOf(I.length),p=e.base58.decode(I);for(let v=0;v<p.length-d;v++)if(p[v]!==0)throw new Error("base58xmr: wrong padding");g=g.concat(Array.from(p.slice(p.length-d)))}return Uint8Array.from(g)}};const E=l=>n(A(4,g=>l(l(g))),e.base58);e.base58check=E;const R=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),U=[996825010,642813549,513874426,1027748829,705979059];function x(l){const g=l>>25;let y=(l&33554431)<<5;for(let I=0;I<U.length;I++)(g>>I&1)===1&&(y^=U[I]);return y}function L(l,g,y=1){const I=l.length;let d=1;for(let p=0;p<I;p++){const v=l.charCodeAt(p);if(v<33||v>126)throw new Error(`Invalid prefix (${l})`);d=x(d)^v>>5}d=x(d);for(let p=0;p<I;p++)d=x(d)^l.charCodeAt(p)&31;for(let p of g)d=x(d)^p;for(let p=0;p<6;p++)d=x(d);return d^=y,R.encode(h([d%2**30],30,5,!1))}function S(l){const g=l==="bech32"?1:734539939,y=b(5),I=y.decode,d=y.encode,p=T(I);function v(k,$,z=90){if(typeof k!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof k}`);if(!Array.isArray($)||$.length&&typeof $[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof $}`);const Z=k.length+7+$.length;if(z!==!1&&Z>z)throw new TypeError(`Length ${Z} exceeds limit ${z}`);return k=k.toLowerCase(),`${k}1${R.encode($)}${L(k,$,g)}`}function _(k,$=90){if(typeof k!="string")throw new Error(`bech32.decode input should be string, not ${typeof k}`);if(k.length<8||$!==!1&&k.length>$)throw new TypeError(`Wrong string length: ${k.length} (${k}). Expected (8..${$})`);const z=k.toLowerCase();if(k!==z&&k!==k.toUpperCase())throw new Error("String must be lowercase or uppercase");k=z;const Z=k.lastIndexOf("1");if(Z===0||Z===-1)throw new Error('Letter "1" must be present between prefix and data only');const oe=k.slice(0,Z),ce=k.slice(Z+1);if(ce.length<6)throw new Error("Data must be at least 6 characters long");const te=R.decode(ce).slice(0,-6),Se=L(oe,te,g);if(!ce.endsWith(Se))throw new Error(`Invalid checksum in ${k}: expected "${Se}"`);return{prefix:oe,words:te}}const B=T(_);function M(k){const{prefix:$,words:z}=_(k,!1);return{prefix:$,words:z,bytes:I(z)}}return{encode:v,decode:_,decodeToBytes:M,decodeUnsafe:B,fromWords:I,fromWordsUnsafe:p,toWords:d}}e.bech32=S("bech32"),e.bech32m=S("bech32m"),e.utf8={encode:l=>new TextDecoder().decode(l),decode:l=>new TextEncoder().encode(l)},e.hex=n(b(4),r("0123456789abcdef"),s(""),o(l=>{if(typeof l!="string"||l.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof l} with length ${l.length}`);return l.toLowerCase()}));const O={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},C=`Invalid encoding type. Available types: ${Object.keys(O).join(", ")}`,D=(l,g)=>{if(typeof l!="string"||!O.hasOwnProperty(l))throw new TypeError(C);if(!(g instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return O[l].encode(g)};e.bytesToString=D,e.str=e.bytesToString;const P=(l,g)=>{if(!O.hasOwnProperty(l))throw new TypeError(C);if(typeof g!="string")throw new TypeError("stringToBytes() expects string");return O[l].decode(g)};e.stringToBytes=P,e.bytes=e.stringToBytes})(Rt);const{bech32:re,hex:K,utf8:Wn}=Rt,Ot={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},Ut={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},kt={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},Bt={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},Le=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],qn={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},zn=BigInt("2100000000000000000"),Lt=BigInt(1e11),Je={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},Ct={};for(let e=0,t=Object.keys(Je);e<t.length;e++){const n=t[e],r=Je[t[e]].toString();Ct[r]=n}const jn={1:e=>K.encode(re.fromWordsUnsafe(e)),16:e=>K.encode(re.fromWordsUnsafe(e)),13:e=>Wn.encode(re.fromWordsUnsafe(e)),19:e=>K.encode(re.fromWordsUnsafe(e)),23:e=>K.encode(re.fromWordsUnsafe(e)),27:e=>K.encode(re.fromWordsUnsafe(e)),6:Ce,24:Ce,3:Zn,5:Gn};function Fn(e){return t=>({tagCode:parseInt(e),words:re.encode("unknown",t,Number.MAX_SAFE_INTEGER)})}function Ce(e){return e.reverse().reduce((t,n,r)=>t+n*Math.pow(32,r),0)}function Zn(e){const t=[];let n,r,s,i,o,a=re.fromWordsUnsafe(e);for(;a.length>0;)n=K.encode(a.slice(0,33)),r=K.encode(a.slice(33,41)),s=parseInt(K.encode(a.slice(41,45)),16),i=parseInt(K.encode(a.slice(45,49)),16),o=parseInt(K.encode(a.slice(49,51)),16),a=a.slice(51),t.push({pubkey:n,short_channel_id:r,fee_base_msat:s,fee_proportional_millionths:i,cltv_expiry_delta:o});return t}function Gn(e){const t=e.slice().reverse().map(s=>[!!(s&1),!!(s&2),!!(s&4),!!(s&8),!!(s&16)]).reduce((s,i)=>s.concat(i),[]);for(;t.length<Le.length*2;)t.push(!1);const n={};Le.forEach((s,i)=>{let o;t[i*2]?o="required":t[i*2+1]?o="supported":o="unsupported",n[s]=o});const r=t.slice(Le.length*2);return n.extra_bits={start_bit:Le.length*2,bits:r,has_required:r.reduce((s,i,o)=>o%2!==0?s||!1:s||i,!1)},n}function _t(e,t){let n,r;if(e.slice(-1).match(/^[munp]$/))n=e.slice(-1),r=e.slice(0,-1);else{if(e.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");r=e}if(!r.match(/^\d+$/))throw new Error("Not a valid human readable amount");const s=BigInt(r),i=n?s*Lt/qn[n]:s*Lt;if(n==="p"&&s%BigInt(10)!==BigInt(0)||i>zn)throw new Error("Amount is outside of valid range");return t?i.toString():i}function Dn(e,t){if(typeof e!="string")throw new Error("Lightning Payment Request must be string");if(e.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");const n=[],r=re.decode(e,Number.MAX_SAFE_INTEGER);e=e.toLowerCase();const s=r.prefix;let i=r.words,o=e.slice(s.length+1),a=i.slice(-104);i=i.slice(0,-104);let c=s.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(c&&!c[2]&&(c=s.match(/^ln(\S+)$/)),!c)throw new Error("Not a proper lightning payment request");n.push({name:"lightning_network",letters:"ln"});const u=c[1];let h;if(t){if(t.bech32===void 0||t.pubKeyHash===void 0||t.scriptHash===void 0||!Array.isArray(t.validWitnessVersions))throw new Error("Invalid network");h=t}else switch(u){case Ot.bech32:h=Ot;break;case Ut.bech32:h=Ut;break;case kt.bech32:h=kt;break;case Bt.bech32:h=Bt;break}if(!h||h.bech32!==u)throw new Error("Unknown coin bech32 prefix");n.push({name:"coin_network",letters:u,value:h});const f=c[2];let b;if(f){const x=c[3];b=_t(f+x,!0),n.push({name:"amount",letters:c[2]+c[3],value:b})}else b=null;n.push({name:"separator",letters:"1"});const T=Ce(i.slice(0,7));i=i.slice(7),n.push({name:"timestamp",letters:o.slice(0,7),value:T}),o=o.slice(7);let A,w,m,E;for(;i.length>0;){const x=i[0].toString();A=Ct[x]||"unknown_tag",w=jn[x]||Fn(x),i=i.slice(1),m=Ce(i.slice(0,2)),i=i.slice(2),E=i.slice(0,m),i=i.slice(m),n.push({name:A,tag:o[0],letters:o.slice(0,1+2+m),value:w(E)}),o=o.slice(1+2+m)}n.push({name:"signature",letters:o.slice(0,104),value:K.encode(re.fromWordsUnsafe(a))}),o=o.slice(104),n.push({name:"checksum",letters:o});let R={paymentRequest:e,sections:n,get expiry(){let x=n.find(L=>L.name==="expiry");if(x)return U("timestamp")+x.value},get route_hints(){return n.filter(x=>x.name==="route_hint").map(x=>x.value)}};for(let x in Je)x!=="route_hint"&&Object.defineProperty(R,x,{get(){return U(x)}});return R;function U(x){let L=n.find(S=>S.name===x);return L?L.value:void 0}}var Nn={decode:Dn,hrpToMillisat:_t};function Xe(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function Qn(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}function $t(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function Vn(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Xe(e.outputLen),Xe(e.blockLen)}function Jn(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Xn(e,t){$t(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const pe={number:Xe,bool:Qn,bytes:$t,hash:Vn,exists:Jn,output:Xn},Ye=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Pt=e=>e instanceof Uint8Array,Ke=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),se=(e,t)=>e<<32-t|e>>>t;if(!(new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68))throw new Error("Non little-endian hardware is not supported");Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function Yn(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function et(e){if(typeof e=="string"&&(e=Yn(e)),!Pt(e))throw new Error(`expected Uint8Array, got ${typeof e}`);return e}function Kn(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!Pt(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}class Mt{clone(){return this._cloneInto()}}function Ht(e){const t=r=>e().update(et(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function Wt(e=32){if(Ye&&typeof Ye.getRandomValues=="function")return Ye.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}function er(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(n>>s&i),a=Number(n&i),c=r?4:0,u=r?0:4;e.setUint32(t+c,o,r),e.setUint32(t+u,a,r)}class tr extends Mt{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=Ke(this.buffer)}update(t){pe.exists(this);const{view:n,buffer:r,blockLen:s}=this;t=et(t);const i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=Ke(t);for(;s<=i-o;o+=s)this.process(c,o);continue}r.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){pe.exists(this),pe.output(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;n[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let f=o;f<s;f++)n[f]=0;er(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=Ke(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=c/4,h=this.get();if(u>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return t.length=s,t.pos=a,t.finished=i,t.destroyed=o,s%n&&t.buffer.set(r),t}}const nr=(e,t,n)=>e&t^~e&n,rr=(e,t,n)=>e&t^e&n^t&n,sr=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ue=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),le=new Uint32Array(64);class qt extends tr{constructor(){super(64,32,8,!1),this.A=ue[0]|0,this.B=ue[1]|0,this.C=ue[2]|0,this.D=ue[3]|0,this.E=ue[4]|0,this.F=ue[5]|0,this.G=ue[6]|0,this.H=ue[7]|0}get(){const{A:t,B:n,C:r,D:s,E:i,F:o,G:a,H:c}=this;return[t,n,r,s,i,o,a,c]}set(t,n,r,s,i,o,a,c){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(t,n){for(let f=0;f<16;f++,n+=4)le[f]=t.getUint32(n,!1);for(let f=16;f<64;f++){const b=le[f-15],T=le[f-2],A=se(b,7)^se(b,18)^b>>>3,w=se(T,17)^se(T,19)^T>>>10;le[f]=w+le[f-7]+A+le[f-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:c,G:u,H:h}=this;for(let f=0;f<64;f++){const b=se(a,6)^se(a,11)^se(a,25),T=h+b+nr(a,c,u)+sr[f]+le[f]|0,w=(se(r,2)^se(r,13)^se(r,22))+rr(r,s,i)|0;h=u,u=c,c=a,a=o+T|0,o=i,i=s,s=r,r=T+w|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,h=h+this.H|0,this.set(r,s,i,o,a,c,u,h)}roundClean(){le.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class ir extends qt{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const _e=Ht(()=>new qt);Ht(()=>new ir);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const zt=BigInt(0),$e=BigInt(1),or=BigInt(2),Pe=e=>e instanceof Uint8Array,cr=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function fe(e){if(!Pe(e))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=cr[e[n]];return t}function jt(e){const t=e.toString(16);return t.length&1?`0${t}`:t}function tt(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return BigInt(e===""?"0":`0x${e}`)}function Te(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let r=0;r<n.length;r++){const s=r*2,i=e.slice(s,s+2),o=Number.parseInt(i,16);if(Number.isNaN(o)||o<0)throw new Error("Invalid byte sequence");n[r]=o}return n}function G(e){return tt(fe(e))}function nt(e){if(!Pe(e))throw new Error("Uint8Array expected");return tt(fe(Uint8Array.from(e).reverse()))}function de(e,t){return Te(e.toString(16).padStart(t*2,"0"))}function Ft(e,t){return de(e,t).reverse()}function ar(e){return Te(jt(e))}function j(e,t,n){let r;if(typeof t=="string")try{r=Te(t)}catch(i){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${i}`)}else if(Pe(t))r=Uint8Array.from(t);else throw new Error(`${e} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function we(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!Pe(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}function ur(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function lr(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function fr(e){let t;for(t=0;e>zt;e>>=$e,t+=1);return t}function dr(e,t){return e>>BigInt(t)&$e}const hr=(e,t,n)=>e|(n?$e:zt)<<BigInt(t),rt=e=>(or<<BigInt(e-1))-$e,st=e=>new Uint8Array(e),Zt=e=>Uint8Array.from(e);function Gt(e,t,n){if(typeof e!="number"||e<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=st(e),s=st(e),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...f)=>n(s,r,...f),c=(f=st())=>{s=a(Zt([0]),f),r=a(),f.length!==0&&(s=a(Zt([1]),f),r=a())},u=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let f=0;const b=[];for(;f<t;){r=a();const T=r.slice();b.push(T),f+=r.length}return we(...b)};return(f,b)=>{o(),c(f);let T;for(;!(T=b(u()));)c();return o(),T}}const gr={bigint:e=>typeof e=="bigint",function:e=>typeof e=="function",boolean:e=>typeof e=="boolean",string:e=>typeof e=="string",isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>typeof e=="function"&&Number.isSafeInteger(e.outputLen)};function Ue(e,t,n={}){const r=(s,i,o)=>{const a=gr[i];if(typeof a!="function")throw new Error(`Invalid validator "${i}", expected function`);const c=e[s];if(!(o&&c===void 0)&&!a(c,e))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${i}`)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(n))r(s,i,!0);return e}var pr=Object.freeze({__proto__:null,bitGet:dr,bitLen:fr,bitMask:rt,bitSet:hr,bytesToHex:fe,bytesToNumberBE:G,bytesToNumberLE:nt,concatBytes:we,createHmacDrbg:Gt,ensureBytes:j,equalBytes:ur,hexToBytes:Te,hexToNumber:tt,numberToBytesBE:de,numberToBytesLE:Ft,numberToHexUnpadded:jt,numberToVarBytesBE:ar,utf8ToBytes:lr,validateObject:Ue});/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const q=BigInt(0),H=BigInt(1),ye=BigInt(2),wr=BigInt(3),it=BigInt(4),Dt=BigInt(5),Nt=BigInt(8);BigInt(9),BigInt(16);function F(e,t){const n=e%t;return n>=q?n:t+n}function yr(e,t,n){if(n<=q||t<q)throw new Error("Expected power/modulo > 0");if(n===H)return q;let r=H;for(;t>q;)t&H&&(r=r*e%n),e=e*e%n,t>>=H;return r}function V(e,t,n){let r=e;for(;t-- >q;)r*=r,r%=n;return r}function ot(e,t){if(e===q||t<=q)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=F(e,t),r=t,s=q,i=H;for(;n!==q;){const a=r/n,c=r%n,u=s-i*a;r=n,n=c,s=i,i=u}if(r!==H)throw new Error("invert: does not exist");return F(s,t)}function br(e){const t=(e-H)/ye;let n,r,s;for(n=e-H,r=0;n%ye===q;n/=ye,r++);for(s=ye;s<e&&yr(s,t,e)!==e-H;s++);if(r===1){const o=(e+H)/it;return function(c,u){const h=c.pow(u,o);if(!c.eql(c.sqr(h),u))throw new Error("Cannot find square root");return h}}const i=(n+H)/ye;return function(a,c){if(a.pow(c,t)===a.neg(a.ONE))throw new Error("Cannot find square root");let u=r,h=a.pow(a.mul(a.ONE,s),n),f=a.pow(c,i),b=a.pow(c,n);for(;!a.eql(b,a.ONE);){if(a.eql(b,a.ZERO))return a.ZERO;let T=1;for(let w=a.sqr(b);T<u&&!a.eql(w,a.ONE);T++)w=a.sqr(w);const A=a.pow(h,H<<BigInt(u-T-1));h=a.sqr(A),f=a.mul(f,A),b=a.mul(b,h),u=T}return f}}function mr(e){if(e%it===wr){const t=(e+H)/it;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(e%Nt===Dt){const t=(e-Dt)/Nt;return function(r,s){const i=r.mul(s,ye),o=r.pow(i,t),a=r.mul(s,o),c=r.mul(r.mul(a,ye),o),u=r.mul(a,r.sub(c,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return br(e)}const Er=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function vr(e){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=Er.reduce((r,s)=>(r[s]="function",r),t);return Ue(e,n)}function Ar(e,t,n){if(n<q)throw new Error("Expected power > 0");if(n===q)return e.ONE;if(n===H)return t;let r=e.ONE,s=t;for(;n>q;)n&H&&(r=e.mul(r,s)),s=e.sqr(s),n>>=H;return r}function Tr(e,t){const n=new Array(t.length),r=t.reduce((i,o,a)=>e.is0(o)?i:(n[a]=i,e.mul(i,o)),e.ONE),s=e.inv(r);return t.reduceRight((i,o,a)=>e.is0(o)?i:(n[a]=e.mul(i,n[a]),e.mul(i,o)),s),n}function ct(e,t){const n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function xr(e,t,n=!1,r={}){if(e<=q)throw new Error(`Expected Fp ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:i}=ct(e,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=mr(e),a=Object.freeze({ORDER:e,BITS:s,BYTES:i,MASK:rt(s),ZERO:q,ONE:H,create:c=>F(c,e),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return q<=c&&c<e},is0:c=>c===q,isOdd:c=>(c&H)===H,neg:c=>F(-c,e),eql:(c,u)=>c===u,sqr:c=>F(c*c,e),add:(c,u)=>F(c+u,e),sub:(c,u)=>F(c-u,e),mul:(c,u)=>F(c*u,e),pow:(c,u)=>Ar(a,c,u),div:(c,u)=>F(c*ot(u,e),e),sqrN:c=>c*c,addN:(c,u)=>c+u,subN:(c,u)=>c-u,mulN:(c,u)=>c*u,inv:c=>ot(c,e),sqrt:r.sqrt||(c=>o(a,c)),invertBatch:c=>Tr(a,c),cmov:(c,u,h)=>h?u:c,toBytes:c=>n?Ft(c,i):de(c,i),fromBytes:c=>{if(c.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${c.length}`);return n?nt(c):G(c)}});return Object.freeze(a)}function Sr(e,t,n=!1){e=j("privateHash",e);const r=e.length,s=ct(t).nByteLength+8;if(s<24||r<s||r>1024)throw new Error(`hashToPrivateScalar: expected ${s}-1024 bytes of input, got ${r}`);const i=n?nt(e):G(e);return F(i,t-H)+H}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ir=BigInt(0),at=BigInt(1);function Rr(e,t){const n=(s,i)=>{const o=i.negate();return s?o:i},r=s=>{const i=Math.ceil(t/s)+1,o=2**(s-1);return{windows:i,windowSize:o}};return{constTimeNegate:n,unsafeLadder(s,i){let o=e.ZERO,a=s;for(;i>Ir;)i&at&&(o=o.add(a)),a=a.double(),i>>=at;return o},precomputeWindow(s,i){const{windows:o,windowSize:a}=r(i),c=[];let u=s,h=u;for(let f=0;f<o;f++){h=u,c.push(h);for(let b=1;b<a;b++)h=h.add(u),c.push(h);u=h.double()}return c},wNAF(s,i,o){const{windows:a,windowSize:c}=r(s);let u=e.ZERO,h=e.BASE;const f=BigInt(2**s-1),b=2**s,T=BigInt(s);for(let A=0;A<a;A++){const w=A*c;let m=Number(o&f);o>>=T,m>c&&(m-=b,o+=at);const E=w,R=w+Math.abs(m)-1,U=A%2!==0,x=m<0;m===0?h=h.add(n(U,i[E])):u=u.add(n(x,i[R]))}return{p:u,f:h}},wNAFCached(s,i,o,a){const c=s._WINDOW_SIZE||1;let u=i.get(s);return u||(u=this.precomputeWindow(s,c),c!==1&&i.set(s,a(u))),this.wNAF(c,u,o)}}}function Qt(e){return vr(e.Fp),Ue(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...ct(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Or(e){const t=Qt(e);Ue(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:Ur,hexToBytes:kr}=pr,be={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(e){const{Err:t}=be;if(e.length<2||e[0]!==2)throw new t("Invalid signature integer tag");const n=e[1],r=e.subarray(2,n+2);if(!n||r.length!==n)throw new t("Invalid signature integer: wrong length");if(r[0]&128)throw new t("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return{d:Ur(r),l:e.subarray(n+2)}},toSig(e){const{Err:t}=be,n=typeof e=="string"?kr(e):e;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new t("Invalid signature tag");if(n[1]!==r-2)throw new t("Invalid signature: incorrect length");const{d:s,l:i}=be._parseInt(n.subarray(2)),{d:o,l:a}=be._parseInt(i);if(a.length)throw new t("Invalid signature: left bytes after parsing");return{r:s,s:o}},hexFromSig(e){const t=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const h=u.toString(16);return h.length&1?`0${h}`:h},r=t(n(e.s)),s=t(n(e.r)),i=r.length/2,o=s.length/2,a=n(i),c=n(o);return`30${n(o+i+4)}02${c}${s}02${a}${r}`}},ie=BigInt(0),J=BigInt(1);BigInt(2);const Vt=BigInt(3);BigInt(4);function Br(e){const t=Or(e),{Fp:n}=t,r=t.toBytes||((A,w,m)=>{const E=w.toAffine();return we(Uint8Array.from([4]),n.toBytes(E.x),n.toBytes(E.y))}),s=t.fromBytes||(A=>{const w=A.subarray(1),m=n.fromBytes(w.subarray(0,n.BYTES)),E=n.fromBytes(w.subarray(n.BYTES,2*n.BYTES));return{x:m,y:E}});function i(A){const{a:w,b:m}=t,E=n.sqr(A),R=n.mul(E,A);return n.add(n.add(R,n.mul(A,w)),m)}if(!n.eql(n.sqr(t.Gy),i(t.Gx)))throw new Error("bad generator point: equation left != right");function o(A){return typeof A=="bigint"&&ie<A&&A<t.n}function a(A){if(!o(A))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(A){const{allowedPrivateKeyLengths:w,nByteLength:m,wrapPrivateKey:E,n:R}=t;if(w&&typeof A!="bigint"){if(A instanceof Uint8Array&&(A=fe(A)),typeof A!="string"||!w.includes(A.length))throw new Error("Invalid key");A=A.padStart(m*2,"0")}let U;try{U=typeof A=="bigint"?A:G(j("private key",A,m))}catch{throw new Error(`private key must be ${m} bytes, hex or bigint, not ${typeof A}`)}return E&&(U=F(U,R)),a(U),U}const u=new Map;function h(A){if(!(A instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(w,m,E){if(this.px=w,this.py=m,this.pz=E,w==null||!n.isValid(w))throw new Error("x required");if(m==null||!n.isValid(m))throw new Error("y required");if(E==null||!n.isValid(E))throw new Error("z required")}static fromAffine(w){const{x:m,y:E}=w||{};if(!w||!n.isValid(m)||!n.isValid(E))throw new Error("invalid affine point");if(w instanceof f)throw new Error("projective point not allowed");const R=U=>n.eql(U,n.ZERO);return R(m)&&R(E)?f.ZERO:new f(m,E,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(w){const m=n.invertBatch(w.map(E=>E.pz));return w.map((E,R)=>E.toAffine(m[R])).map(f.fromAffine)}static fromHex(w){const m=f.fromAffine(s(j("pointHex",w)));return m.assertValidity(),m}static fromPrivateKey(w){return f.BASE.multiply(c(w))}_setWindowSize(w){this._WINDOW_SIZE=w,u.delete(this)}assertValidity(){if(this.is0()){if(t.allowInfinityPoint)return;throw new Error("bad point: ZERO")}const{x:w,y:m}=this.toAffine();if(!n.isValid(w)||!n.isValid(m))throw new Error("bad point: x or y not FE");const E=n.sqr(m),R=i(w);if(!n.eql(E,R))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:w}=this.toAffine();if(n.isOdd)return!n.isOdd(w);throw new Error("Field doesn't support isOdd")}equals(w){h(w);const{px:m,py:E,pz:R}=this,{px:U,py:x,pz:L}=w,S=n.eql(n.mul(m,L),n.mul(U,R)),O=n.eql(n.mul(E,L),n.mul(x,R));return S&&O}negate(){return new f(this.px,n.neg(this.py),this.pz)}double(){const{a:w,b:m}=t,E=n.mul(m,Vt),{px:R,py:U,pz:x}=this;let L=n.ZERO,S=n.ZERO,O=n.ZERO,C=n.mul(R,R),D=n.mul(U,U),P=n.mul(x,x),l=n.mul(R,U);return l=n.add(l,l),O=n.mul(R,x),O=n.add(O,O),L=n.mul(w,O),S=n.mul(E,P),S=n.add(L,S),L=n.sub(D,S),S=n.add(D,S),S=n.mul(L,S),L=n.mul(l,L),O=n.mul(E,O),P=n.mul(w,P),l=n.sub(C,P),l=n.mul(w,l),l=n.add(l,O),O=n.add(C,C),C=n.add(O,C),C=n.add(C,P),C=n.mul(C,l),S=n.add(S,C),P=n.mul(U,x),P=n.add(P,P),C=n.mul(P,l),L=n.sub(L,C),O=n.mul(P,D),O=n.add(O,O),O=n.add(O,O),new f(L,S,O)}add(w){h(w);const{px:m,py:E,pz:R}=this,{px:U,py:x,pz:L}=w;let S=n.ZERO,O=n.ZERO,C=n.ZERO;const D=t.a,P=n.mul(t.b,Vt);let l=n.mul(m,U),g=n.mul(E,x),y=n.mul(R,L),I=n.add(m,E),d=n.add(U,x);I=n.mul(I,d),d=n.add(l,g),I=n.sub(I,d),d=n.add(m,R);let p=n.add(U,L);return d=n.mul(d,p),p=n.add(l,y),d=n.sub(d,p),p=n.add(E,R),S=n.add(x,L),p=n.mul(p,S),S=n.add(g,y),p=n.sub(p,S),C=n.mul(D,d),S=n.mul(P,y),C=n.add(S,C),S=n.sub(g,C),C=n.add(g,C),O=n.mul(S,C),g=n.add(l,l),g=n.add(g,l),y=n.mul(D,y),d=n.mul(P,d),g=n.add(g,y),y=n.sub(l,y),y=n.mul(D,y),d=n.add(d,y),l=n.mul(g,d),O=n.add(O,l),l=n.mul(p,d),S=n.mul(I,S),S=n.sub(S,l),l=n.mul(I,g),C=n.mul(p,C),C=n.add(C,l),new f(S,O,C)}subtract(w){return this.add(w.negate())}is0(){return this.equals(f.ZERO)}wNAF(w){return T.wNAFCached(this,u,w,m=>{const E=n.invertBatch(m.map(R=>R.pz));return m.map((R,U)=>R.toAffine(E[U])).map(f.fromAffine)})}multiplyUnsafe(w){const m=f.ZERO;if(w===ie)return m;if(a(w),w===J)return this;const{endo:E}=t;if(!E)return T.unsafeLadder(this,w);let{k1neg:R,k1:U,k2neg:x,k2:L}=E.splitScalar(w),S=m,O=m,C=this;for(;U>ie||L>ie;)U&J&&(S=S.add(C)),L&J&&(O=O.add(C)),C=C.double(),U>>=J,L>>=J;return R&&(S=S.negate()),x&&(O=O.negate()),O=new f(n.mul(O.px,E.beta),O.py,O.pz),S.add(O)}multiply(w){a(w);let m=w,E,R;const{endo:U}=t;if(U){const{k1neg:x,k1:L,k2neg:S,k2:O}=U.splitScalar(m);let{p:C,f:D}=this.wNAF(L),{p:P,f:l}=this.wNAF(O);C=T.constTimeNegate(x,C),P=T.constTimeNegate(S,P),P=new f(n.mul(P.px,U.beta),P.py,P.pz),E=C.add(P),R=D.add(l)}else{const{p:x,f:L}=this.wNAF(m);E=x,R=L}return f.normalizeZ([E,R])[0]}multiplyAndAddUnsafe(w,m,E){const R=f.BASE,U=(L,S)=>S===ie||S===J||!L.equals(R)?L.multiplyUnsafe(S):L.multiply(S),x=U(this,m).add(U(w,E));return x.is0()?void 0:x}toAffine(w){const{px:m,py:E,pz:R}=this,U=this.is0();w==null&&(w=U?n.ONE:n.inv(R));const x=n.mul(m,w),L=n.mul(E,w),S=n.mul(R,w);if(U)return{x:n.ZERO,y:n.ZERO};if(!n.eql(S,n.ONE))throw new Error("invZ was invalid");return{x,y:L}}isTorsionFree(){const{h:w,isTorsionFree:m}=t;if(w===J)return!0;if(m)return m(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:w,clearCofactor:m}=t;return w===J?this:m?m(f,this):this.multiplyUnsafe(t.h)}toRawBytes(w=!0){return this.assertValidity(),r(f,this,w)}toHex(w=!0){return fe(this.toRawBytes(w))}}f.BASE=new f(t.Gx,t.Gy,n.ONE),f.ZERO=new f(n.ZERO,n.ONE,n.ZERO);const b=t.nBitLength,T=Rr(f,t.endo?Math.ceil(b/2):b);return{CURVE:t,ProjectivePoint:f,normPrivateKeyToScalar:c,weierstrassEquation:i,isWithinCurveOrder:o}}function Lr(e){const t=Qt(e);return Ue(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function Cr(e){const t=Lr(e),{Fp:n,n:r}=t,s=n.BYTES+1,i=2*n.BYTES+1;function o(d){return ie<d&&d<n.ORDER}function a(d){return F(d,r)}function c(d){return ot(d,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:h,weierstrassEquation:f,isWithinCurveOrder:b}=Br({...t,toBytes(d,p,v){const _=p.toAffine(),B=n.toBytes(_.x),M=we;return v?M(Uint8Array.from([p.hasEvenY()?2:3]),B):M(Uint8Array.from([4]),B,n.toBytes(_.y))},fromBytes(d){const p=d.length,v=d[0],_=d.subarray(1);if(p===s&&(v===2||v===3)){const B=G(_);if(!o(B))throw new Error("Point is not on curve");const M=f(B);let k=n.sqrt(M);const $=(k&J)===J;return(v&1)===1!==$&&(k=n.neg(k)),{x:B,y:k}}else if(p===i&&v===4){const B=n.fromBytes(_.subarray(0,n.BYTES)),M=n.fromBytes(_.subarray(n.BYTES,2*n.BYTES));return{x:B,y:M}}else throw new Error(`Point of length ${p} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),T=d=>fe(de(d,t.nByteLength));function A(d){const p=r>>J;return d>p}function w(d){return A(d)?a(-d):d}const m=(d,p,v)=>G(d.slice(p,v));class E{constructor(p,v,_){this.r=p,this.s=v,this.recovery=_,this.assertValidity()}static fromCompact(p){const v=t.nByteLength;return p=j("compactSignature",p,v*2),new E(m(p,0,v),m(p,v,2*v))}static fromDER(p){const{r:v,s:_}=be.toSig(j("DER",p));return new E(v,_)}assertValidity(){if(!b(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!b(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(p){return new E(this.r,this.s,p)}recoverPublicKey(p){const{r:v,s:_,recovery:B}=this,M=O(j("msgHash",p));if(B==null||![0,1,2,3].includes(B))throw new Error("recovery id invalid");const k=B===2||B===3?v+t.n:v;if(k>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const $=B&1?"03":"02",z=u.fromHex($+T(k)),Z=c(k),oe=a(-M*Z),ce=a(_*Z),te=u.BASE.multiplyAndAddUnsafe(z,oe,ce);if(!te)throw new Error("point at infinify");return te.assertValidity(),te}hasHighS(){return A(this.s)}normalizeS(){return this.hasHighS()?new E(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return Te(this.toDERHex())}toDERHex(){return be.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Te(this.toCompactHex())}toCompactHex(){return T(this.r)+T(this.s)}}const R={isValidPrivateKey(d){try{return h(d),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const d=t.randomBytes(n.BYTES+8),p=Sr(d,r);return de(p,t.nByteLength)},precompute(d=8,p=u.BASE){return p._setWindowSize(d),p.multiply(BigInt(3)),p}};function U(d,p=!0){return u.fromPrivateKey(d).toRawBytes(p)}function x(d){const p=d instanceof Uint8Array,v=typeof d=="string",_=(p||v)&&d.length;return p?_===s||_===i:v?_===2*s||_===2*i:d instanceof u}function L(d,p,v=!0){if(x(d))throw new Error("first arg must be private key");if(!x(p))throw new Error("second arg must be public key");return u.fromHex(p).multiply(h(d)).toRawBytes(v)}const S=t.bits2int||function(d){const p=G(d),v=d.length*8-t.nBitLength;return v>0?p>>BigInt(v):p},O=t.bits2int_modN||function(d){return a(S(d))},C=rt(t.nBitLength);function D(d){if(typeof d!="bigint")throw new Error("bigint expected");if(!(ie<=d&&d<C))throw new Error(`bigint expected < 2^${t.nBitLength}`);return de(d,t.nByteLength)}function P(d,p,v=l){if(["recovered","canonical"].some(ve=>ve in v))throw new Error("sign() legacy options not supported");const{hash:_,randomBytes:B}=t;let{lowS:M,prehash:k,extraEntropy:$}=v;M==null&&(M=!0),d=j("msgHash",d),k&&(d=j("prehashed msgHash",_(d)));const z=O(d),Z=h(p),oe=[D(Z),D(z)];if($!=null){const ve=$===!0?B(n.BYTES):$;oe.push(j("extraEntropy",ve,n.BYTES))}const ce=we(...oe),te=z;function Se(ve){const Ie=S(ve);if(!b(Ie))return;const Cn=c(Ie),Re=u.BASE.multiply(Ie).toAffine(),ne=a(Re.x);if(ne===ie)return;const Oe=a(Cn*a(te+ne*Z));if(Oe===ie)return;let _n=(Re.x===ne?0:2)|Number(Re.y&J),$n=Oe;return M&&A(Oe)&&($n=w(Oe),_n^=1),new E(ne,$n,_n)}return{seed:ce,k2sig:Se}}const l={lowS:t.lowS,prehash:!1},g={lowS:t.lowS,prehash:!1};function y(d,p,v=l){const{seed:_,k2sig:B}=P(d,p,v),M=t;return Gt(M.hash.outputLen,M.nByteLength,M.hmac)(_,B)}u.BASE._setWindowSize(8);function I(d,p,v,_=g){var Re;const B=d;if(p=j("msgHash",p),v=j("publicKey",v),"strict"in _)throw new Error("options.strict was renamed to lowS");const{lowS:M,prehash:k}=_;let $,z;try{if(typeof B=="string"||B instanceof Uint8Array)try{$=E.fromDER(B)}catch(ne){if(!(ne instanceof be.Err))throw ne;$=E.fromCompact(B)}else if(typeof B=="object"&&typeof B.r=="bigint"&&typeof B.s=="bigint"){const{r:ne,s:Oe}=B;$=new E(ne,Oe)}else throw new Error("PARSE");z=u.fromHex(v)}catch(ne){if(ne.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(M&&$.hasHighS())return!1;k&&(p=t.hash(p));const{r:Z,s:oe}=$,ce=O(p),te=c(oe),Se=a(ce*te),ve=a(Z*te),Ie=(Re=u.BASE.multiplyAndAddUnsafe(z,Se,ve))==null?void 0:Re.toAffine();return Ie?a(Ie.x)===Z:!1}return{CURVE:t,getPublicKey:U,getSharedSecret:L,sign:y,verify:I,ProjectivePoint:u,Signature:E,utils:R}}class Jt extends Mt{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,pe.hash(t);const r=et(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return pe.exists(this),this.iHash.update(t),this}digestInto(t){pe.exists(this),pe.bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Xt=(e,t,n)=>new Jt(e,t).update(n).digest();Xt.create=(e,t)=>new Jt(e,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function _r(e){return{hash:e,hmac:(t,...n)=>Xt(e,t,Kn(...n)),randomBytes:Wt}}function $r(e,t){const n=r=>Cr({...e,..._r(r)});return Object.freeze({...n(t),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Me=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),He=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Yt=BigInt(1),We=BigInt(2),Kt=(e,t)=>(e+t/We)/t;function en(e){const t=Me,n=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),u=e*e*e%t,h=u*u*e%t,f=V(h,n,t)*h%t,b=V(f,n,t)*h%t,T=V(b,We,t)*u%t,A=V(T,s,t)*T%t,w=V(A,i,t)*A%t,m=V(w,a,t)*w%t,E=V(m,c,t)*m%t,R=V(E,a,t)*w%t,U=V(R,n,t)*h%t,x=V(U,o,t)*A%t,L=V(x,r,t)*u%t,S=V(L,We,t);if(!ut.eql(ut.sqr(S),e))throw new Error("Cannot find square root");return S}const ut=xr(Me,void 0,void 0,{sqrt:en}),lt=$r({a:BigInt(0),b:BigInt(7),Fp:ut,n:He,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=He,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-Yt*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=n,o=BigInt("0x100000000000000000000000000000000"),a=Kt(i*e,t),c=Kt(-r*e,t);let u=F(e-a*n-c*s,t),h=F(-a*r-c*i,t);const f=u>o,b=h>o;if(f&&(u=t-u),b&&(h=t-h),u>o||h>o)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:f,k1:u,k2neg:b,k2:h}}}},_e),qe=BigInt(0),tn=e=>typeof e=="bigint"&&qe<e&&e<Me,Pr=e=>typeof e=="bigint"&&qe<e&&e<He,nn={};function ze(e,...t){let n=nn[e];if(n===void 0){const r=_e(Uint8Array.from(e,s=>s.charCodeAt(0)));n=we(r,r),nn[e]=n}return _e(we(n,...t))}const ft=e=>e.toRawBytes(!0).slice(1),dt=e=>de(e,32),ht=e=>F(e,Me),ke=e=>F(e,He),gt=lt.ProjectivePoint,Mr=(e,t,n)=>gt.BASE.multiplyAndAddUnsafe(e,t,n);function pt(e){let t=lt.utils.normPrivateKeyToScalar(e),n=gt.fromPrivateKey(t);return{scalar:n.hasEvenY()?t:ke(-t),bytes:ft(n)}}function rn(e){if(!tn(e))throw new Error("bad x: need 0 < x < p");const t=ht(e*e),n=ht(t*e+BigInt(7));let r=en(n);r%We!==qe&&(r=ht(-r));const s=new gt(e,r,Yt);return s.assertValidity(),s}function sn(...e){return ke(G(ze("BIP0340/challenge",...e)))}function Hr(e){return pt(e).bytes}function Wr(e,t,n=Wt(32)){const r=j("message",e),{bytes:s,scalar:i}=pt(t),o=j("auxRand",n,32),a=dt(i^G(ze("BIP0340/aux",o))),c=ze("BIP0340/nonce",a,s,r),u=ke(G(c));if(u===qe)throw new Error("sign failed: k is zero");const{bytes:h,scalar:f}=pt(u),b=sn(h,s,r),T=new Uint8Array(64);if(T.set(h,0),T.set(dt(ke(f+b*i)),32),!on(T,r,s))throw new Error("sign: Invalid signature produced");return T}function on(e,t,n){const r=j("signature",e,64),s=j("message",t),i=j("publicKey",n,32);try{const o=rn(G(i)),a=G(r.subarray(0,32));if(!tn(a))return!1;const c=G(r.subarray(32,64));if(!Pr(c))return!1;const u=sn(dt(a),ft(o),s),h=Mr(o,c,ke(-u));return!(!h||!h.hasEvenY()||h.toAffine().x!==a)}catch{return!1}}const qr=(()=>({getPublicKey:Hr,sign:Wr,verify:on,utils:{randomPrivateKey:lt.utils.randomPrivateKey,lift_x:rn,pointToBytes:ft,numberToBytesBE:de,bytesToNumberBE:G,taggedHash:ze,mod:F}}))();let cn=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");var an=(e=>(e.AUTH="AUTH",e.CLOSE="CLOSE",e.COUNT="COUNT",e.EVENT="EVENT",e.REQ="REQ",e))(an||{}),W=(e=>(e[e.METADATA=0]="METADATA",e[e.SHORT_TEXT_NOTE=1]="SHORT_TEXT_NOTE",e[e.RECOMMEND_RELAY=2]="RECOMMEND_RELAY",e[e.CONTACTS=3]="CONTACTS",e[e.ENCRYPTED_DIRECT_MESSAGES=4]="ENCRYPTED_DIRECT_MESSAGES",e[e.EVENT_DELETION=5]="EVENT_DELETION",e[e.REPOST=6]="REPOST",e[e.REACTION=7]="REACTION",e[e.BADGE_AWARD=8]="BADGE_AWARD",e[e.GENERIC_REPOST=16]="GENERIC_REPOST",e[e.CHANNEL_CREATION=40]="CHANNEL_CREATION",e[e.CHANNEL_METADATA=41]="CHANNEL_METADATA",e[e.CHANNEL_MESSAGE=42]="CHANNEL_MESSAGE",e[e.CHANNEL_HIDE_MESSAGE=43]="CHANNEL_HIDE_MESSAGE",e[e.CHANNEL_MUTE_USER=44]="CHANNEL_MUTE_USER",e[e.FILE_METADATA=1063]="FILE_METADATA",e[e.LIVE_CHAT_MESSAGE=1311]="LIVE_CHAT_MESSAGE",e[e.REPORTING=1984]="REPORTING",e[e.LABEL=1985]="LABEL",e[e.ZAP_REQUEST=9734]="ZAP_REQUEST",e[e.ZAP_RECEIPT=9735]="ZAP_RECEIPT",e[e.MUTE_LIST=1e4]="MUTE_LIST",e[e.PIN_LIST=10001]="PIN_LIST",e[e.RELAY_LIST_METADATA=10002]="RELAY_LIST_METADATA",e[e.WALLET_INFO=13194]="WALLET_INFO",e[e.CLIENT_AUTHENTICATION=22242]="CLIENT_AUTHENTICATION",e[e.WALLET_REQUEST=23194]="WALLET_REQUEST",e[e.WALLET_RESPONSE=23195]="WALLET_RESPONSE",e[e.NOSTR_CONNECT=24133]="NOSTR_CONNECT",e[e.HTTP_AUTH=27235]="HTTP_AUTH",e[e.CATEGORIZED_PEOPLE_LIST=3e4]="CATEGORIZED_PEOPLE_LIST",e[e.CATEGORIZED_BOOKMARK_LIST=30001]="CATEGORIZED_BOOKMARK_LIST",e[e.PROFILE_BADGES=30008]="PROFILE_BADGES",e[e.BADGE_DEFINITION=30009]="BADGE_DEFINITION",e[e.CREATE_OR_UPDATE_A_STALL=30017]="CREATE_OR_UPDATE_A_STALL",e[e.CREATE_OR_UPDATE_A_PRODUCT=30018]="CREATE_OR_UPDATE_A_PRODUCT",e[e.LONG_FORM_CONTENT=30023]="LONG_FORM_CONTENT",e[e.DRAFT_LONG_FORM_CONTENT=30024]="DRAFT_LONG_FORM_CONTENT",e[e.APPLICATION_SPECIFIC_DATA=30078]="APPLICATION_SPECIFIC_DATA",e[e.LIVE_EVENT=30311]="LIVE_EVENT",e[e.CLASSIFIED_LISTING=30402]="CLASSIFIED_LISTING",e[e.DRAFT_CLASSIFIED_LISTING=30403]="DRAFT_CLASSIFIED_LISTING",e[e.HANDLER_RECOMMENDATION=31989]="HANDLER_RECOMMENDATION",e[e.HANDLER_INFORMATION=31990]="HANDLER_INFORMATION",e))(W||{}),un=(e=>(e.GITHUB="github",e.TWITTER="twitter",e.MASTODON="mastodon",e.TELEGRAM="telegram",e))(un||{}),ee=(e=>(e.AUTH="AUTH",e.COUNT="COUNT",e.EOSE="EOSE",e.EVENT="EVENT",e.NOTICE="NOTICE",e.OK="OK",e))(ee||{});function ln(e){const t=new Uint8Array(Math.ceil(e.length/2));for(let n=0;n<t.length;n++)t[n]=parseInt(e.substr(n*2,2),16);return t}function fn(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function zr(e){const t=[];for(const i of e){const o=new Uint8Array([i.type]);let a;i.type===1?a=new TextEncoder().encode(i.value):i.type===3?a=new Uint32Array([i.value]):a=ln(i.value);const c=new Uint8Array([a.length]);t.push(o),t.push(c),t.push(a)}let n=t.reduce((i,o)=>i+o.length,0);const r=new Uint8Array(n);let s=0;for(const i of t)r.set(i,s),s+=i.length;return r}function jr(e){let t=0;const n=[];for(;t<e.length;){const r=e[t++],s=e[t++];let i;if(r===3){const o=e.slice(t,t+s);i=new DataView(o.buffer).getUint32(0,!1)}else i=e.slice(t,t+s);n.push({type:r,length:s,value:i}),t+=s}return n}function Fr(e){return e.map(t=>{let n;return t.type===3?n=t.value:t.type===1?n=new TextDecoder().decode(t.value):n=fn(t.value),{type:t.type,value:n}})}function Zr(e,t){let n;e==="npub"||e==="nsec"||e==="note"||e==="lnurl"?n=ln(t[0].value):n=zr(t);const r=Y.toWords(new Uint8Array(n.buffer));return Y.encode(e,r,1023)}function Gr(e){const{prefix:t,words:n}=Y.decode(e,1023),r=new Uint8Array(Y.fromWords(n));let s;if(t==="npub"||t==="nsec"||t==="note"||t==="lnurl")s=[{type:0,value:fn(r)}];else if(t==="nprofile"||t==="nevent"||t==="nrelay"||t==="naddr"){const i=jr(r);s=Fr(i)}else throw new Error("Unknown prefix: "+t);return{prefix:t,tlvItems:s}}function Dr(e){return Nn.decode(e)}function Nr(e){const t=e.tags.filter(r=>r[0]==="amount");if(t.length===0)return;const n=[];for(const r of t)r.length===2&&n.push(r[1]);return n&&n.length>0?n:void 0}function Qr(e){return["amount",e]}function Vr(e){let t=!1,n="";for(const r of e.tags)r.find(i=>i==="content-warning")&&(t=!0,r.length===2&&r[0]==="content-warning"&&(n=r[1]),r.length===3&&r[2]==="content-warning"&&r[0]==="l"&&(n=r[1]));return t?n:void 0}var Jr=/(?:nostr:)?(npub|nsec|note|lnurl|nprofile|nevent)([a-zA-Z0-9]+)/,Xr=/(?:nostr:)?(npub|nsec|note|lnurl|nprofile|nevent)([a-zA-Z0-9]+)/g;function dn(e){if(typeof e!="string")return null;const t=e.match(Jr);return t&&t.length===3?{prefix:t[1],bech32:`${t[1]}${t[2]}`}:null}function Yr(e){return dn(e)!==null}function Kr(e){const t=dn(e);return t===null?null:Gr(t.bech32)}function es(e,t){return`nostr:${Zr(e,t)}`}function ts(e){return es("npub",[{type:0,value:e}])}function hn(e){return/^(wss?):\/\/([a-zA-Z0-9.-]+)(:\d+)?(\/[a-zA-Z0-9_/.-]*)?$/.test(e)}function ns(e,t){if(!gn(e,t).isValid)return;const r=/(.*)?(wss:\/\/[a-zA-Z0-9.-]+)/,s={message:void 0,relayUrl:void 0,nurls:[]},i=r.exec(e);if(i)return s.message=i[1]?i[1].trim():void 0,s.relayUrl=i[2],s;const o=[],a=[];let c,u;const h=[];for(;(u=Xr.exec(e))!==null;){const b=u[0];if(Yr(b)){const T=Kr(b);if(c=T.prefix,c==="npub"&&T.tlvItems.length>0){const A=T.tlvItems.filter(m=>m.type===0);if(A.length===0)continue;const w=A[0].value;o.push(w),h.push({index:u.index,length:b.length,replaceWith:w})}else if(c==="nprofile"){const A=T.tlvItems.filter(E=>E.type===0);if(A.length===0)continue;const w=A[0].value;o.push(w),h.push({index:u.index,length:b.length,replaceWith:w});const m=T.tlvItems.filter(E=>E.type===1);if(m.length===0)continue;for(const E of m)hn(E.value)?a.push(E.value):console.error(`Invalid relay url ${E.value}`)}}}let f=0;for(const{index:b,length:T,replaceWith:A}of h){const w=b+f;e=e.slice(0,w)+A+e.slice(w+T),f+=A.length-T}if(o.length>0&&c)return s.message=e.trim(),s.nurls=[{type:"npub",publicKeys:o,relayUrls:a}],s}function rs(e){if(!e)return"";let t=e.message?`${e.message} `:"";if(e.relayUrl)return`${t} ${e.relayUrl}`.trim();if(!e.nurls||e.nurls.length===0)return t.trim();for(const n of e.nurls)if(n.type==="npub")t+=`${ts(n.publicKeys[0])} `;else throw new Error(`Unsupported nurl type ${n.type}`);return t.trim()}function gn(e,t){if(!e||e==="")return{isValid:!0};if(t===6)try{return JSON.parse(e),{isValid:!0}}catch(n){return console.error(n),{isValid:!1,error:"Invalid JSON format"}}else if(t===2&&!hn(e))return{isValid:!1,error:`Expected a valid websocket URL, got ${e}.`};return ss(e)?{isValid:!1,error:"HTML tags are not allowed"}:{isValid:!0}}function ss(e){return/<[^>]*>/.test(e)}function is(e){if(!e)return;let t=[];for(let n of e){if(!Array.isArray(n)||n.length<2||n.length>3||n[0]!=="a")continue;let r=n[1].split(":");if(r.length!==3)continue;let s=r[0],i=r[1],o=r[2],a;n.length===3&&(a=n[2]),t.push({kind:s,pubkey:i,identifier:o,relay:a})}if(t.length!==0)return t}function os(e){const t=is(e.tags);if(t)return t}function cs(e){const{kind:t,pubkey:n,identifier:r,relay:s}=e;return s?[`a:${t}:${n}:${r}, ${s}`]:[`a:${t}:${n}:${r}`]}function as(e){const t=e.tags.filter(r=>r[0]==="e");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push({eventId:r[1]}):r.length===3?n.push({eventId:r[1],relayUrl:r[2]}):r.length===4&&n.push({eventId:r[1],relayUrl:r[2],marker:r[3]});return n&&n.length>0?n:void 0}function us(e){const t=e.tags.filter(r=>r[0]==="e");if(t.length===0)return;const n=[];for(let r=0;r<t.length;r++)r===0&&n.push({eventId:t[r][1],relayUrl:"",marker:"root"}),t.length===2?r===1&&n.push({eventId:t[r][1],relayUrl:"",marker:"reply"}):t.length>2&&(r===1?n.push({eventId:t[r][1],relayUrl:"",marker:"mention"}):r>1&&n.push({eventId:t[r][1],relayUrl:"",marker:"reply"}));return n&&n.length>0?n:void 0}function ls(e){return!e.tags||e.tags.length===0?!1:e.tags.filter(n=>n[0]==="e"&&n.length>2).length===0}function fs(e){const t=e.tags.filter(n=>n[0]==="expiration");if(t.length!==0)return parseInt(t[0][1])}function ds(e){const t=[],n=e.tags.filter(r=>r[0]==="d");if(n.length!==0){for(const r of n){let s=r[1]||"";t.includes(s)||t.push(s)}return t&&t.length>0?t:void 0}}function hs(e){return["d",e]}function gs(e){const t=e.tags.filter(r=>r[0]==="lnurl");if(t.length===0)return;const n=[];for(const r of t)r.length>0&&n.push(r[1]);return n&&n.length>0?n:void 0}function ps(e){return["lnurl",e]}function ws(e){const t=e.tags.filter(n=>n[0]==="nonce");if(t.length!==0)return[parseInt(t[0][1]),parseInt(t[0][2])]}function ys(e,t){if(e.hasNonceTag())throw new Error("Event already has a nonce.");if(t.length!==2)throw new Error("Nonce must be an array of 2 numbers: [miningResult, difficulty]");const n=t[0].toString(),r=t[1].toString();return e.addTag(["nonce",n,r]),e}function bs(e,t){return e.tags=e.tags.filter(n=>n[0]!=="nonce"),e.addNonceTag(t),e}function ms(e){const t=e.tags.filter(r=>r[0]==="p");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push([r[1]]):r.length===3&&n.push([r[1],r[2]]);return n}function Es(e){const t=e.tags.filter(r=>r[0]==="relays");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push({url:r[1],read:!0,write:!0}):r.length===3&&n.push({url:r[1],read:r[2]==="read",write:r[2]==="write"});return n.length>0?n:void 0}function vs(e){if(e.kind!==1984)throw new Error(`Event is not a report: ${e.kind}. Expected 1984.`);const t=e.tags.filter(a=>a[0]==="p");if(!t||t.length===0)return;let n;const r=e.tags.filter(a=>a[0]==="e");r.length>0&&r[0].length>0&&(n=r[0][1]);let s;t[0].length===3?s=t[0][2]:r.length>0&&r[0].length===3&&(s=r[0][2]);let i;return t[0].length>0&&(i=t[0][1]),!s||!i?void 0:{eventId:n,kind:s,publicKey:i,content:e.content&&e.content!==""?e.content:void 0}}function As(e){const{eventId:t,kind:n,publicKey:r}=e;if(!n)throw new Error("Report must have a kind.");if(!r)throw new Error("Report must mention a public key.");if(n==="impersonation"&&t)throw new Error("Impersonation reports should refer to a person, not an event.");const s=[];return t?(s.push(["e",t,n]),r&&s.push(["p",r])):r&&s.push(["p",r,n]),s}function Ts(e){const t=e.tags.filter(n=>n[0]==="subject");if(t.length!==0)return t[0][1]}function xs(e){return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}var Ss=new TextEncoder;new TextDecoder("utf-8");function pn(e){const t=_e(Ss.encode(e));return fe(t)}function Is({callback:e,amount:t,event:n,lnurl:r}){return`${e}?amount=${t}&nostr=${n}&lnurl=${r}`}function Rs(e){if(e.allowsNostr&&e.nostrPubkey)return!0}function Os(e,t){const n=e.amount?e.amount:void 0,r=e.lnurl?e.lnurl:void 0;if(!n||!r)return!0;const s=Dr(t.pr);let i;const o=s.sections.find(a=>a.name==="amount");if(o)i=o.value;else return!1;return!(n&&n.toString()!==i)}function Us(e){const t=new he(e),n=t.hasPublicKeyTags();if(!n)throw new Error("No pubkey tags found");if(e.kind!==9734)throw new Error("Event is not a zap request");const r=n[0],s=t.hasRelaysTag(),i={pubkey:r,content:"",id:t.id,sig:t.sig,kind:t.kind,tags:t.tags,relays:s};return JSON.stringify(i)}var ks=new TextEncoder,wn=new TextDecoder;function Bs(e){let t=/,*?((lnurl)([0-9]{1,}[a-z0-9]+){1})/.exec(e.toLowerCase());return t?t[1]:null}function Ls(e){if(e=e.trim(),e.toLowerCase().slice(0,6)==="lnurl1"){const{words:t}=Y.decode(e,2e4),n=new Uint8Array(Y.fromWords(t));return wn.decode(n)}else if(e.slice(0,9)==="lnurlc://"||e.slice(0,9)==="lnurlw://"||e.slice(0,9)==="lnurlp://"||e.slice(0,10)==="keyauth://"){let[t,n]=e.split("://");return(n.match(/\.onion($|\W)/)?"http":"https")+"://"+n}else if(e.slice(0,8)==="https://"){let t=Bs(e);if(t){const{words:n}=Y.decode(t,2e4),r=new Uint8Array(Y.fromWords(n));return wn.decode(r)}return e}throw new Error(`invalid url ${e}`)}function Cs(e){const t=ks.encode(e),n=Y.toWords(new Uint8Array(t));return Y.encode("lnurl",n,2e4)}function yn(e){return e.endsWith(".onion")}function _s(e){const[t,n]=e.split("@");return`${yn(n)?"http":"https"}://${n}/.well-known/lnurlp/${t}`}function $s(e){const[t,n]=e.split("@");return`${yn(n)?"http":"https"}://${n}/.well-known/nostr.json?name=${t}`}function Ps(e){let t=0;for(let n=0;n<e.length;n++){const r=parseInt(e[n],16);if(r===0)t+=4;else{t+=Math.clz32(r)-28;break}}return t}function Ms(e,t,n){let r=0;const s=t.toString();for(;;){const i=e.tags.findIndex(c=>c[0]==="nonce");i!==-1?e.tags[i][1]=r.toString():e.tags.push(["nonce",r.toString(),s]);const o=JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content]);if(e.id=pn(o),Ps(e.id)>=t)return console.log("Proof of work complete"),e.tags=e.tags.filter(c=>c[0]!=="nonce"),e.tags.push(["nonce",r.toString(),s]),e;if(n&&r>=n)return;r++}}function bn(e){return/^[a-z0-9\.\-_\/@]*$/.test(e)}function Hs(e){return e.toLowerCase()}function Ws(e,t){if(e.length!==64)throw new Error("Invalid event hash");const n=qr.sign(e,t);return fe(n)}function qs(e){try{const t=JSON.parse(e);return{name:t.name??null,display_name:t.display_name??null,picture:t.picture??null,banner:t.banner??null,nip05:t.nip05??null,website:t.website??null,about:t.about??null,image:t.image??null,npub:t.npub??null,lud16:t.lud16??null,lud06:t.lud06??null}}catch(t){return console.error("Unable to parse user metadata string",t),null}}var zs=class{constructor(e){if(e){if(!bn(e.identity))throw new Error("Invalid identity. Valid: a-z, 0-9, -, _, @");this.type=e.type,this.identity=Hs(e.identity),this.proof=e.proof}}toTag(){switch(this.type){case"github":return["i",`github:${this.identity}`,this.proof];case"twitter":return["i",`twitter:${this.identity}`,this.proof];case"mastodon":return["i",`mastodon:${this.identity}`,this.proof];case"telegram":return["i",`telegram:${this.identity}`,this.proof];default:throw new Error(`Unknown claim type ${this.type}. Valid: github, twitter, mastodon, telegram`)}}fromTag(e){if(mn(e))return this.type=e[1].split(":")[0],this.identity=e[1].split(":")[1],this.proof=e[2],this}};function mn(e){return!(e.length!==3||!Object.values(un).includes(e[1].split(":")[0])||!bn(e[1].split(":")[1]))}function En(e){const t=e.tags.filter(r=>r[0]==="i"&&mn(r));if(t.length===0)return;const n=[];for(const r of t){const s=new zs;s.fromTag(r),n.push(s)}return n}var he=class{constructor(e){this.id=e.id?e.id:"",this.pubkey=e.pubkey?e.pubkey:"",this.created_at=e.created_at?e.created_at:Math.floor(Date.now()/1e3),this.kind=e.kind!=null?e.kind:1,this.tags=e.tags&&e.tags.length>0?e.tags:[],this.content=e.content,this.sig=e.sig?e.sig:""}generateId(){if(this.pubkey==="")throw new Error("Cannot generate event ID without a public key. Set a public key first.");const e=xs(this.ToObj());this.id=pn(e)}sign(e){if(this.id==="")throw new Error("Cannot sign event without an ID. Generate ID first.");this.pubkey=e.publicKey,this.sig=Ws(this.id,e.privateKey)}signAndGenerateId(e){this.pubkey=e.publicKey,this.generateId(),this.sign(e)}ToObj(){const e={};for(const[t,n]of Object.entries(this))n!==void 0&&(e[t]=n);return e}toURI(){return encodeURI(JSON.stringify(this.ToObj()))}proofOfWork(e,t){const n=Ms(this,e,t);if(n)this.id=n.id,this.tags=n.tags;else throw new Error("Failed to generate proof of work.")}mentionUsers(e){if(!this.extractContent())this.content=rs({message:this.content,nurls:[{type:"npub",publicKeys:e}]});else throw new Error("Already has motified content")}hasMentions(){const e=this.extractContent();if(!e)return;const t=e==null?void 0:e.nurls.filter(n=>n.type==="npub");return t.length>0?t[0].publicKeys:void 0}setContentWithoutChecks(e){return this.content=e,this}extractContent(){return ns(this.content,this.kind)}addTag(e){this.tags||(this.tags=[]),this.tags.push(e)}removeTag(e){this.tags&&(this.tags=this.tags.filter(t=>t[0]!==e[0]&&t[1]!==e[1]))}addEventTag(e){const t=e.relayUrl?e.relayUrl:"";let n=["e",e.eventId];e.marker?n=[...n,t,e.marker]:e.relayUrl&&(n=[...n,e.relayUrl]),this.addTag(n)}hasEventTags(){return ls(this)?us(this):as(this)}addPublicKeyTag(e,t){const n=["p",e];t&&(n[1]=`${n[1]}, ${t}`),this.addTag(n)}hasPublicKeyTags(){return ms(this)}addRelaysTag(e){const t=this.tags.filter(n=>n[0]==="relays");if(t.length===0)this.tags.push(["relays",...e]);else for(const n of t)n.splice(1,0,...e)}hasRelaysTag(){return Es(this)}addEventCoordinatesTag(e){this.addTag(cs(e))}hasEventCoordinatesTags(){return os(this)}addIdentifierTag(e){this.addTag(hs(e))}hasIdentifierTags(){return ds(this)}addLnurlTag(e){this.addTag(ps(e))}hasLnurlTags(){return gs(this)}addAmountTag(e){this.addTag(Qr(e))}hasAmountTags(){return Nr(this)}addKindTag(e){this.addTag(["k",e.toString()])}addExpirationTag(e){if(this.hasExpirationTag())throw new Error("Event already has an expiration.");this.addTag(["expiration",e.toString()])}hasExpirationTag(){return fs(this)}addSubjectTag(e){if(this.kind!==1)throw new Error(`Event kind ${this.kind} should not have a subject.`);if(this.hasSubjectTag())throw new Error("Event already has a subject.");this.addTag(["subject",e])}hasSubjectTag(){return Ts(this)}addNonceTag(e){const t=ys(this,e);this.tags=t.tags}hasNonceTag(){return ws(this)}replaceNonceTag(e){const t=bs(this,e);this.tags=t.tags}addContentWarningTag(e){if(this.hasContentWarningTag())throw new Error("Event already has a content warning.");this.addTag(["content-warning",e||""])}hasContentWarningTag(){return Vr(this)}addExternalIdentityClaimTag(e){this.addTag(e.toTag())}hasExternalIdentityClaimTag(){return En(this)}addReportTags(e){if(this.kind!==1984)throw new Error(`Event kind ${this.kind} should not have a report. Expected 1984.`);if(this.hasReportTags())throw new Error("Event already has report tags.");As(e).forEach(n=>this.addTag(n))}hasReportTags(){return vs(this)}newZapReceipt(e){if(this.kind!==9734)throw new Error(`Event kind ${this.kind} should not have a zap receipt. Expected 9734.`);return Zs({bolt11:e.bolt11,description:e.description,preimage:e.preimage,zapRequest:this})}determineRequiredNIP(){const e=[];return this.hasExternalIdentityClaimTag()&&e.push(39),this.hasExpirationTag()&&e.push(40),e}isReadyToPublish(){if(this.id==="")return{isReady:!1,reason:"Event has no ID."};if(this.pubkey==="")return{isReady:!1,reason:"Event has no pubkey."};if(this.sig==="")return{isReady:!1,reason:"Event has no signature."};const e=gn(this.content,this.kind);return e.isValid?{isReady:!0}:{isReady:!1,reason:e.error}}isReadyToPublishOrThrow(){const e=this.isReadyToPublish();if(!e.isReady)throw new Error(e.reason)}};function js(e){const t=new he({content:"",kind:9734});return t.addRelaysTag(e.relayUrls),t.addAmountTag(e.amount.toString()),t.addLnurlTag(e.lnurl),t.addPublicKeyTag(e.recipientPubkey),e.eventId&&t.addEventTag({eventId:e.eventId}),t}function Fs(e,t,n){const r=js(e);r.signAndGenerateId(n);const s=r.toURI();return{event:r,eventUri:s,invoiceUrl:Is({callback:t,amount:e.amount,event:s,lnurl:e.lnurl})}}function Zs(e){const t=e.zapRequest.tags.find(i=>i[0]==="p"),n=e.zapRequest.tags.find(i=>i[0]==="e"),r=Us(e.zapRequest),s=new he({content:"",kind:9735,tags:[t,["bolt11",e.bolt11],["description",r]],created_at:e.zapRequest.created_at});return n&&s.addEventTag({eventId:n[1]}),e.preimage&&s.addTag(["preimage",e.preimage]),s}var je=class{constructor(e){this.ids=e==null?void 0:e.ids,this.authors=e==null?void 0:e.authors,this.kinds=e==null?void 0:e.kinds,this["#e"]=e==null?void 0:e["#e"],this["#p"]=e==null?void 0:e["#p"],this.since=e==null?void 0:e.since,this.until=e==null?void 0:e.until,this.limit=e==null?void 0:e.limit}addId(e){this.ids||(this.ids=[]),this.ids.push(e)}addAuthor(e){this.authors||(this.authors=[]),this.authors.push(e)}addKind(e){this.kinds||(this.kinds=[]),this.kinds.push(e)}updateLimit(e){this.limit=e}toObj(){return JSON.parse(JSON.stringify(this))}},Gs=class{constructor(e){this.subscriptions=[],this.url=e.url,this.read=e.read,this.write=e.write,this.requiresPOW=0,this.info=e.info,this.isEnabled=!0}isConnected(){return this.ws!==void 0&&this.ws.isConnected()}isReady(e){if(!this.isConnected()||!this.isEnabled)return!1;switch(e){case"read":return this.read;case"write":return this.write;case"any":return this.read||this.write;default:return!1}}supportsEvent(e){var s;const t=e.determineRequiredNIP(),n=((s=this.info)==null?void 0:s.supported_nips)||[];return console.log(`Required NIP: ${t.join(", ")}`,`Supported NIP: ${n.join(", ")}`),t.every(i=>n.includes(i))}supportsEventOrThrow(e){if(!this.supportsEvent(e))throw new Error(`Event ${e.id} is not supported by relay ${this.id}`)}addSubscription(e){this.subscriptions.push(e)}updateSubscription(e){const t=this.subscriptions.findIndex(n=>n.id===e.id);t!==-1&&(this.subscriptions[t]=e)}removeSubscription(e){this.subscriptions=this.subscriptions.filter(t=>t.id!==e)}getSubscription(e){const t=this.subscriptions.find(n=>n.id===e);return t?{...t,relayUrl:this.url,connectionId:this.id}:null}getSubscriptions(){return this.subscriptions.map(e=>({...e,relayUrl:this.url,connectionId:this.id}))}getInfo(e){return e==="default"?{url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW,isReady:this.isReady("any")}:{url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW,info:this.info,isReady:this.isReady("any")}}},Ds=class{constructor(e){this.relays=[],this.addInitialRelays(e)}addInitialRelays(e){if(e&&(!this.relays||this.relays.length===0))for(const t of e)this.relays.push(new Gs(t))}sendSubscribe(e){var s;const t=[],n=e!=null&&e.relayUrls?this.relays.filter(i=>e.relayUrls.includes(i.url)):this.relays,r="read";for(const i of n)if(i.isReady(r)){const{relayUrls:o,...a}=e,c={...a,id:cn(),relayUrl:i.url,connectionId:i.id,created:Date.now(),isActive:!0};let u;if(e.type==="REQ")u={type:"REQ",subscriptionId:c.id,filters:JSON.parse(JSON.stringify(c.filters))};else if(e.type==="COUNT"){const f=(s=i.info)==null?void 0:s.supported_nips;if(f&&!f.includes(45)){console.warn(`Relay ${i.id} does not support count command.`),c.error=`Relay ${i.id} does not support count command.`;continue}u={type:"COUNT",subscriptionId:c.id,filters:JSON.parse(JSON.stringify(c.filters))}}else throw new Error("Invalid subscription type.");const h=JSON.stringify([u.type,u.subscriptionId,u.filters]);try{i.ws.sendMessage(h),i.addSubscription(c)}catch(f){console.error(f)}}else console.warn(`Relay ${i.id} is not ready for ${r} operations. Skipping...`);return t}subscribe(e){if(e.type!=="REQ")throw new Error("Invalid subscription type. Expected REQ.");return this.sendSubscribe(e)}count(e){if(e.type!=="COUNT")throw new Error("Invalid subscription type. Expected COUNT.");return this.sendSubscribe(e)}unsubscribe(e){for(const t of this.relays){if(!t.isReady("read"))continue;const n=t.getSubscriptions();if(!n||n.length===0)continue;const r=n.filter(s=>e.includes(s.id));for(const s of r){const i={type:"CLOSE",subscriptionId:s.id};s.options&&s.options.timeout&&clearTimeout(s.options.timeout);try{t.ws.sendMessage(JSON.stringify([i.type,i.subscriptionId])),t.removeSubscription(s.id)}catch(o){console.error(o)}}}}unsubscribeAll(){for(const e of this.relays){if(e.isReady("read"))continue;const t=e.getSubscriptions();t&&t.length>0&&this.unsubscribe(t.map(n=>n.id))}}getSubscription(e){for(const t of this.relays){const n=t.getSubscription(e);if(n)return n}}getSubscriptions(){return this.relays.map(e=>e.getSubscriptions()).flat()}countSubscriptions(){return this.relays.map(e=>e.getSubscriptions().length).reduce((e,t)=>e+t,0)}updateSubscription(e){for(const t of this.relays)t.url===e.relayUrl&&t.updateSubscription(e)}countConnections(){let e=0;for(const t of this.relays)t.isConnected()&&e++;return e}sendEvent(e){const t={type:"EVENT",data:e.event},n=JSON.stringify([t.type,t.data]),r=[],s=e.relayUrls?this.relays.filter(i=>e.relayUrls.includes(i.url)):this.relays;for(const i of s)if(i.isReady("write")){const{relayUrls:o,...a}=e,c={id:cn(),...a,relayUrl:i.id,send:!0,error:void 0};if(!i.supportsEvent(e.event)){console.log(`Event ${e.event.id} not published to ${i.url} because not all needed NIPS are supported`,t),c.send=!1,c.error=`Event ${e.event.id} not published to ${i.url} because not all needed NIPS are supported`,r.push(c);continue}i.ws.sendMessage(n),r.push(c)}else console.warn(`Relay ${i.id} is not ready for write operations. Skipping...`);return r.length>0?r:void 0}sendQueueItems(e){var r;const t={type:"EVENT",data:(r=e.find(s=>s.event))==null?void 0:r.event},n=JSON.stringify([t.type,t.data]);console.log("Sending queue items",e);for(const s of e){const i=this.relays.find(o=>o.url===s.relayUrl);i&&(i.ws.sendMessage(n),s.send=!0)}return e}listen(e){for(const t of this.relays)t.isEnabled&&t.ws.listen(n=>{e({data:n,meta:t.getInfo("default")})})}disconnect(){var t;const e={subscriptions:this.countSubscriptions(),connections:this.countConnections()};console.log(`
Stats:
- Subscriptions: ${e.subscriptions}
- Connections: ${e.connections}
    `);for(const n of this.relays)(t=n.ws)==null||t.disconnect()}},Be=class{constructor(e){this.pubkey=(e==null?void 0:e.pubkey)||void 0,this.claims=(e==null?void 0:e.claims)||[],this.data=(e==null?void 0:e.data)||{},this.lastUpdated=(e==null?void 0:e.lastUpdated)||0}loaded(){return this.data!==void 0}hasZapInfo(){return this.lightningZapInfo!==void 0}fromPublicKey(e){return this.pubkey=e,this}fromEvent(e,t=!0){const n=new he(e);if(n.kind!==0){if(t)throw new Error("wrong event kind");return}if(this.pubkey&&this.pubkey!==""&&n.pubkey!==this.pubkey){if(t)throw new Error("wrong event pubkey");return}if(this.pubkey=n.pubkey,this.lastUpdated=n.created_at,n.content&&n.content!==""){const s=qs(n.content);s&&(this.data=s)}const r=En(e);return r&&(this.claims=r),this}getNip05Url(){var t;const e=((t=this.data)==null?void 0:t.nip05)||void 0;if(e)return $s(e)}validateWellKnown(e){return e?Object.keys(e.names).find(n=>e.names[n]===this.pubkey)?(this.nip05isValid=!0,!0):(this.nip05isValid=!1,!1):!1}getLud16(){var e;return((e=this.data)==null?void 0:e.lud16)||void 0}getLud16Url(){const e=this.getLud16();if(e)return _s(e)}getLud06(){var e;return((e=this.data)==null?void 0:e.lud06)||void 0}getLud06Url(){const e=this.getLud06();if(e)return Ls(e)}getLud16Or06(){const e=this.getLud06();if(e)return{type:"lud06",url:e};const t=this.getLud16();if(t)return{type:"lud16",url:t}}getLud16Or06Url(){const e=this.getLud06Url();if(e)return{type:"lud06",url:e};const t=this.getLud16Url();if(t)return{type:"lud16",url:t}}getMetadataFilter(){const e=new je;return e.addAuthor(this.pubkey),e.addKind(0),e}toJson(){return{pubkey:this.pubkey,claims:this.claims,data:this.data,lightningZapInfo:this.lightningZapInfo,lastUpdated:this.lastUpdated,nip05isValid:this.nip05isValid}}fromJson(e){return this.pubkey=e.pubkey,this.claims=e.claims,this.data=e.data,this.lightningZapInfo=e.lightningZapInfo,this.lastUpdated=e.lastUpdated,this.nip05isValid=e.nip05isValid,this}},Ns=class{constructor(){}connect(e){this.connection=new WebSocket(e)}isConnected(){return this.connection&&this.connection.readyState===this.connection.OPEN}sendMessage(e,t){const n=t||{retries:10,retryTimeout:100,retryCount:0};if(this.isConnected())this.connection.send(e);else{const r=n.retryCount+1;if(r===10)throw new Error(`Could not send message after ${r} retries`);setTimeout(()=>this.sendMessage(e,n),100)}}listen(e){this.connection.onmessage=t=>{e(JSON.parse(t.data))}}disconnect(){this.connection.close()}};async function Fe(e,t){try{let n=await Promise.race([fetch(e,{headers:t}),new Promise((s,i)=>setTimeout(()=>i(new Error("Timeout")),5e3))]);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(n){throw new Error(`Error making request: ${n}`)}}async function Qs(e){let t=e.replace(/^wss:\/\//i,"https://");console.log("###############"),console.log("Fetching relay information from",t),console.log("###############");const n=new AbortController;return setTimeout(()=>{n.abort()},5e3),Fe(t,{Accept:"application/nostr+json"})}var Vs=class extends Ds{constructor(e,t){super(e),(!t&&e||e&&t.connectManually!==!0)&&this.connectRelays()}connectRelays(){console.log(`=> Connecting to ${this.relays.length} relay(s) ...`);for(const e of this.relays)if(!e.isConnected())try{e.ws=new Ns,e.ws.connect(e.url),e.ws.connection.onopen=()=>{`${e.id}${e.url}`},e.ws.connection.onclose=t=>{console.log(`WebSocket ID ${e.id} error: `,t)},e.ws.connection.onerror=t=>{console.log(`WebSocket ID ${e.id} disconnected from ${e.url}`,t.code,t.reason)}}catch(t){console.error("Error connecting to relay",t)}}loadFromDiscovered(e){this.addInitialRelays(e.map(t=>({url:t.url,read:!0,write:!0}))),this.connectRelays()}async getRelayInformation(){const e=[];for(const t of this.relays)if(!t.info)try{t.info=await Qs(t.url),console.log(`Relay ${t.url} information`,t.info),e.push(t.getInfo("withInfo"))}catch(n){console.error("Error getting relay information",n)}return e}},Js=class extends Be{constructor(e){super(e)}async makeZapRequest(e,t){const n=this.getLud16Or06Url();if(n)try{if(!this.hasZapInfo()){const o=await Fe(n.url);if(!Rs(o))throw new Error("Lnurl endpoint does not allow Nostr payments. Expected to find 'allowsNostr' in response.");this.lightningZapInfo=o}console.log("LnurlEndpointResponse",this.lightningZapInfo);const r={...e,recipientPubkey:this.pubkey,lnurl:n.type==="lud16"?Cs(this.getLud16()):this.getLud06()},s=Fs(r,this.lightningZapInfo.callback,t),i=await Fe(s.invoiceUrl);if(!Os(r,i))throw new Error("Lnurl invoice response is invalid or does not match your request.");return console.log("LnurlInvoiceResponse",i),{...i,event:s.event}}catch(r){throw new Error(`Error making zap request: ${r}`)}else throw new Error("No lud16 or lud06 url found")}async makeNIP05Request(){const e=this.getNip05Url();if(e)try{return await Fe(e)}catch(t){throw new Error(`Error making NIP05 request: ${t}`)}else throw new Error("No nip05 url found")}};const Xs=(e,t)=>t.some(n=>e instanceof n);let vn,An;function Ys(){return vn||(vn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ks(){return An||(An=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Tn=new WeakMap,wt=new WeakMap,xn=new WeakMap,yt=new WeakMap,bt=new WeakMap;function ei(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(ge(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",o)});return t.then(n=>{n instanceof IDBCursor&&Tn.set(n,e)}).catch(()=>{}),bt.set(t,e),t}function ti(e){if(wt.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});wt.set(e,t)}let mt={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return wt.get(e);if(t==="objectStoreNames")return e.objectStoreNames||xn.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ge(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function ni(e){mt=e(mt)}function ri(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(Et(this),t,...n);return xn.set(r,t.sort?t.sort():[t]),ge(r)}:Ks().includes(e)?function(...t){return e.apply(Et(this),t),ge(Tn.get(this))}:function(...t){return ge(e.apply(Et(this),t))}}function si(e){return typeof e=="function"?ri(e):(e instanceof IDBTransaction&&ti(e),Xs(e,Ys())?new Proxy(e,mt):e)}function ge(e){if(e instanceof IDBRequest)return ei(e);if(yt.has(e))return yt.get(e);const t=si(e);return t!==e&&(yt.set(e,t),bt.set(t,e)),t}const Et=e=>bt.get(e);function ii(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(e,t),a=ge(o);return r&&o.addEventListener("upgradeneeded",c=>{r(ge(o.result),c.oldVersion,c.newVersion,ge(o.transaction),c)}),n&&o.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}const oi=["get","getKey","getAll","getAllKeys","count"],ci=["put","add","delete","clear"],vt=new Map;function Sn(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(vt.get(t))return vt.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=ci.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||oi.includes(n)))return;const i=async function(o,...a){const c=this.transaction(o,s?"readwrite":"readonly");let u=c.store;return r&&(u=u.index(a.shift())),(await Promise.all([u[n](...a),s&&c.done]))[0]};return vt.set(t,i),i}ni(e=>({...e,get:(t,n,r)=>Sn(t,n)||e.get(t,n,r),has:(t,n)=>!!Sn(t,n)||e.has(t,n)}));const ai=25;/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const In=Symbol("Comlink.proxy"),ui=Symbol("Comlink.endpoint"),li=Symbol("Comlink.releaseProxy"),At=Symbol("Comlink.finalizer"),Ze=Symbol("Comlink.thrown"),Rn=e=>typeof e=="object"&&e!==null||typeof e=="function",fi={canHandle:e=>Rn(e)&&e[In],serialize(e){const{port1:t,port2:n}=new MessageChannel;return Tt(e,t),[n,[n]]},deserialize(e){return e.start(),pi(e)}},di={canHandle:e=>Rn(e)&&Ze in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},On=new Map([["proxy",fi],["throw",di]]);function hi(e,t){for(const n of e)if(t===n||n==="*"||n instanceof RegExp&&n.test(t))return!0;return!1}function Tt(e,t=globalThis,n=["*"]){t.addEventListener("message",function r(s){if(!s||!s.data)return;if(!hi(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:o,path:a}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(me);let u;try{const h=a.slice(0,-1).reduce((b,T)=>b[T],e),f=a.reduce((b,T)=>b[T],e);switch(o){case"GET":u=f;break;case"SET":h[a.slice(-1)[0]]=me(s.data.value),u=!0;break;case"APPLY":u=f.apply(h,c);break;case"CONSTRUCT":{const b=new f(...c);u=Ei(b)}break;case"ENDPOINT":{const{port1:b,port2:T}=new MessageChannel;Tt(e,T),u=mi(b,[b])}break;case"RELEASE":u=void 0;break;default:return}}catch(h){u={value:h,[Ze]:0}}Promise.resolve(u).catch(h=>({value:h,[Ze]:0})).then(h=>{const[f,b]=Qe(h);t.postMessage(Object.assign(Object.assign({},f),{id:i}),b),o==="RELEASE"&&(t.removeEventListener("message",r),Un(t),At in e&&typeof e[At]=="function"&&e[At]())}).catch(h=>{const[f,b]=Qe({value:new TypeError("Unserializable return value"),[Ze]:0});t.postMessage(Object.assign(Object.assign({},f),{id:i}),b)})}),t.start&&t.start()}function gi(e){return e.constructor.name==="MessagePort"}function Un(e){gi(e)&&e.close()}function pi(e,t){return xt(e,[],t)}function Ge(e){if(e)throw new Error("Proxy has been released and is not useable")}function kn(e){return xe(e,{type:"RELEASE"}).then(()=>{Un(e)})}const De=new WeakMap,Ne="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(De.get(e)||0)-1;De.set(e,t),t===0&&kn(e)});function wi(e,t){const n=(De.get(t)||0)+1;De.set(t,n),Ne&&Ne.register(e,t,e)}function yi(e){Ne&&Ne.unregister(e)}function xt(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(i,o){if(Ge(r),o===li)return()=>{yi(s),kn(e),r=!0};if(o==="then"){if(t.length===0)return{then:()=>s};const a=xe(e,{type:"GET",path:t.map(c=>c.toString())}).then(me);return a.then.bind(a)}return xt(e,[...t,o])},set(i,o,a){Ge(r);const[c,u]=Qe(a);return xe(e,{type:"SET",path:[...t,o].map(h=>h.toString()),value:c},u).then(me)},apply(i,o,a){Ge(r);const c=t[t.length-1];if(c===ui)return xe(e,{type:"ENDPOINT"}).then(me);if(c==="bind")return xt(e,t.slice(0,-1));const[u,h]=Bn(a);return xe(e,{type:"APPLY",path:t.map(f=>f.toString()),argumentList:u},h).then(me)},construct(i,o){Ge(r);const[a,c]=Bn(o);return xe(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:a},c).then(me)}});return wi(s,e),s}function bi(e){return Array.prototype.concat.apply([],e)}function Bn(e){const t=e.map(Qe);return[t.map(n=>n[0]),bi(t.map(n=>n[1]))]}const Ln=new WeakMap;function mi(e,t){return Ln.set(e,t),e}function Ei(e){return Object.assign(e,{[In]:!0})}function Qe(e){for(const[t,n]of On)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:r},s]}return[{type:"RAW",value:e},Ln.get(e)||[]]}function me(e){switch(e.type){case"HANDLER":return On.get(e.name).deserialize(e.value);case"RAW":return e.value}}function xe(e,t,n){return new Promise(r=>{const s=vi();e.addEventListener("message",function i(o){!o.data||!o.data.id||o.data.id!==s||(e.removeEventListener("message",i),r(o.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)})}function vi(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class Ai{constructor(){N(this,"_priority");N(this,"_background");N(this,"_current");this._priority=[],this._background=[],this._current=Promise.resolve()}enqueuePriority(t){const n=this._current.then(()=>t());return this._priority.push(n),this._current=n.catch(()=>{}),n}enqueueBackground(t){const n=this._current.then(()=>t());return this._background.push(n),this._current=n.catch(()=>{}),n}clearPriority(){this._priority=[]}clearBackground(){this._background=[]}async process(){for(;this._priority.length>0||this._background.length>0;){const t=this._priority.shift()||this._background.shift();t&&await t}this._current=Promise.resolve()}clear(){this._priority=[],this._background=[],this._current=Promise.resolve()}}const Ee=new Ai;class Ti{constructor(t){N(this,"connected");N(this,"db");N(this,"client");N(this,"eventsMap",new Map);N(this,"maxEvents");N(this,"checkedUsers",[]);N(this,"checkedEvents",[]);N(this,"eventsPublishingQueue",[]);N(this,"followingUserIds",[]);this.connected=!1,this.db=null,this.client=null,this.maxEvents=(t==null?void 0:t.maxEvents)||ai}async init(){this.db=await ii("nostr-client",1,{upgrade(t){t.createObjectStore("users",{keyPath:"user.pubkey"}),t.createObjectStore("following",{keyPath:"user.pubkey"})}})}async connect(t,n){this.client=new Vs(t),(n==null?void 0:n.autoLoadInfo)!==!1&&await this.client.getRelayInformation(),this.client.listen(async r=>{await this.processEvent(r)})}disconnect(){var t,n;(t=this.client)==null||t.unsubscribeAll(),(n=this.client)==null||n.disconnect(),this.eventsMap.clear(),this.connected=!1}getRelays(){var t;return(t=this.client)!=null&&t.relays?this.client.relays.map(n=>n.getInfo("withInfo")):[]}updateRelay(t,n){var r;for(const s of((r=this.client)==null?void 0:r.relays)||[])if(s.id===t){typeof n.isEnabled<"u"&&(s.isEnabled=n.isEnabled),typeof n.read<"u"&&(s.read=n.read),typeof n.write<"u"&&(s.write=n.write);break}}getSubscriptions(){var t;return((t=this.client)==null?void 0:t.getSubscriptions())||[]}updateSubscription(t){var n;(n=this.client)==null||n.updateSubscription(t),postMessage({type:"subscription:update",data:t})}async subscribe(t){var n;return(n=this.client)==null?void 0:n.subscribe(t)}unsubscribe(t){var n;return(n=this.client)==null?void 0:n.unsubscribe(t)}unsubscribeAll(){var t;return console.log("WORKER: UNSUBSCRIBE ALL"),(t=this.client)==null?void 0:t.unsubscribeAll()}addEvent(t){this.eventsMap.set(t.event.id,t),postMessage({type:"event:new",data:t})}updateEvent(t){this.eventsMap.set(t.event.id,t),postMessage({type:"event:update",data:t})}setMaxEvents(t){this.maxEvents=t}addQueueItems(t){this.eventsPublishingQueue.push(...t)}updateQueueItem(t){const n=this.eventsPublishingQueue.findIndex(r=>r.event.id===t.event.id);n!==-1&&(this.eventsPublishingQueue[n]=t,postMessage({type:"event:queue:update",data:t}))}async getUser(t){if(!this.db)throw new Error("DB not initialized");const n=await this.db.get("users",t);return n?{user:new Js(n.user),relayUrls:n.relayUrls}:void 0}async addUser(t){if(!this.db)throw new Error("DB not initialized");const{user:n}=t;await this.db.put("users",{user:n,relayUrls:t.relayUrls})}async updateUser(t){if(!this.db)throw new Error("DB not initialized");const n=await this.db.get("users",t.user.pubkey);await this.db.put("users",{user:t.user?t.user:n.user,relayUrls:t.relayUrls?t.relayUrls:n.relayUrls})}async countUsers(){if(!this.db)throw new Error("DB not initialized");return await this.db.count("users")}count(t){var n;return(n=this.client)==null?void 0:n.count(t)}async processEvent(t){if(!t.data)return;const n=t.data[0];if((n===ee.AUTH||n===ee.OK||n===ee.NOTICE||n===ee.COUNT||n===ee.EOSE)&&Ee.enqueueBackground(async()=>{var r,s,i;if(n===ee.OK){const o=t.data[1],a=t.data[2],c=t.data[3],u=this.eventsPublishingQueue.find(h=>h.event.id===o);u&&(this.updateQueueItem({...u,accepted:a,error:a===!1?c:void 0}),postMessage({type:"relay:message",data:t}));return}else if(n===ee.EOSE){const o=(r=this.client)==null?void 0:r.getSubscriptions(),a=o==null?void 0:o.find(c=>c.id===t.data[1]);a&&this.updateSubscription({...a,eose:!0}),postMessage({type:"relay:message",data:t});return}else if(n===ee.COUNT){const o=(s=this.client)==null?void 0:s.getSubscriptions(),a=o==null?void 0:o.find(c=>c.id===t.data[1]);a&&this.updateSubscription({...a,result:JSON.stringify(t.data[2])});return}else if(n===ee.NOTICE){const o=(i=this.client)==null?void 0:i.getSubscriptions(),a=o==null?void 0:o.find(c=>c.id===t.data[1]);a&&this.updateSubscription({...a,result:t.data[1]}),postMessage({type:"relay:message",data:t});return}}),n===ee.EVENT){const r=t.data[2].kind;r===W.SHORT_TEXT_NOTE||r===W.LONG_FORM_CONTENT?Ee.enqueuePriority(async()=>{const s=t.data[2];if(this.eventsMap.size>=this.maxEvents||(s.id?this.eventsMap.has(s.id):!1)||!s.pubkey)return;const o={event:new he(s),eventRelayUrls:[t.meta.url]},a=await this.getUser(s.pubkey);a&&(o.user=a.user);const c=o.event.hasMentions();if(c)for(const h of c){const f=await this.getUser(h);f?o.mentions?o.mentions.push(f.user):o.mentions=[f.user]:o.mentions?o.mentions.push(new Be({pubkey:h})):o.mentions=[new Be({pubkey:h})]}const u=o.event.hasEventTags();if(u){const h=u.find(f=>f.marker==="root");if(h){const f=h.eventId,b=this.eventsMap.get(f);if(b){b.replies?b.replies.find(A=>A.event.id===o.event.id)||b.replies.push({...o}):b.replies=[{...o}],this.updateEvent(b),console.log(`Reply event added to event ${b.event.id}`);return}}else console.log(`No root tag found for event ${s.id}`)}this.addEvent(o)}):r===W.ZAP_RECEIPT?Ee.enqueueBackground(async()=>{const s=t.data[2];if(!s.pubkey)return;const i=new he(s),o=await this.getUser(i.pubkey),a=i.hasEventTags(),c=a==null?void 0:a.find(u=>u.marker==="root");if(c){const u=this.eventsMap.get(c.eventId);u&&(u.zapReceipt?u.zapReceipt.push({event:i,user:o==null?void 0:o.user}):u.zapReceipt=[{event:i,user:o==null?void 0:o.user}],this.updateEvent(u))}}):r===W.METADATA?Ee.enqueueBackground(async()=>{const s=new Be,i=t.data[2];s.fromEvent(i),await this.getUser(s.pubkey)?(await this.updateUser({user:s,relayUrls:[t.meta.url]}),await this.updateUserFollowing({user:s,relayUrls:[t.meta.url]})):(await this.addUser({user:s,relayUrls:[t.meta.url]}),await this.updateUserFollowing({user:s,relayUrls:[t.meta.url]}));for(const a of this.eventsMap.values())a.event.pubkey===s.pubkey&&(a.user=s,this.updateEvent(a))}):r===W.REACTION?Ee.enqueuePriority(async()=>{const s=new he(t.data[2]),i=s.hasEventTags();if(!i)return;const o=await this.getUser(s.pubkey),a=i.filter(c=>c.eventId).map(c=>c.eventId);for(const c of a){const u=this.eventsMap.get(c);u&&(u.reactions&&u.reactions.length?u.reactions.push({event:s,user:o==null?void 0:o.user}):u.reactions=[{event:s,user:o==null?void 0:o.user}],console.log(`Reaction event added to event ${u.event.id}`),this.updateEvent(u))}}):r===W.REPOST&&Ee.enqueueBackground(async()=>{const s=new he(t.data[2]),i=s.hasEventTags();if(!i){console.log("No response found for repost event");return}const o=await this.getUser(s.pubkey),a=i.filter(c=>c.eventId).map(c=>c.eventId);for(const c of a){const u=this.eventsMap.get(c);u&&(u.reposts?u.reposts.push({event:s,user:o==null?void 0:o.user}):u.reposts=[{event:s,user:o==null?void 0:o.user}],console.log(`Repost event added to event ${u.event.id}`),this.updateEvent(u))}})}}getEventById(t){return this.eventsMap.get(t)}async sendEvent(t){if(!this.client)throw new Error("Client not initialized");const n=this.client.sendEvent(t);if(n){const r=t.event.kind;[W.SHORT_TEXT_NOTE,W.LONG_FORM_CONTENT,W.RECOMMEND_RELAY].includes(r)&&this.addEvent({event:t.event,eventRelayUrls:n.map(i=>i.relayUrl)}),this.addQueueItems(n);for(const i of n)this.updateQueueItem({...i});return n}else throw new Error("Failed to send event")}sendQueueItems(t){if(!this.client)throw new Error("Client not initialized");this.addQueueItems(t);const n=this.client.sendQueueItems(t);if(n){for(const r of n)this.updateQueueItem({...r});return n}else throw new Error("Failed to send event")}clearEvents(){console.log("WORKER: CLEAR EVENTS"),Ee.clearPriority(),this.eventsMap.clear(),this.checkedEvents=[],this.checkedUsers=[]}async followUser({pubkey:t,relayUrls:n}){if(!this.db)throw new Error("DB not initialized");const r=await this.db.get("users",t),s=await this.db.get("following",t);if(r&&!s)this.db.add("following",r);else if(!r&&!s){const i=new Be({pubkey:t});await this.db.put("following",{user:i,relayUrls:n});for(const o of n)await this.requestInformation({source:"users",idsOrKeys:[t],relayUrl:o},{timeout:1e4,timeoutAt:Date.now()+1e4})}this.followingUserIds.push(t)}async unfollowUser(t){if(!this.db)throw new Error("DB not initialized");await this.db.delete("following",t),this.followingUserIds=this.followingUserIds.filter(n=>n!==t)}async followingUser(t){if(!this.db)throw new Error("DB not initialized");return!!await this.db.get("following",t)}async getAllUsersFollowing(){if(!this.db)throw new Error("DB not initialized");const t=await this.db.getAll("following");return this.followingUserIds=t.map(n=>n.pubkey),t}async updateUserFollowing(t){if(!this.db)throw new Error("DB not initialized");const n=await this.db.get("following",t.user.pubkey);n&&await this.db.put("following",{user:t.user,relayUrls:t.relayUrls?t.relayUrls:n.relayUrls})}async requestInformation(t,n){if(t.idsOrKeys.length===0)return;const r=(n==null?void 0:n.timeout)||1e4;let s=[];if(t.source==="events"||t.source==="events:related"){if(s=t.idsOrKeys.filter(o=>!this.checkedEvents.includes(o)),s.length===0)return;this.checkedEvents=[...this.checkedEvents,...s]}else if(t.source==="users"){if(s=t.idsOrKeys.filter(o=>!this.checkedUsers.includes(o)),s.length===0)return;this.checkedUsers=[...this.checkedUsers,...s]}console.log(`=> Getting information for ${s.length} ${t.source}`);const i=[];for(let o=0;o<s.length;o+=25){const a=s.slice(o,o+25);let c;if(t.source==="events")c=new je({kinds:[W.SHORT_TEXT_NOTE,W.LONG_FORM_CONTENT,W.REACTION,W.REPOST,W.ZAP_RECEIPT],ids:a});else if(t.source==="events:related")c=new je({kinds:[W.SHORT_TEXT_NOTE,W.REACTION,W.REPOST],"#e":a});else if(t.source==="users")c=new je({kinds:[W.METADATA],authors:a});else throw new Error("Invalid source");const u=await this.subscribe({type:an.REQ,filters:c,relayUrls:[t.relayUrl],options:n});u&&i.push(...u)}i.length>0&&setTimeout(()=>{this.unsubscribe(i.map(o=>o.id))},r)}async hasSubscriptionForEventIds(t,n){var i;if(!this.client)throw new Error("Client not initialized");const r=(i=this.client)==null?void 0:i.getSubscriptions();if(!r)return;const s=[];if(n)for(const o of t){const a=r.find(c=>{var u,h;return((u=c.filters["#e"])==null?void 0:u.includes(o))&&((h=c.filters.kinds)==null?void 0:h.some(f=>n.includes(f)))});a&&s.push(a.id)}else for(const o of t){const a=r.find(c=>{var u;return(u=c.filters["#e"])==null?void 0:u.includes(o)});a&&s.push(a.id)}return s.length>0?s:void 0}}const xi=new Ti;Tt(xi)})();

(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Ut=Symbol("Comlink.proxy"),Xn=Symbol("Comlink.endpoint"),Kn=Symbol("Comlink.releaseProxy"),Ke=Symbol("Comlink.finalizer"),Le=Symbol("Comlink.thrown"),Lt=e=>typeof e=="object"&&e!==null||typeof e=="function",Yn={canHandle:e=>Lt(e)&&e[Ut],serialize(e){const{port1:t,port2:n}=new MessageChannel;return Ye(e,t),[n,[n]]},deserialize(e){return e.start(),rr(e)}},er={canHandle:e=>Lt(e)&&Le in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},Pt=new Map([["proxy",Yn],["throw",er]]);function tr(e,t){for(const n of e)if(t===n||n==="*"||n instanceof RegExp&&n.test(t))return!0;return!1}function Ye(e,t=globalThis,n=["*"]){t.addEventListener("message",function r(s){if(!s||!s.data)return;if(!tr(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:o,path:c}=Object.assign({path:[]},s.data),a=(s.data.argumentList||[]).map(fe);let u;try{const l=c.slice(0,-1).reduce((g,A)=>g[A],e),d=c.reduce((g,A)=>g[A],e);switch(o){case"GET":u=d;break;case"SET":l[c.slice(-1)[0]]=fe(s.data.value),u=!0;break;case"APPLY":u=d.apply(l,a);break;case"CONSTRUCT":{const g=new d(...a);u=cr(g)}break;case"ENDPOINT":{const{port1:g,port2:A}=new MessageChannel;Ye(e,A),u=ar(g,[g])}break;case"RELEASE":u=void 0;break;default:return}}catch(l){u={value:l,[Le]:0}}Promise.resolve(u).catch(l=>({value:l,[Le]:0})).then(l=>{const[d,g]=$e(l);t.postMessage(Object.assign(Object.assign({},d),{id:i}),g),o==="RELEASE"&&(t.removeEventListener("message",r),_t(t),Ke in e&&typeof e[Ke]=="function"&&e[Ke]())}).catch(l=>{const[d,g]=$e({value:new TypeError("Unserializable return value"),[Le]:0});t.postMessage(Object.assign(Object.assign({},d),{id:i}),g)})}),t.start&&t.start()}function nr(e){return e.constructor.name==="MessagePort"}function _t(e){nr(e)&&e.close()}function rr(e,t){return et(e,[],t)}function Pe(e){if(e)throw new Error("Proxy has been released and is not useable")}function Mt(e){return Ee(e,{type:"RELEASE"}).then(()=>{_t(e)})}const _e=new WeakMap,Me="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(_e.get(e)||0)-1;_e.set(e,t),t===0&&Mt(e)});function sr(e,t){const n=(_e.get(t)||0)+1;_e.set(t,n),Me&&Me.register(e,t,e)}function ir(e){Me&&Me.unregister(e)}function et(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(i,o){if(Pe(r),o===Kn)return()=>{ir(s),Mt(e),r=!0};if(o==="then"){if(t.length===0)return{then:()=>s};const c=Ee(e,{type:"GET",path:t.map(a=>a.toString())}).then(fe);return c.then.bind(c)}return et(e,[...t,o])},set(i,o,c){Pe(r);const[a,u]=$e(c);return Ee(e,{type:"SET",path:[...t,o].map(l=>l.toString()),value:a},u).then(fe)},apply(i,o,c){Pe(r);const a=t[t.length-1];if(a===Xn)return Ee(e,{type:"ENDPOINT"}).then(fe);if(a==="bind")return et(e,t.slice(0,-1));const[u,l]=$t(c);return Ee(e,{type:"APPLY",path:t.map(d=>d.toString()),argumentList:u},l).then(fe)},construct(i,o){Pe(r);const[c,a]=$t(o);return Ee(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:c},a).then(fe)}});return sr(s,e),s}function or(e){return Array.prototype.concat.apply([],e)}function $t(e){const t=e.map($e);return[t.map(n=>n[0]),or(t.map(n=>n[1]))]}const Ht=new WeakMap;function ar(e,t){return Ht.set(e,t),e}function cr(e){return Object.assign(e,{[Ut]:!0})}function $e(e){for(const[t,n]of Pt)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:r},s]}return[{type:"RAW",value:e},Ht.get(e)||[]]}function fe(e){switch(e.type){case"HANDLER":return Pt.get(e.name).deserialize(e.value);case"RAW":return e.value}}function Ee(e,t,n){return new Promise(r=>{const s=ur();e.addEventListener("message",function i(o){!o.data||!o.data.id||o.data.id!==s||(e.removeEventListener("message",i),r(o.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)})}function ur(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var xe={};Object.defineProperty(xe,"__esModule",{value:!0}),xe.bech32m=he=xe.bech32=void 0;const He="qpzry9x8gf2tvdw0s3jn54khce6mua7l",Wt={};for(let e=0;e<He.length;e++){const t=He.charAt(e);Wt[t]=e}function ve(e){const t=e>>25;return(e&33554431)<<5^-(t>>0&1)&996825010^-(t>>1&1)&642813549^-(t>>2&1)&513874426^-(t>>3&1)&1027748829^-(t>>4&1)&705979059}function jt(e){let t=1;for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);if(r<33||r>126)return"Invalid prefix ("+e+")";t=ve(t)^r>>5}t=ve(t);for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);t=ve(t)^r&31}return t}function tt(e,t,n,r){let s=0,i=0;const o=(1<<n)-1,c=[];for(let a=0;a<e.length;++a)for(s=s<<t|e[a],i+=t;i>=n;)i-=n,c.push(s>>i&o);if(r)i>0&&c.push(s<<n-i&o);else{if(i>=t)return"Excess padding";if(s<<n-i&o)return"Non-zero padding"}return c}function lr(e){return tt(e,8,5,!0)}function dr(e){const t=tt(e,5,8,!1);if(Array.isArray(t))return t}function fr(e){const t=tt(e,5,8,!1);if(Array.isArray(t))return t;throw new Error(t)}function Ft(e){let t;e==="bech32"?t=1:t=734539939;function n(o,c,a){if(a=a||90,o.length+7+c.length>a)throw new TypeError("Exceeds length limit");o=o.toLowerCase();let u=jt(o);if(typeof u=="string")throw new Error(u);let l=o+"1";for(let d=0;d<c.length;++d){const g=c[d];if(g>>5)throw new Error("Non 5-bit word");u=ve(u)^g,l+=He.charAt(g)}for(let d=0;d<6;++d)u=ve(u);u^=t;for(let d=0;d<6;++d){const g=u>>(5-d)*5&31;l+=He.charAt(g)}return l}function r(o,c){if(c=c||90,o.length<8)return o+" too short";if(o.length>c)return"Exceeds length limit";const a=o.toLowerCase(),u=o.toUpperCase();if(o!==a&&o!==u)return"Mixed-case string "+o;o=a;const l=o.lastIndexOf("1");if(l===-1)return"No separator character for "+o;if(l===0)return"Missing prefix for "+o;const d=o.slice(0,l),g=o.slice(l+1);if(g.length<6)return"Data too short";let A=jt(d);if(typeof A=="string")return A;const T=[];for(let w=0;w<g.length;++w){const m=g.charAt(w),E=Wt[m];if(E===void 0)return"Unknown character "+m;A=ve(A)^E,!(w+6>=g.length)&&T.push(E)}return A!==t?"Invalid checksum for "+o:{prefix:d,words:T}}function s(o,c){const a=r(o,c);if(typeof a=="object")return a}function i(o,c){const a=r(o,c);if(typeof a=="object")return a;throw new Error(a)}return{decodeUnsafe:s,decode:i,encode:n,toWords:lr,fromWordsUnsafe:dr,fromWords:fr}}var he=xe.bech32=Ft("bech32");xe.bech32m=Ft("bech32m");var Nt={};(function(e){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0;function t(f){if(!Number.isSafeInteger(f))throw new Error(`Wrong integer: ${f}`)}e.assertNumber=t;function n(...f){const y=(h,p)=>v=>h(p(v)),b=Array.from(f).reverse().reduce((h,p)=>h?y(h,p.encode):p.encode,void 0),k=f.reduce((h,p)=>h?y(h,p.decode):p.decode,void 0);return{encode:b,decode:k}}function r(f){return{encode:y=>{if(!Array.isArray(y)||y.length&&typeof y[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return y.map(b=>{if(t(b),b<0||b>=f.length)throw new Error(`Digit index outside alphabet: ${b} (alphabet: ${f.length})`);return f[b]})},decode:y=>{if(!Array.isArray(y)||y.length&&typeof y[0]!="string")throw new Error("alphabet.decode input should be array of strings");return y.map(b=>{if(typeof b!="string")throw new Error(`alphabet.decode: not string element=${b}`);const k=f.indexOf(b);if(k===-1)throw new Error(`Unknown letter: "${b}". Allowed: ${f}`);return k})}}}function s(f=""){if(typeof f!="string")throw new Error("join separator should be string");return{encode:y=>{if(!Array.isArray(y)||y.length&&typeof y[0]!="string")throw new Error("join.encode input should be array of strings");for(let b of y)if(typeof b!="string")throw new Error(`join.encode: non-string input=${b}`);return y.join(f)},decode:y=>{if(typeof y!="string")throw new Error("join.decode input should be string");return y.split(f)}}}function i(f,y="="){if(t(f),typeof y!="string")throw new Error("padding chr should be string");return{encode(b){if(!Array.isArray(b)||b.length&&typeof b[0]!="string")throw new Error("padding.encode input should be array of strings");for(let k of b)if(typeof k!="string")throw new Error(`padding.encode: non-string input=${k}`);for(;b.length*f%8;)b.push(y);return b},decode(b){if(!Array.isArray(b)||b.length&&typeof b[0]!="string")throw new Error("padding.encode input should be array of strings");for(let h of b)if(typeof h!="string")throw new Error(`padding.decode: non-string input=${h}`);let k=b.length;if(k*f%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;k>0&&b[k-1]===y;k--)if(!((k-1)*f%8))throw new Error("Invalid padding: string has too much padding");return b.slice(0,k)}}}function o(f){if(typeof f!="function")throw new Error("normalize fn should be function");return{encode:y=>y,decode:y=>f(y)}}function c(f,y,b){if(y<2)throw new Error(`convertRadix: wrong from=${y}, base cannot be less than 2`);if(b<2)throw new Error(`convertRadix: wrong to=${b}, base cannot be less than 2`);if(!Array.isArray(f))throw new Error("convertRadix: data should be array");if(!f.length)return[];let k=0;const h=[],p=Array.from(f);for(p.forEach(v=>{if(t(v),v<0||v>=y)throw new Error(`Wrong integer: ${v}`)});;){let v=0,_=!0;for(let U=k;U<p.length;U++){const H=p[U],C=y*v+H;if(!Number.isSafeInteger(C)||y*v/y!==v||C-H!==y*v)throw new Error("convertRadix: carry overflow");if(v=C%b,p[U]=Math.floor(C/b),!Number.isSafeInteger(p[U])||p[U]*b+v!==C)throw new Error("convertRadix: carry overflow");if(_)p[U]?_=!1:k=U;else continue}if(h.push(v),_)break}for(let v=0;v<f.length-1&&f[v]===0;v++)h.push(0);return h.reverse()}const a=(f,y)=>y?a(y,f%y):f,u=(f,y)=>f+(y-a(f,y));function l(f,y,b,k){if(!Array.isArray(f))throw new Error("convertRadix2: data should be array");if(y<=0||y>32)throw new Error(`convertRadix2: wrong from=${y}`);if(b<=0||b>32)throw new Error(`convertRadix2: wrong to=${b}`);if(u(y,b)>32)throw new Error(`convertRadix2: carry overflow from=${y} to=${b} carryBits=${u(y,b)}`);let h=0,p=0;const v=2**b-1,_=[];for(const U of f){if(t(U),U>=2**y)throw new Error(`convertRadix2: invalid data word=${U} from=${y}`);if(h=h<<y|U,p+y>32)throw new Error(`convertRadix2: carry overflow pos=${p} from=${y}`);for(p+=y;p>=b;p-=b)_.push((h>>p-b&v)>>>0);h&=2**p-1}if(h=h<<b-p&v,!k&&p>=y)throw new Error("Excess padding");if(!k&&h)throw new Error(`Non-zero padding: ${h}`);return k&&p>0&&_.push(h>>>0),_}function d(f){return t(f),{encode:y=>{if(!(y instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return c(Array.from(y),2**8,f)},decode:y=>{if(!Array.isArray(y)||y.length&&typeof y[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(c(y,f,2**8))}}}function g(f,y=!1){if(t(f),f<=0||f>32)throw new Error("radix2: bits should be in (0..32]");if(u(8,f)>32||u(f,8)>32)throw new Error("radix2: carry overflow");return{encode:b=>{if(!(b instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return l(Array.from(b),8,f,!y)},decode:b=>{if(!Array.isArray(b)||b.length&&typeof b[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(l(b,f,8,y))}}}function A(f){if(typeof f!="function")throw new Error("unsafeWrapper fn should be function");return function(...y){try{return f.apply(null,y)}catch{}}}function T(f,y){if(t(f),typeof y!="function")throw new Error("checksum fn should be function");return{encode(b){if(!(b instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const k=y(b).slice(0,f),h=new Uint8Array(b.length+f);return h.set(b),h.set(k,b.length),h},decode(b){if(!(b instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const k=b.slice(0,-f),h=y(k).slice(0,f),p=b.slice(-f);for(let v=0;v<f;v++)if(h[v]!==p[v])throw new Error("Invalid checksum");return k}}}e.utils={alphabet:r,chain:n,checksum:T,radix:d,radix2:g,join:s,padding:i},e.base16=n(g(4),r("0123456789ABCDEF"),s("")),e.base32=n(g(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),i(5),s("")),e.base32hex=n(g(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),i(5),s("")),e.base32crockford=n(g(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),o(f=>f.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=n(g(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),i(6),s("")),e.base64url=n(g(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),i(6),s(""));const w=f=>n(d(58),r(f),s(""));e.base58=w("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=w("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=w("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const m=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(f){let y="";for(let b=0;b<f.length;b+=8){const k=f.subarray(b,b+8);y+=e.base58.encode(k).padStart(m[k.length],"1")}return y},decode(f){let y=[];for(let b=0;b<f.length;b+=11){const k=f.slice(b,b+11),h=m.indexOf(k.length),p=e.base58.decode(k);for(let v=0;v<p.length-h;v++)if(p[v]!==0)throw new Error("base58xmr: wrong padding");y=y.concat(Array.from(p.slice(p.length-h)))}return Uint8Array.from(y)}};const E=f=>n(T(4,y=>f(f(y))),e.base58);e.base58check=E;const R=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),x=[996825010,642813549,513874426,1027748829,705979059];function S(f){const y=f>>25;let b=(f&33554431)<<5;for(let k=0;k<x.length;k++)(y>>k&1)===1&&(b^=x[k]);return b}function L(f,y,b=1){const k=f.length;let h=1;for(let p=0;p<k;p++){const v=f.charCodeAt(p);if(v<33||v>126)throw new Error(`Invalid prefix (${f})`);h=S(h)^v>>5}h=S(h);for(let p=0;p<k;p++)h=S(h)^f.charCodeAt(p)&31;for(let p of y)h=S(h)^p;for(let p=0;p<6;p++)h=S(h);return h^=b,R.encode(l([h%2**30],30,5,!1))}function I(f){const y=f==="bech32"?1:734539939,b=g(5),k=b.decode,h=b.encode,p=A(k);function v(C,M,F=90){if(typeof C!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof C}`);if(!Array.isArray(M)||M.length&&typeof M[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof M}`);const q=C.length+7+M.length;if(F!==!1&&q>F)throw new TypeError(`Length ${q} exceeds limit ${F}`);return C=C.toLowerCase(),`${C}1${R.encode(M)}${L(C,M,y)}`}function _(C,M=90){if(typeof C!="string")throw new Error(`bech32.decode input should be string, not ${typeof C}`);if(C.length<8||M!==!1&&C.length>M)throw new TypeError(`Wrong string length: ${C.length} (${C}). Expected (8..${M})`);const F=C.toLowerCase();if(C!==F&&C!==C.toUpperCase())throw new Error("String must be lowercase or uppercase");C=F;const q=C.lastIndexOf("1");if(q===0||q===-1)throw new Error('Letter "1" must be present between prefix and data only');const re=C.slice(0,q),se=C.slice(q+1);if(se.length<6)throw new Error("Data must be at least 6 characters long");const X=R.decode(se).slice(0,-6),Se=L(re,X,y);if(!se.endsWith(Se))throw new Error(`Invalid checksum in ${C}: expected "${Se}"`);return{prefix:re,words:X}}const U=A(_);function H(C){const{prefix:M,words:F}=_(C,!1);return{prefix:M,words:F,bytes:k(F)}}return{encode:v,decode:_,decodeToBytes:H,decodeUnsafe:U,fromWords:k,fromWordsUnsafe:p,toWords:h}}e.bech32=I("bech32"),e.bech32m=I("bech32m"),e.utf8={encode:f=>new TextDecoder().decode(f),decode:f=>new TextEncoder().encode(f)},e.hex=n(g(4),r("0123456789abcdef"),s(""),o(f=>{if(typeof f!="string"||f.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof f} with length ${f.length}`);return f.toLowerCase()}));const O={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},P=`Invalid encoding type. Available types: ${Object.keys(O).join(", ")}`,G=(f,y)=>{if(typeof f!="string"||!O.hasOwnProperty(f))throw new TypeError(P);if(!(y instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return O[f].encode(y)};e.bytesToString=G,e.str=e.bytesToString;const $=(f,y)=>{if(!O.hasOwnProperty(f))throw new TypeError(P);if(typeof y!="string")throw new TypeError("stringToBytes() expects string");return O[f].decode(y)};e.stringToBytes=$,e.bytes=e.stringToBytes})(Nt);const{bech32:Y,hex:V,utf8:hr}=Nt,Dt={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},zt={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},qt={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},Zt={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},We=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],gr={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},yr=BigInt("2100000000000000000"),Gt=BigInt(1e11),nt={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},Qt={};for(let e=0,t=Object.keys(nt);e<t.length;e++){const n=t[e],r=nt[t[e]].toString();Qt[r]=n}const pr={1:e=>V.encode(Y.fromWordsUnsafe(e)),16:e=>V.encode(Y.fromWordsUnsafe(e)),13:e=>hr.encode(Y.fromWordsUnsafe(e)),19:e=>V.encode(Y.fromWordsUnsafe(e)),23:e=>V.encode(Y.fromWordsUnsafe(e)),27:e=>V.encode(Y.fromWordsUnsafe(e)),6:je,24:je,3:br,5:mr};function wr(e){return t=>({tagCode:parseInt(e),words:Y.encode("unknown",t,Number.MAX_SAFE_INTEGER)})}function je(e){return e.reverse().reduce((t,n,r)=>t+n*Math.pow(32,r),0)}function br(e){const t=[];let n,r,s,i,o,c=Y.fromWordsUnsafe(e);for(;c.length>0;)n=V.encode(c.slice(0,33)),r=V.encode(c.slice(33,41)),s=parseInt(V.encode(c.slice(41,45)),16),i=parseInt(V.encode(c.slice(45,49)),16),o=parseInt(V.encode(c.slice(49,51)),16),c=c.slice(51),t.push({pubkey:n,short_channel_id:r,fee_base_msat:s,fee_proportional_millionths:i,cltv_expiry_delta:o});return t}function mr(e){const t=e.slice().reverse().map(s=>[!!(s&1),!!(s&2),!!(s&4),!!(s&8),!!(s&16)]).reduce((s,i)=>s.concat(i),[]);for(;t.length<We.length*2;)t.push(!1);const n={};We.forEach((s,i)=>{let o;t[i*2]?o="required":t[i*2+1]?o="supported":o="unsupported",n[s]=o});const r=t.slice(We.length*2);return n.extra_bits={start_bit:We.length*2,bits:r,has_required:r.reduce((s,i,o)=>o%2!==0?s||!1:s||i,!1)},n}function Jt(e,t){let n,r;if(e.slice(-1).match(/^[munp]$/))n=e.slice(-1),r=e.slice(0,-1);else{if(e.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");r=e}if(!r.match(/^\d+$/))throw new Error("Not a valid human readable amount");const s=BigInt(r),i=n?s*Gt/gr[n]:s*Gt;if(n==="p"&&s%BigInt(10)!==BigInt(0)||i>yr)throw new Error("Amount is outside of valid range");return t?i.toString():i}function Er(e,t){if(typeof e!="string")throw new Error("Lightning Payment Request must be string");if(e.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");const n=[],r=Y.decode(e,Number.MAX_SAFE_INTEGER);e=e.toLowerCase();const s=r.prefix;let i=r.words,o=e.slice(s.length+1),c=i.slice(-104);i=i.slice(0,-104);let a=s.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(a&&!a[2]&&(a=s.match(/^ln(\S+)$/)),!a)throw new Error("Not a proper lightning payment request");n.push({name:"lightning_network",letters:"ln"});const u=a[1];let l;if(t){if(t.bech32===void 0||t.pubKeyHash===void 0||t.scriptHash===void 0||!Array.isArray(t.validWitnessVersions))throw new Error("Invalid network");l=t}else switch(u){case Dt.bech32:l=Dt;break;case zt.bech32:l=zt;break;case qt.bech32:l=qt;break;case Zt.bech32:l=Zt;break}if(!l||l.bech32!==u)throw new Error("Unknown coin bech32 prefix");n.push({name:"coin_network",letters:u,value:l});const d=a[2];let g;if(d){const S=a[3];g=Jt(d+S,!0),n.push({name:"amount",letters:a[2]+a[3],value:g})}else g=null;n.push({name:"separator",letters:"1"});const A=je(i.slice(0,7));i=i.slice(7),n.push({name:"timestamp",letters:o.slice(0,7),value:A}),o=o.slice(7);let T,w,m,E;for(;i.length>0;){const S=i[0].toString();T=Qt[S]||"unknown_tag",w=pr[S]||wr(S),i=i.slice(1),m=je(i.slice(0,2)),i=i.slice(2),E=i.slice(0,m),i=i.slice(m),n.push({name:T,tag:o[0],letters:o.slice(0,1+2+m),value:w(E)}),o=o.slice(1+2+m)}n.push({name:"signature",letters:o.slice(0,104),value:V.encode(Y.fromWordsUnsafe(c))}),o=o.slice(104),n.push({name:"checksum",letters:o});let R={paymentRequest:e,sections:n,get expiry(){let S=n.find(L=>L.name==="expiry");if(S)return x("timestamp")+S.value},get route_hints(){return n.filter(S=>S.name==="route_hint").map(S=>S.value)}};for(let S in nt)S!=="route_hint"&&Object.defineProperty(R,S,{get(){return x(S)}});return R;function x(S){let L=n.find(I=>I.name===S);return L?L.value:void 0}}var vr={decode:Er,hrpToMillisat:Jt};function rt(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function Ar(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}function Vt(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function Tr(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");rt(e.outputLen),rt(e.blockLen)}function Sr(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Ir(e,t){Vt(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const ge={number:rt,bool:Ar,bytes:Vt,hash:Tr,exists:Sr,output:Ir},st=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Xt=e=>e instanceof Uint8Array,it=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),ee=(e,t)=>e<<32-t|e>>>t;if(!(new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68))throw new Error("Non little-endian hardware is not supported");Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function kr(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function ot(e){if(typeof e=="string"&&(e=kr(e)),!Xt(e))throw new Error(`expected Uint8Array, got ${typeof e}`);return e}function Rr(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!Xt(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}class Kt{clone(){return this._cloneInto()}}function Yt(e){const t=r=>e().update(ot(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function en(e=32){if(st&&typeof st.getRandomValues=="function")return st.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}function xr(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(n>>s&i),c=Number(n&i),a=r?4:0,u=r?0:4;e.setUint32(t+a,o,r),e.setUint32(t+u,c,r)}class Or extends Kt{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=it(this.buffer)}update(t){ge.exists(this);const{view:n,buffer:r,blockLen:s}=this;t=ot(t);const i=t.length;for(let o=0;o<i;){const c=Math.min(s-this.pos,i-o);if(c===s){const a=it(t);for(;s<=i-o;o+=s)this.process(a,o);continue}r.set(t.subarray(o,o+c),this.pos),this.pos+=c,o+=c,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){ge.exists(this),ge.output(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;n[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let d=o;d<s;d++)n[d]=0;xr(r,s-8,BigInt(this.length*8),i),this.process(r,0);const c=it(t),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=a/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)c.setUint32(4*d,l[d],i)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:i,destroyed:o,pos:c}=this;return t.length=s,t.pos=c,t.finished=i,t.destroyed=o,s%n&&t.buffer.set(r),t}}const Cr=(e,t,n)=>e&t^~e&n,Br=(e,t,n)=>e&t^e&n^t&n,Ur=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ie=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),oe=new Uint32Array(64);class tn extends Or{constructor(){super(64,32,8,!1),this.A=ie[0]|0,this.B=ie[1]|0,this.C=ie[2]|0,this.D=ie[3]|0,this.E=ie[4]|0,this.F=ie[5]|0,this.G=ie[6]|0,this.H=ie[7]|0}get(){const{A:t,B:n,C:r,D:s,E:i,F:o,G:c,H:a}=this;return[t,n,r,s,i,o,c,a]}set(t,n,r,s,i,o,c,a){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=c|0,this.H=a|0}process(t,n){for(let d=0;d<16;d++,n+=4)oe[d]=t.getUint32(n,!1);for(let d=16;d<64;d++){const g=oe[d-15],A=oe[d-2],T=ee(g,7)^ee(g,18)^g>>>3,w=ee(A,17)^ee(A,19)^A>>>10;oe[d]=w+oe[d-7]+T+oe[d-16]|0}let{A:r,B:s,C:i,D:o,E:c,F:a,G:u,H:l}=this;for(let d=0;d<64;d++){const g=ee(c,6)^ee(c,11)^ee(c,25),A=l+g+Cr(c,a,u)+Ur[d]+oe[d]|0,w=(ee(r,2)^ee(r,13)^ee(r,22))+Br(r,s,i)|0;l=u,u=a,a=c,c=o+A|0,o=i,i=s,s=r,r=A+w|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,c=c+this.E|0,a=a+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(r,s,i,o,c,a,u,l)}roundClean(){oe.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class Lr extends tn{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const Fe=Yt(()=>new tn);Yt(()=>new Lr);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const nn=BigInt(0),Ne=BigInt(1),Pr=BigInt(2),De=e=>e instanceof Uint8Array,_r=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function ae(e){if(!De(e))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=_r[e[n]];return t}function rn(e){const t=e.toString(16);return t.length&1?`0${t}`:t}function at(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return BigInt(e===""?"0":`0x${e}`)}function Ae(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let r=0;r<n.length;r++){const s=r*2,i=e.slice(s,s+2),o=Number.parseInt(i,16);if(Number.isNaN(o)||o<0)throw new Error("Invalid byte sequence");n[r]=o}return n}function Z(e){return at(ae(e))}function ct(e){if(!De(e))throw new Error("Uint8Array expected");return at(ae(Uint8Array.from(e).reverse()))}function ce(e,t){return Ae(e.toString(16).padStart(t*2,"0"))}function sn(e,t){return ce(e,t).reverse()}function Mr(e){return Ae(rn(e))}function N(e,t,n){let r;if(typeof t=="string")try{r=Ae(t)}catch(i){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${i}`)}else if(De(t))r=Uint8Array.from(t);else throw new Error(`${e} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function ye(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!De(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}function $r(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function Hr(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function Wr(e){let t;for(t=0;e>nn;e>>=Ne,t+=1);return t}function jr(e,t){return e>>BigInt(t)&Ne}const Fr=(e,t,n)=>e|(n?Ne:nn)<<BigInt(t),ut=e=>(Pr<<BigInt(e-1))-Ne,lt=e=>new Uint8Array(e),on=e=>Uint8Array.from(e);function an(e,t,n){if(typeof e!="number"||e<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=lt(e),s=lt(e),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},c=(...d)=>n(s,r,...d),a=(d=lt())=>{s=c(on([0]),d),r=c(),d.length!==0&&(s=c(on([1]),d),r=c())},u=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const g=[];for(;d<t;){r=c();const A=r.slice();g.push(A),d+=r.length}return ye(...g)};return(d,g)=>{o(),a(d);let A;for(;!(A=g(u()));)a();return o(),A}}const Nr={bigint:e=>typeof e=="bigint",function:e=>typeof e=="function",boolean:e=>typeof e=="boolean",string:e=>typeof e=="string",isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>typeof e=="function"&&Number.isSafeInteger(e.outputLen)};function Oe(e,t,n={}){const r=(s,i,o)=>{const c=Nr[i];if(typeof c!="function")throw new Error(`Invalid validator "${i}", expected function`);const a=e[s];if(!(o&&a===void 0)&&!c(a,e))throw new Error(`Invalid param ${String(s)}=${a} (${typeof a}), expected ${i}`)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(n))r(s,i,!0);return e}var Dr=Object.freeze({__proto__:null,bitGet:jr,bitLen:Wr,bitMask:ut,bitSet:Fr,bytesToHex:ae,bytesToNumberBE:Z,bytesToNumberLE:ct,concatBytes:ye,createHmacDrbg:an,ensureBytes:N,equalBytes:$r,hexToBytes:Ae,hexToNumber:at,numberToBytesBE:ce,numberToBytesLE:sn,numberToHexUnpadded:rn,numberToVarBytesBE:Mr,utf8ToBytes:Hr,validateObject:Oe});/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const j=BigInt(0),W=BigInt(1),pe=BigInt(2),zr=BigInt(3),dt=BigInt(4),cn=BigInt(5),un=BigInt(8);BigInt(9),BigInt(16);function D(e,t){const n=e%t;return n>=j?n:t+n}function qr(e,t,n){if(n<=j||t<j)throw new Error("Expected power/modulo > 0");if(n===W)return j;let r=W;for(;t>j;)t&W&&(r=r*e%n),e=e*e%n,t>>=W;return r}function Q(e,t,n){let r=e;for(;t-- >j;)r*=r,r%=n;return r}function ft(e,t){if(e===j||t<=j)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=D(e,t),r=t,s=j,i=W;for(;n!==j;){const c=r/n,a=r%n,u=s-i*c;r=n,n=a,s=i,i=u}if(r!==W)throw new Error("invert: does not exist");return D(s,t)}function Zr(e){const t=(e-W)/pe;let n,r,s;for(n=e-W,r=0;n%pe===j;n/=pe,r++);for(s=pe;s<e&&qr(s,t,e)!==e-W;s++);if(r===1){const o=(e+W)/dt;return function(a,u){const l=a.pow(u,o);if(!a.eql(a.sqr(l),u))throw new Error("Cannot find square root");return l}}const i=(n+W)/pe;return function(c,a){if(c.pow(a,t)===c.neg(c.ONE))throw new Error("Cannot find square root");let u=r,l=c.pow(c.mul(c.ONE,s),n),d=c.pow(a,i),g=c.pow(a,n);for(;!c.eql(g,c.ONE);){if(c.eql(g,c.ZERO))return c.ZERO;let A=1;for(let w=c.sqr(g);A<u&&!c.eql(w,c.ONE);A++)w=c.sqr(w);const T=c.pow(l,W<<BigInt(u-A-1));l=c.sqr(T),d=c.mul(d,T),g=c.mul(g,l),u=A}return d}}function Gr(e){if(e%dt===zr){const t=(e+W)/dt;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(e%un===cn){const t=(e-cn)/un;return function(r,s){const i=r.mul(s,pe),o=r.pow(i,t),c=r.mul(s,o),a=r.mul(r.mul(c,pe),o),u=r.mul(c,r.sub(a,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return Zr(e)}const Qr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Jr(e){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=Qr.reduce((r,s)=>(r[s]="function",r),t);return Oe(e,n)}function Vr(e,t,n){if(n<j)throw new Error("Expected power > 0");if(n===j)return e.ONE;if(n===W)return t;let r=e.ONE,s=t;for(;n>j;)n&W&&(r=e.mul(r,s)),s=e.sqr(s),n>>=W;return r}function Xr(e,t){const n=new Array(t.length),r=t.reduce((i,o,c)=>e.is0(o)?i:(n[c]=i,e.mul(i,o)),e.ONE),s=e.inv(r);return t.reduceRight((i,o,c)=>e.is0(o)?i:(n[c]=e.mul(i,n[c]),e.mul(i,o)),s),n}function ht(e,t){const n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Kr(e,t,n=!1,r={}){if(e<=j)throw new Error(`Expected Fp ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:i}=ht(e,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=Gr(e),c=Object.freeze({ORDER:e,BITS:s,BYTES:i,MASK:ut(s),ZERO:j,ONE:W,create:a=>D(a,e),isValid:a=>{if(typeof a!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof a}`);return j<=a&&a<e},is0:a=>a===j,isOdd:a=>(a&W)===W,neg:a=>D(-a,e),eql:(a,u)=>a===u,sqr:a=>D(a*a,e),add:(a,u)=>D(a+u,e),sub:(a,u)=>D(a-u,e),mul:(a,u)=>D(a*u,e),pow:(a,u)=>Vr(c,a,u),div:(a,u)=>D(a*ft(u,e),e),sqrN:a=>a*a,addN:(a,u)=>a+u,subN:(a,u)=>a-u,mulN:(a,u)=>a*u,inv:a=>ft(a,e),sqrt:r.sqrt||(a=>o(c,a)),invertBatch:a=>Xr(c,a),cmov:(a,u,l)=>l?u:a,toBytes:a=>n?sn(a,i):ce(a,i),fromBytes:a=>{if(a.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${a.length}`);return n?ct(a):Z(a)}});return Object.freeze(c)}function Yr(e,t,n=!1){e=N("privateHash",e);const r=e.length,s=ht(t).nByteLength+8;if(s<24||r<s||r>1024)throw new Error(`hashToPrivateScalar: expected ${s}-1024 bytes of input, got ${r}`);const i=n?ct(e):Z(e);return D(i,t-W)+W}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const es=BigInt(0),gt=BigInt(1);function ts(e,t){const n=(s,i)=>{const o=i.negate();return s?o:i},r=s=>{const i=Math.ceil(t/s)+1,o=2**(s-1);return{windows:i,windowSize:o}};return{constTimeNegate:n,unsafeLadder(s,i){let o=e.ZERO,c=s;for(;i>es;)i&gt&&(o=o.add(c)),c=c.double(),i>>=gt;return o},precomputeWindow(s,i){const{windows:o,windowSize:c}=r(i),a=[];let u=s,l=u;for(let d=0;d<o;d++){l=u,a.push(l);for(let g=1;g<c;g++)l=l.add(u),a.push(l);u=l.double()}return a},wNAF(s,i,o){const{windows:c,windowSize:a}=r(s);let u=e.ZERO,l=e.BASE;const d=BigInt(2**s-1),g=2**s,A=BigInt(s);for(let T=0;T<c;T++){const w=T*a;let m=Number(o&d);o>>=A,m>a&&(m-=g,o+=gt);const E=w,R=w+Math.abs(m)-1,x=T%2!==0,S=m<0;m===0?l=l.add(n(x,i[E])):u=u.add(n(S,i[R]))}return{p:u,f:l}},wNAFCached(s,i,o,c){const a=s._WINDOW_SIZE||1;let u=i.get(s);return u||(u=this.precomputeWindow(s,a),a!==1&&i.set(s,c(u))),this.wNAF(a,u,o)}}}function ln(e){return Jr(e.Fp),Oe(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...ht(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ns(e){const t=ln(e);Oe(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:rs,hexToBytes:ss}=Dr,we={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(e){const{Err:t}=we;if(e.length<2||e[0]!==2)throw new t("Invalid signature integer tag");const n=e[1],r=e.subarray(2,n+2);if(!n||r.length!==n)throw new t("Invalid signature integer: wrong length");if(r[0]&128)throw new t("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return{d:rs(r),l:e.subarray(n+2)}},toSig(e){const{Err:t}=we,n=typeof e=="string"?ss(e):e;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new t("Invalid signature tag");if(n[1]!==r-2)throw new t("Invalid signature: incorrect length");const{d:s,l:i}=we._parseInt(n.subarray(2)),{d:o,l:c}=we._parseInt(i);if(c.length)throw new t("Invalid signature: left bytes after parsing");return{r:s,s:o}},hexFromSig(e){const t=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const l=u.toString(16);return l.length&1?`0${l}`:l},r=t(n(e.s)),s=t(n(e.r)),i=r.length/2,o=s.length/2,c=n(i),a=n(o);return`30${n(o+i+4)}02${a}${s}02${c}${r}`}},ne=BigInt(0),J=BigInt(1);BigInt(2);const dn=BigInt(3);BigInt(4);function is(e){const t=ns(e),{Fp:n}=t,r=t.toBytes||((T,w,m)=>{const E=w.toAffine();return ye(Uint8Array.from([4]),n.toBytes(E.x),n.toBytes(E.y))}),s=t.fromBytes||(T=>{const w=T.subarray(1),m=n.fromBytes(w.subarray(0,n.BYTES)),E=n.fromBytes(w.subarray(n.BYTES,2*n.BYTES));return{x:m,y:E}});function i(T){const{a:w,b:m}=t,E=n.sqr(T),R=n.mul(E,T);return n.add(n.add(R,n.mul(T,w)),m)}if(!n.eql(n.sqr(t.Gy),i(t.Gx)))throw new Error("bad generator point: equation left != right");function o(T){return typeof T=="bigint"&&ne<T&&T<t.n}function c(T){if(!o(T))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function a(T){const{allowedPrivateKeyLengths:w,nByteLength:m,wrapPrivateKey:E,n:R}=t;if(w&&typeof T!="bigint"){if(T instanceof Uint8Array&&(T=ae(T)),typeof T!="string"||!w.includes(T.length))throw new Error("Invalid key");T=T.padStart(m*2,"0")}let x;try{x=typeof T=="bigint"?T:Z(N("private key",T,m))}catch{throw new Error(`private key must be ${m} bytes, hex or bigint, not ${typeof T}`)}return E&&(x=D(x,R)),c(x),x}const u=new Map;function l(T){if(!(T instanceof d))throw new Error("ProjectivePoint expected")}class d{constructor(w,m,E){if(this.px=w,this.py=m,this.pz=E,w==null||!n.isValid(w))throw new Error("x required");if(m==null||!n.isValid(m))throw new Error("y required");if(E==null||!n.isValid(E))throw new Error("z required")}static fromAffine(w){const{x:m,y:E}=w||{};if(!w||!n.isValid(m)||!n.isValid(E))throw new Error("invalid affine point");if(w instanceof d)throw new Error("projective point not allowed");const R=x=>n.eql(x,n.ZERO);return R(m)&&R(E)?d.ZERO:new d(m,E,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(w){const m=n.invertBatch(w.map(E=>E.pz));return w.map((E,R)=>E.toAffine(m[R])).map(d.fromAffine)}static fromHex(w){const m=d.fromAffine(s(N("pointHex",w)));return m.assertValidity(),m}static fromPrivateKey(w){return d.BASE.multiply(a(w))}_setWindowSize(w){this._WINDOW_SIZE=w,u.delete(this)}assertValidity(){if(this.is0()){if(t.allowInfinityPoint)return;throw new Error("bad point: ZERO")}const{x:w,y:m}=this.toAffine();if(!n.isValid(w)||!n.isValid(m))throw new Error("bad point: x or y not FE");const E=n.sqr(m),R=i(w);if(!n.eql(E,R))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:w}=this.toAffine();if(n.isOdd)return!n.isOdd(w);throw new Error("Field doesn't support isOdd")}equals(w){l(w);const{px:m,py:E,pz:R}=this,{px:x,py:S,pz:L}=w,I=n.eql(n.mul(m,L),n.mul(x,R)),O=n.eql(n.mul(E,L),n.mul(S,R));return I&&O}negate(){return new d(this.px,n.neg(this.py),this.pz)}double(){const{a:w,b:m}=t,E=n.mul(m,dn),{px:R,py:x,pz:S}=this;let L=n.ZERO,I=n.ZERO,O=n.ZERO,P=n.mul(R,R),G=n.mul(x,x),$=n.mul(S,S),f=n.mul(R,x);return f=n.add(f,f),O=n.mul(R,S),O=n.add(O,O),L=n.mul(w,O),I=n.mul(E,$),I=n.add(L,I),L=n.sub(G,I),I=n.add(G,I),I=n.mul(L,I),L=n.mul(f,L),O=n.mul(E,O),$=n.mul(w,$),f=n.sub(P,$),f=n.mul(w,f),f=n.add(f,O),O=n.add(P,P),P=n.add(O,P),P=n.add(P,$),P=n.mul(P,f),I=n.add(I,P),$=n.mul(x,S),$=n.add($,$),P=n.mul($,f),L=n.sub(L,P),O=n.mul($,G),O=n.add(O,O),O=n.add(O,O),new d(L,I,O)}add(w){l(w);const{px:m,py:E,pz:R}=this,{px:x,py:S,pz:L}=w;let I=n.ZERO,O=n.ZERO,P=n.ZERO;const G=t.a,$=n.mul(t.b,dn);let f=n.mul(m,x),y=n.mul(E,S),b=n.mul(R,L),k=n.add(m,E),h=n.add(x,S);k=n.mul(k,h),h=n.add(f,y),k=n.sub(k,h),h=n.add(m,R);let p=n.add(x,L);return h=n.mul(h,p),p=n.add(f,b),h=n.sub(h,p),p=n.add(E,R),I=n.add(S,L),p=n.mul(p,I),I=n.add(y,b),p=n.sub(p,I),P=n.mul(G,h),I=n.mul($,b),P=n.add(I,P),I=n.sub(y,P),P=n.add(y,P),O=n.mul(I,P),y=n.add(f,f),y=n.add(y,f),b=n.mul(G,b),h=n.mul($,h),y=n.add(y,b),b=n.sub(f,b),b=n.mul(G,b),h=n.add(h,b),f=n.mul(y,h),O=n.add(O,f),f=n.mul(p,h),I=n.mul(k,I),I=n.sub(I,f),f=n.mul(k,y),P=n.mul(p,P),P=n.add(P,f),new d(I,O,P)}subtract(w){return this.add(w.negate())}is0(){return this.equals(d.ZERO)}wNAF(w){return A.wNAFCached(this,u,w,m=>{const E=n.invertBatch(m.map(R=>R.pz));return m.map((R,x)=>R.toAffine(E[x])).map(d.fromAffine)})}multiplyUnsafe(w){const m=d.ZERO;if(w===ne)return m;if(c(w),w===J)return this;const{endo:E}=t;if(!E)return A.unsafeLadder(this,w);let{k1neg:R,k1:x,k2neg:S,k2:L}=E.splitScalar(w),I=m,O=m,P=this;for(;x>ne||L>ne;)x&J&&(I=I.add(P)),L&J&&(O=O.add(P)),P=P.double(),x>>=J,L>>=J;return R&&(I=I.negate()),S&&(O=O.negate()),O=new d(n.mul(O.px,E.beta),O.py,O.pz),I.add(O)}multiply(w){c(w);let m=w,E,R;const{endo:x}=t;if(x){const{k1neg:S,k1:L,k2neg:I,k2:O}=x.splitScalar(m);let{p:P,f:G}=this.wNAF(L),{p:$,f}=this.wNAF(O);P=A.constTimeNegate(S,P),$=A.constTimeNegate(I,$),$=new d(n.mul($.px,x.beta),$.py,$.pz),E=P.add($),R=G.add(f)}else{const{p:S,f:L}=this.wNAF(m);E=S,R=L}return d.normalizeZ([E,R])[0]}multiplyAndAddUnsafe(w,m,E){const R=d.BASE,x=(L,I)=>I===ne||I===J||!L.equals(R)?L.multiplyUnsafe(I):L.multiply(I),S=x(this,m).add(x(w,E));return S.is0()?void 0:S}toAffine(w){const{px:m,py:E,pz:R}=this,x=this.is0();w==null&&(w=x?n.ONE:n.inv(R));const S=n.mul(m,w),L=n.mul(E,w),I=n.mul(R,w);if(x)return{x:n.ZERO,y:n.ZERO};if(!n.eql(I,n.ONE))throw new Error("invZ was invalid");return{x:S,y:L}}isTorsionFree(){const{h:w,isTorsionFree:m}=t;if(w===J)return!0;if(m)return m(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:w,clearCofactor:m}=t;return w===J?this:m?m(d,this):this.multiplyUnsafe(t.h)}toRawBytes(w=!0){return this.assertValidity(),r(d,this,w)}toHex(w=!0){return ae(this.toRawBytes(w))}}d.BASE=new d(t.Gx,t.Gy,n.ONE),d.ZERO=new d(n.ZERO,n.ONE,n.ZERO);const g=t.nBitLength,A=ts(d,t.endo?Math.ceil(g/2):g);return{CURVE:t,ProjectivePoint:d,normPrivateKeyToScalar:a,weierstrassEquation:i,isWithinCurveOrder:o}}function os(e){const t=ln(e);return Oe(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function as(e){const t=os(e),{Fp:n,n:r}=t,s=n.BYTES+1,i=2*n.BYTES+1;function o(h){return ne<h&&h<n.ORDER}function c(h){return D(h,r)}function a(h){return ft(h,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:l,weierstrassEquation:d,isWithinCurveOrder:g}=is({...t,toBytes(h,p,v){const _=p.toAffine(),U=n.toBytes(_.x),H=ye;return v?H(Uint8Array.from([p.hasEvenY()?2:3]),U):H(Uint8Array.from([4]),U,n.toBytes(_.y))},fromBytes(h){const p=h.length,v=h[0],_=h.subarray(1);if(p===s&&(v===2||v===3)){const U=Z(_);if(!o(U))throw new Error("Point is not on curve");const H=d(U);let C=n.sqrt(H);const M=(C&J)===J;return(v&1)===1!==M&&(C=n.neg(C)),{x:U,y:C}}else if(p===i&&v===4){const U=n.fromBytes(_.subarray(0,n.BYTES)),H=n.fromBytes(_.subarray(n.BYTES,2*n.BYTES));return{x:U,y:H}}else throw new Error(`Point of length ${p} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),A=h=>ae(ce(h,t.nByteLength));function T(h){const p=r>>J;return h>p}function w(h){return T(h)?c(-h):h}const m=(h,p,v)=>Z(h.slice(p,v));class E{constructor(p,v,_){this.r=p,this.s=v,this.recovery=_,this.assertValidity()}static fromCompact(p){const v=t.nByteLength;return p=N("compactSignature",p,v*2),new E(m(p,0,v),m(p,v,2*v))}static fromDER(p){const{r:v,s:_}=we.toSig(N("DER",p));return new E(v,_)}assertValidity(){if(!g(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!g(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(p){return new E(this.r,this.s,p)}recoverPublicKey(p){const{r:v,s:_,recovery:U}=this,H=O(N("msgHash",p));if(U==null||![0,1,2,3].includes(U))throw new Error("recovery id invalid");const C=U===2||U===3?v+t.n:v;if(C>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const M=U&1?"03":"02",F=u.fromHex(M+A(C)),q=a(C),re=c(-H*q),se=c(_*q),X=u.BASE.multiplyAndAddUnsafe(F,re,se);if(!X)throw new Error("point at infinify");return X.assertValidity(),X}hasHighS(){return T(this.s)}normalizeS(){return this.hasHighS()?new E(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return Ae(this.toDERHex())}toDERHex(){return we.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Ae(this.toCompactHex())}toCompactHex(){return A(this.r)+A(this.s)}}const R={isValidPrivateKey(h){try{return l(h),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const h=t.randomBytes(n.BYTES+8),p=Yr(h,r);return ce(p,t.nByteLength)},precompute(h=8,p=u.BASE){return p._setWindowSize(h),p.multiply(BigInt(3)),p}};function x(h,p=!0){return u.fromPrivateKey(h).toRawBytes(p)}function S(h){const p=h instanceof Uint8Array,v=typeof h=="string",_=(p||v)&&h.length;return p?_===s||_===i:v?_===2*s||_===2*i:h instanceof u}function L(h,p,v=!0){if(S(h))throw new Error("first arg must be private key");if(!S(p))throw new Error("second arg must be public key");return u.fromHex(p).multiply(l(h)).toRawBytes(v)}const I=t.bits2int||function(h){const p=Z(h),v=h.length*8-t.nBitLength;return v>0?p>>BigInt(v):p},O=t.bits2int_modN||function(h){return c(I(h))},P=ut(t.nBitLength);function G(h){if(typeof h!="bigint")throw new Error("bigint expected");if(!(ne<=h&&h<P))throw new Error(`bigint expected < 2^${t.nBitLength}`);return ce(h,t.nByteLength)}function $(h,p,v=f){if(["recovered","canonical"].some(me=>me in v))throw new Error("sign() legacy options not supported");const{hash:_,randomBytes:U}=t;let{lowS:H,prehash:C,extraEntropy:M}=v;H==null&&(H=!0),h=N("msgHash",h),C&&(h=N("prehashed msgHash",_(h)));const F=O(h),q=l(p),re=[G(q),G(F)];if(M!=null){const me=M===!0?U(n.BYTES):M;re.push(N("extraEntropy",me,n.BYTES))}const se=ye(...re),X=F;function Se(me){const Ie=I(me);if(!g(Ie))return;const Qn=a(Ie),ke=u.BASE.multiply(Ie).toAffine(),K=c(ke.x);if(K===ne)return;const Re=c(Qn*c(X+K*q));if(Re===ne)return;let Jn=(ke.x===K?0:2)|Number(ke.y&J),Vn=Re;return H&&T(Re)&&(Vn=w(Re),Jn^=1),new E(K,Vn,Jn)}return{seed:se,k2sig:Se}}const f={lowS:t.lowS,prehash:!1},y={lowS:t.lowS,prehash:!1};function b(h,p,v=f){const{seed:_,k2sig:U}=$(h,p,v),H=t;return an(H.hash.outputLen,H.nByteLength,H.hmac)(_,U)}u.BASE._setWindowSize(8);function k(h,p,v,_=y){var ke;const U=h;if(p=N("msgHash",p),v=N("publicKey",v),"strict"in _)throw new Error("options.strict was renamed to lowS");const{lowS:H,prehash:C}=_;let M,F;try{if(typeof U=="string"||U instanceof Uint8Array)try{M=E.fromDER(U)}catch(K){if(!(K instanceof we.Err))throw K;M=E.fromCompact(U)}else if(typeof U=="object"&&typeof U.r=="bigint"&&typeof U.s=="bigint"){const{r:K,s:Re}=U;M=new E(K,Re)}else throw new Error("PARSE");F=u.fromHex(v)}catch(K){if(K.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(H&&M.hasHighS())return!1;C&&(p=t.hash(p));const{r:q,s:re}=M,se=O(p),X=a(re),Se=c(se*X),me=c(q*X),Ie=(ke=u.BASE.multiplyAndAddUnsafe(F,Se,me))==null?void 0:ke.toAffine();return Ie?c(Ie.x)===q:!1}return{CURVE:t,getPublicKey:x,getSharedSecret:L,sign:b,verify:k,ProjectivePoint:u,Signature:E,utils:R}}class fn extends Kt{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,ge.hash(t);const r=ot(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return ge.exists(this),this.iHash.update(t),this}digestInto(t){ge.exists(this),ge.bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:c}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=c,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hn=(e,t,n)=>new fn(e,t).update(n).digest();hn.create=(e,t)=>new fn(e,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function cs(e){return{hash:e,hmac:(t,...n)=>hn(e,t,Rr(...n)),randomBytes:en}}function us(e,t){const n=r=>as({...e,...cs(r)});return Object.freeze({...n(t),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ze=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),qe=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),gn=BigInt(1),Ze=BigInt(2),yn=(e,t)=>(e+t/Ze)/t;function pn(e){const t=ze,n=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),c=BigInt(44),a=BigInt(88),u=e*e*e%t,l=u*u*e%t,d=Q(l,n,t)*l%t,g=Q(d,n,t)*l%t,A=Q(g,Ze,t)*u%t,T=Q(A,s,t)*A%t,w=Q(T,i,t)*T%t,m=Q(w,c,t)*w%t,E=Q(m,a,t)*m%t,R=Q(E,c,t)*w%t,x=Q(R,n,t)*l%t,S=Q(x,o,t)*T%t,L=Q(S,r,t)*u%t,I=Q(L,Ze,t);if(!yt.eql(yt.sqr(I),e))throw new Error("Cannot find square root");return I}const yt=Kr(ze,void 0,void 0,{sqrt:pn}),pt=us({a:BigInt(0),b:BigInt(7),Fp:yt,n:qe,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=qe,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-gn*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=n,o=BigInt("0x100000000000000000000000000000000"),c=yn(i*e,t),a=yn(-r*e,t);let u=D(e-c*n-a*s,t),l=D(-c*r-a*i,t);const d=u>o,g=l>o;if(d&&(u=t-u),g&&(l=t-l),u>o||l>o)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:d,k1:u,k2neg:g,k2:l}}}},Fe),Ge=BigInt(0),wn=e=>typeof e=="bigint"&&Ge<e&&e<ze,ls=e=>typeof e=="bigint"&&Ge<e&&e<qe,bn={};function Qe(e,...t){let n=bn[e];if(n===void 0){const r=Fe(Uint8Array.from(e,s=>s.charCodeAt(0)));n=ye(r,r),bn[e]=n}return Fe(ye(n,...t))}const wt=e=>e.toRawBytes(!0).slice(1),bt=e=>ce(e,32),mt=e=>D(e,ze),Ce=e=>D(e,qe),Et=pt.ProjectivePoint,ds=(e,t,n)=>Et.BASE.multiplyAndAddUnsafe(e,t,n);function vt(e){let t=pt.utils.normPrivateKeyToScalar(e),n=Et.fromPrivateKey(t);return{scalar:n.hasEvenY()?t:Ce(-t),bytes:wt(n)}}function mn(e){if(!wn(e))throw new Error("bad x: need 0 < x < p");const t=mt(e*e),n=mt(t*e+BigInt(7));let r=pn(n);r%Ze!==Ge&&(r=mt(-r));const s=new Et(e,r,gn);return s.assertValidity(),s}function En(...e){return Ce(Z(Qe("BIP0340/challenge",...e)))}function fs(e){return vt(e).bytes}function hs(e,t,n=en(32)){const r=N("message",e),{bytes:s,scalar:i}=vt(t),o=N("auxRand",n,32),c=bt(i^Z(Qe("BIP0340/aux",o))),a=Qe("BIP0340/nonce",c,s,r),u=Ce(Z(a));if(u===Ge)throw new Error("sign failed: k is zero");const{bytes:l,scalar:d}=vt(u),g=En(l,s,r),A=new Uint8Array(64);if(A.set(l,0),A.set(bt(Ce(d+g*i)),32),!vn(A,r,s))throw new Error("sign: Invalid signature produced");return A}function vn(e,t,n){const r=N("signature",e,64),s=N("message",t),i=N("publicKey",n,32);try{const o=mn(Z(i)),c=Z(r.subarray(0,32));if(!wn(c))return!1;const a=Z(r.subarray(32,64));if(!ls(a))return!1;const u=En(bt(c),wt(o),s),l=ds(o,a,Ce(-u));return!(!l||!l.hasEvenY()||l.toAffine().x!==c)}catch{return!1}}const An=(()=>({getPublicKey:fs,sign:hs,verify:vn,utils:{randomPrivateKey:pt.utils.randomPrivateKey,lift_x:mn,pointToBytes:wt,numberToBytesBE:ce,bytesToNumberBE:Z,taggedHash:Qe,mod:D}}))();let At=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");var Je=(e=>(e.AUTH="AUTH",e.CLOSE="CLOSE",e.COUNT="COUNT",e.EVENT="EVENT",e.REQ="REQ",e))(Je||{}),B=(e=>(e[e.METADATA=0]="METADATA",e[e.SHORT_TEXT_NOTE=1]="SHORT_TEXT_NOTE",e[e.RECOMMEND_RELAY=2]="RECOMMEND_RELAY",e[e.CONTACTS=3]="CONTACTS",e[e.ENCRYPTED_DIRECT_MESSAGES=4]="ENCRYPTED_DIRECT_MESSAGES",e[e.EVENT_DELETION=5]="EVENT_DELETION",e[e.REPOST=6]="REPOST",e[e.REACTION=7]="REACTION",e[e.BADGE_AWARD=8]="BADGE_AWARD",e[e.GENERIC_REPOST=16]="GENERIC_REPOST",e[e.CHANNEL_CREATION=40]="CHANNEL_CREATION",e[e.CHANNEL_METADATA=41]="CHANNEL_METADATA",e[e.CHANNEL_MESSAGE=42]="CHANNEL_MESSAGE",e[e.CHANNEL_HIDE_MESSAGE=43]="CHANNEL_HIDE_MESSAGE",e[e.CHANNEL_MUTE_USER=44]="CHANNEL_MUTE_USER",e[e.FILE_METADATA=1063]="FILE_METADATA",e[e.LIVE_CHAT_MESSAGE=1311]="LIVE_CHAT_MESSAGE",e[e.REPORTING=1984]="REPORTING",e[e.LABEL=1985]="LABEL",e[e.ZAP_REQUEST=9734]="ZAP_REQUEST",e[e.ZAP_RECEIPT=9735]="ZAP_RECEIPT",e[e.MUTE_LIST=1e4]="MUTE_LIST",e[e.PIN_LIST=10001]="PIN_LIST",e[e.RELAY_LIST_METADATA=10002]="RELAY_LIST_METADATA",e[e.WALLET_INFO=13194]="WALLET_INFO",e[e.CLIENT_AUTHENTICATION=22242]="CLIENT_AUTHENTICATION",e[e.WALLET_REQUEST=23194]="WALLET_REQUEST",e[e.WALLET_RESPONSE=23195]="WALLET_RESPONSE",e[e.NOSTR_CONNECT=24133]="NOSTR_CONNECT",e[e.HTTP_AUTH=27235]="HTTP_AUTH",e[e.CATEGORIZED_PEOPLE_LIST=3e4]="CATEGORIZED_PEOPLE_LIST",e[e.CATEGORIZED_BOOKMARK_LIST=30001]="CATEGORIZED_BOOKMARK_LIST",e[e.PROFILE_BADGES=30008]="PROFILE_BADGES",e[e.BADGE_DEFINITION=30009]="BADGE_DEFINITION",e[e.CREATE_OR_UPDATE_A_STALL=30017]="CREATE_OR_UPDATE_A_STALL",e[e.CREATE_OR_UPDATE_A_PRODUCT=30018]="CREATE_OR_UPDATE_A_PRODUCT",e[e.LONG_FORM_CONTENT=30023]="LONG_FORM_CONTENT",e[e.DRAFT_LONG_FORM_CONTENT=30024]="DRAFT_LONG_FORM_CONTENT",e[e.APPLICATION_SPECIFIC_DATA=30078]="APPLICATION_SPECIFIC_DATA",e[e.LIVE_EVENT=30311]="LIVE_EVENT",e[e.CLASSIFIED_LISTING=30402]="CLASSIFIED_LISTING",e[e.DRAFT_CLASSIFIED_LISTING=30403]="DRAFT_CLASSIFIED_LISTING",e[e.HANDLER_RECOMMENDATION=31989]="HANDLER_RECOMMENDATION",e[e.HANDLER_INFORMATION=31990]="HANDLER_INFORMATION",e))(B||{}),Tn=(e=>(e.GITHUB="github",e.TWITTER="twitter",e.MASTODON="mastodon",e.TELEGRAM="telegram",e))(Tn||{}),z=(e=>(e.AUTH="AUTH",e.COUNT="COUNT",e.EOSE="EOSE",e.EVENT="EVENT",e.NOTICE="NOTICE",e.OK="OK",e))(z||{});function Tt(e){return vr.decode(e)}function gs(e){const t=e.tags.filter(r=>r[0]==="amount");if(t.length===0)return;const n=[];for(const r of t)r.length===2&&n.push(r[1]);return n&&n.length>0?n:void 0}function ys(e){return["amount",e]}function ps(e){if(e.kind!==3)return;const t=e.tags.filter(n=>n[0]==="p");if(t.length!==0)return t.map(n=>{let r;if(n.length===2)return r={key:n[1]},r;if(n.length===3)return r={key:n[1],relayUrl:n[2]},r;if(n.length===4)return r={key:n[1],relayUrl:n[2],petname:n[3]},r})}function ws(e){if(!e.tags)return;let t=!1,n="";for(const r of e.tags)r.find(i=>i==="content-warning")&&(t=!0,r.length===2&&r[0]==="content-warning"||r.length===3&&r[2]==="content-warning"&&r[0]==="l"?n=r[1]:n="N/A");return t?n:void 0}var bs=/(?:nostr:)?(npub|nsec|note|lnurl|nprofile|nevent)([a-zA-Z0-9]+)/g,Sn=(e=>(e.npub="npub",e.nsec="nsec",e.note="note",e.lnurl="lnurl",e.nprofile="nprofile",e.nevent="nevent",e))(Sn||{});function ms(e){return/^(wss?):\/\/([a-zA-Z0-9.-]+)(:\d+)?(\/[a-zA-Z0-9_/.-]*)?$/.test(e)}function Es(e,t){if(!e||e==="")return{isValid:!0};if(t===6)try{return JSON.parse(e),{isValid:!0}}catch(n){return console.error(n),{isValid:!1,error:"Invalid JSON format"}}else if(t===2&&!ms(e))return{isValid:!1,error:`Expected a valid websocket URL, got ${e}.`};return vs(e)?{isValid:!1,error:"HTML tags are not allowed"}:{isValid:!0}}function vs(e){return/<[^>]*>/.test(e)}var In=[{name:"www.youtube.com"},{name:"music.youtube.com"},{name:"youtu.be",rewrite:e=>`https://www.youtube.com/watch?v=${e.split("/").pop()}`},{name:"twitch.tv"},{name:"vimeo.com"},{name:"rumble.com"}],As=["jpg","jpeg","png","gif","webp"],Ts=["mp4","webm","ogg"],Ss=In.map(e=>e.name.replace(/\./g,"\\.")).join("|"),Is=Ts.join("|"),ks=`https?:\\/\\/(${Ss})\\/([a-zA-Z0-9_-]+)(\\?[a-zA-Z0-9_=&-]+)?|https?:\\/\\/\\S+\\.(${Is})`,Rs=new RegExp(ks,"gi"),xs=As.join("|"),Os=new RegExp(`\\bhttps?:\\/\\/\\S+?\\.(${xs})(?:\\?\\S+)?\\b`,"gi");function Cs(e){if(e===void 0)return;const t=e==null?void 0:e.match(Os),n=e==null?void 0:e.match(Rs),s=Array.from(e.matchAll(bs),c=>c.slice(1,3)).map(([c,a])=>Object.values(Sn).includes(c)?{type:c,data:a}:null).filter(c=>c!==null),i=/#[a-zA-Z0-9_-]+/gi,o=e==null?void 0:e.match(i);return t&&e&&t.forEach(c=>e=e.replace(c,"")),n&&e&&n.forEach(c=>e=e.replace(c,"")),n&&n.forEach((c,a)=>{const u=In.find(l=>c.includes(l.name));u!=null&&u.rewrite&&(n[a]=u.rewrite(c))}),{images:t||void 0,videos:n||void 0,nurls:s&&s.length>0?s:void 0,tags:o||void 0,text:e.trim()}}function Bs(e){if(!e)return;let t=[];for(let n of e){if(!Array.isArray(n)||n.length<2||n.length>3||n[0]!=="a")continue;let r=n[1].split(":");if(r.length!==3)continue;let s=r[0],i=r[1],o=r[2],c;n.length===3&&(c=n[2]),t.push({kind:s,pubkey:i,identifier:o,relay:c})}if(t.length!==0)return t}function Us(e){const t=Bs(e.tags);if(t)return t}function Ls(e){const{kind:t,pubkey:n,identifier:r,relay:s}=e;return s?[`a:${t}:${n}:${r}, ${s}`]:[`a:${t}:${n}:${r}`]}function kn(e){const t=e.tags.filter(r=>r[0]==="e");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push({eventId:r[1]}):r.length===3?n.push({eventId:r[1],relayUrl:r[2]}):r.length===4&&n.push({eventId:r[1],relayUrl:r[2],marker:r[3]});return n&&n.length>0?n:void 0}function Rn(e){const t=e.tags.filter(r=>r[0]==="e");if(t.length===0)return;const n=[];for(let r=0;r<t.length;r++)r===0&&n.push({eventId:t[r][1],relayUrl:"",marker:"root"}),t.length===2?r===1&&n.push({eventId:t[r][1],relayUrl:"",marker:"reply"}):t.length>2&&(r===1?n.push({eventId:t[r][1],relayUrl:"",marker:"mention"}):r>1&&n.push({eventId:t[r][1],relayUrl:"",marker:"reply"}));return n&&n.length>0?n:void 0}function xn(e){return!e.tags||e.tags.length===0?!1:e.tags.filter(n=>n[0]==="e"&&n.length>2).length===0}function Ps(e){const t=e.tags.filter(n=>n[0]==="expiration");if(t.length!==0)return parseInt(t[0][1])}function _s(e){const t=[],n=e.tags.filter(r=>r[0]==="d");if(n.length!==0){for(const r of n){let s=r[1]||"";t.includes(s)||t.push(s)}return t&&t.length>0?t:void 0}}function Ms(e){return["d",e]}function $s(e){const t=e.tags.filter(r=>r[0]==="lnurl");if(t.length===0)return;const n=[];for(const r of t)r.length>0&&n.push(r[1]);return n&&n.length>0?n:void 0}function Hs(e){return["lnurl",e]}function Ws(e){const t=e.tags.filter(n=>n[0]==="nonce");if(t.length!==0)return[parseInt(t[0][1]),parseInt(t[0][2])]}function js(e,t){if(e.hasNonceTag())throw new Error("Event already has a nonce.");if(t.length!==2)throw new Error("Nonce must be an array of 2 numbers: [miningResult, difficulty]");const n=t[0].toString(),r=t[1].toString();return e.addTag(["nonce",n,r]),e}function Fs(e,t){return e.tags=e.tags.filter(n=>n[0]!=="nonce"),e.addNonceTag(t),e}function Ns(e){const t=e.tags.filter(r=>r[0]==="p");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push([r[1]]):r.length===3&&n.push([r[1],r[2]]);return n}function Ds(e){const t=e.tags.filter(r=>r[0]==="relays");if(t.length===0)return;const n=[];for(const r of t)r.length===2?n.push({url:r[1],read:!0,write:!0}):r.length===3&&n.push({url:r[1],read:r[2]==="read",write:r[2]==="write"});return n.length>0?n:void 0}function zs(e){if(e.kind!==1984)throw new Error(`Event is not a report: ${e.kind}. Expected 1984.`);const t=e.tags.filter(c=>c[0]==="p");if(!t||t.length===0)return;let n;const r=e.tags.filter(c=>c[0]==="e");r.length>0&&r[0].length>0&&(n=r[0][1]);let s;t[0].length===3?s=t[0][2]:r.length>0&&r[0].length===3&&(s=r[0][2]);let i;return t[0].length>0&&(i=t[0][1]),!s||!i?void 0:{eventId:n,kind:s,publicKey:i,content:e.content&&e.content!==""?e.content:void 0}}function qs(e){const{eventId:t,kind:n,publicKey:r}=e;if(!n)throw new Error("Report must have a kind.");if(!r)throw new Error("Report must mention a public key.");if(n==="impersonation"&&t)throw new Error("Impersonation reports should refer to a person, not an event.");const s=[];return t?(s.push(["e",t,n]),r&&s.push(["p",r])):r&&s.push(["p",r,n]),s}function Zs(e){const t=e.tags.filter(n=>n[0]==="subject");if(t.length!==0)return t[0][1]}function On(e){const t=e.tags?e.tags.filter(n=>n[0]==="t"):[];return t.length>0?t.map(n=>n[1]):void 0}function Cn(e){return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}var Bn=new TextEncoder,Un=new TextDecoder("utf-8");function St(e){const t=Fe(Bn.encode(e));return ae(t)}function Gs(e){return St(Cn(e))}function Qs({callback:e,amount:t,event:n,lnurl:r}){return`${e}?amount=${t}&nostr=${n}&lnurl=${r}`}function Js(e){if(e.allowsNostr&&e.nostrPubkey)return!0}function Vs(e,t){const n=e.amount?e.amount:void 0,r=e.lnurl?e.lnurl:void 0;if(!n||!r)return!0;const s=Tt(t.pr);let i;const o=s.sections.find(c=>c.name==="amount");if(o)i=o.value;else return!1;return!(n&&n.toString()!==i)}function Xs(e){const t=new te(e),n=t.hasPublicKeyTags();if(!n)throw new Error("No pubkey tags found");if(e.kind!==9734)throw new Error("Event is not a zap request");const r=n[0],s=t.hasRelaysTag(),i={pubkey:r,content:"",id:t.id,sig:t.sig,kind:t.kind,tags:t.tags,relays:s};return JSON.stringify(i)}function Ks(e){let t=/,*?((lnurl)([0-9]{1,}[a-z0-9]+){1})/.exec(e.toLowerCase());return t?t[1]:null}function Ys(e){if(e=e.trim(),e.toLowerCase().slice(0,6)==="lnurl1"){const{words:t}=he.decode(e,2e4),n=new Uint8Array(he.fromWords(t));return Un.decode(n)}else if(e.slice(0,9)==="lnurlc://"||e.slice(0,9)==="lnurlw://"||e.slice(0,9)==="lnurlp://"||e.slice(0,10)==="keyauth://"){let[t,n]=e.split("://");return(n.match(/\.onion($|\W)/)?"http":"https")+"://"+n}else if(e.slice(0,8)==="https://"){let t=Ks(e);if(t){const{words:n}=he.decode(t,2e4),r=new Uint8Array(he.fromWords(n));return Un.decode(r)}return e}throw new Error(`invalid url ${e}`)}function ei(e){const t=Bn.encode(e),n=he.toWords(new Uint8Array(t));return he.encode("lnurl",n,2e4)}function Ln(e){return e.endsWith(".onion")}function ti(e){const[t,n]=e.split("@");return`${Ln(n)?"http":"https"}://${n}/.well-known/lnurlp/${t}`}function ni(e){const[t,n]=e.split("@");return`${Ln(n)?"http":"https"}://${n}/.well-known/nostr.json?name=${t}`}function ri(e){let t=0;for(let n=0;n<e.length;n++){const r=parseInt(e[n],16);if(r===0)t+=4;else{t+=Math.clz32(r)-28;break}}return t}function si(e,t,n){let r=0;const s=t.toString();for(;;){const i=e.tags.findIndex(a=>a[0]==="nonce");i!==-1?e.tags[i][1]=r.toString():e.tags.push(["nonce",r.toString(),s]);const o=JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content]);if(e.id=St(o),ri(e.id)>=t)return console.log("Proof of work complete"),e.tags=e.tags.filter(a=>a[0]!=="nonce"),e.tags.push(["nonce",r.toString(),s]),e;if(n&&r>=n)return;r++}}function Pn(e){return/^[a-z0-9\.\-_\/@]*$/.test(e)}function ii(e){return e.toLowerCase()}function oi(e,t){if(e.length!==64)throw new Error("Invalid event hash");const n=An.sign(e,t);return ae(n)}function ai(e){try{const t=JSON.parse(e);return{name:t.name??null,display_name:t.display_name??null,picture:t.picture??null,banner:t.banner??null,nip05:t.nip05??null,website:t.website??null,about:t.about??null,image:t.image??null,npub:t.npub??null,lud16:t.lud16??null,lud06:t.lud06??null}}catch(t){return console.error("Unable to parse user metadata string",t),null}}function ci(e){try{const t=Gs(e);return An.verify(e.sig,t,e.pubkey)}catch(t){return console.error(t),!1}}var ui=class{constructor(e){if(e){if(!Pn(e.identity))throw new Error("Invalid identity. Valid: a-z, 0-9, -, _, @");this.type=e.type,this.identity=ii(e.identity),this.proof=e.proof}}toTag(){switch(this.type){case"github":return["i",`github:${this.identity}`,this.proof];case"twitter":return["i",`twitter:${this.identity}`,this.proof];case"mastodon":return["i",`mastodon:${this.identity}`,this.proof];case"telegram":return["i",`telegram:${this.identity}`,this.proof];default:throw new Error(`Unknown claim type ${this.type}. Valid: github, twitter, mastodon, telegram`)}}fromTag(e){if(_n(e))return this.type=e[1].split(":")[0],this.identity=e[1].split(":")[1],this.proof=e[2],this}};function _n(e){return!(e.length!==3||!Object.values(Tn).includes(e[1].split(":")[0])||!Pn(e[1].split(":")[1]))}function Mn(e){const t=e.tags.filter(r=>r[0]==="i"&&_n(r));if(t.length===0)return;const n=[];for(const r of t){const s=new ui;s.fromTag(r),n.push(s)}return n}var te=class{constructor(e){this.id=e.id?e.id:"",this.pubkey=e.pubkey?e.pubkey:"",this.created_at=e.created_at?e.created_at:Math.floor(Date.now()/1e3),this.kind=e.kind!=null?e.kind:1,this.tags=e.tags&&e.tags.length>0?e.tags:[],this.content=e.content,this.sig=e.sig?e.sig:""}generateId(){if(this.pubkey==="")throw new Error("Cannot generate event ID without a public key. Set a public key first.");const e=Cn(this.ToObj());this.id=St(e)}sign(e){if(this.id==="")throw new Error("Cannot sign event without an ID. Generate ID first.");this.pubkey=e.publicKey,this.sig=oi(this.id,e.privateKey)}signAndGenerateId(e){this.pubkey=e.publicKey,this.generateId(),this.sign(e)}ToObj(){const e={};for(const[t,n]of Object.entries(this))n!==void 0&&(e[t]=n);return e}toURI(){return encodeURI(JSON.stringify(this.ToObj()))}proofOfWork(e,t){const n=si(this,e,t);if(n)this.id=n.id,this.tags=n.tags;else throw new Error("Failed to generate proof of work.")}hasMentions(){const e=this.extractContent();if(!e)return;const t=e==null?void 0:e.nurls.filter(n=>n.type==="npub");return t.length>0?t:void 0}setContentWithoutChecks(e){return this.content=e,this}extractContent(){return Cs(this.content)}addTag(e){this.tags||(this.tags=[]),this.tags.push(e)}removeTag(e){this.tags&&(this.tags=this.tags.filter(t=>t[0]!==e[0]&&t[1]!==e[1]))}addEventTag(e){const t=e.relayUrl?e.relayUrl:"";let n=["e",e.eventId];e.marker?n=[...n,t,e.marker]:e.relayUrl&&(n=[...n,e.relayUrl]),this.addTag(n)}hasEventTags(){return xn(this)?Rn(this):kn(this)}hasTags(){return On(this)}addPublicKeyTag(e,t){const n=["p",e];t&&n.push(t),this.addTag(n)}hasPublicKeyTags(){return Ns(this)}addRelaysTag(e){const t=this.tags.filter(n=>n[0]==="relays");if(t.length===0)this.tags.push(["relays",...e]);else for(const n of t)n.splice(1,0,...e)}hasRelaysTag(){return Ds(this)}addEventCoordinatesTag(e){this.addTag(Ls(e))}hasEventCoordinatesTags(){return Us(this)}addIdentifierTag(e){this.addTag(Ms(e))}hasIdentifierTags(){return _s(this)}addLnurlTag(e){this.addTag(Hs(e))}hasLnurlTags(){return $s(this)}addAmountTag(e){this.addTag(ys(e))}hasAmountTags(){return gs(this)}addKindTag(e){this.addTag(["k",e.toString()])}addExpirationTag(e){if(this.hasExpirationTag())throw new Error("Event already has an expiration.");this.addTag(["expiration",e.toString()])}hasExpirationTag(){return Ps(this)}addSubjectTag(e){if(this.kind!==1)throw new Error(`Event kind ${this.kind} should not have a subject.`);if(this.hasSubjectTag())throw new Error("Event already has a subject.");this.addTag(["subject",e])}hasSubjectTag(){return Zs(this)}addNonceTag(e){const t=js(this,e);this.tags=t.tags}hasNonceTag(){return Ws(this)}replaceNonceTag(e){const t=Fs(this,e);this.tags=t.tags}addContentWarningTag(e){if(this.hasContentWarningTag())throw new Error("Event already has a content warning.");this.addTag(["content-warning",e||""])}hasContentWarningTag(){return ws(this)}addExternalIdentityClaimTag(e){this.addTag(e.toTag())}hasExternalIdentityClaimTag(){return Mn(this)}addReportTags(e){if(this.kind!==1984)throw new Error(`Event kind ${this.kind} should not have a report. Expected 1984.`);if(this.hasReportTags())throw new Error("Event already has report tags.");qs(e).forEach(n=>this.addTag(n))}hasReportTags(){return zs(this)}newZapReceipt(e){if(this.kind!==9734)throw new Error(`Event kind ${this.kind} should not have a zap receipt. Expected 9734.`);return fi({bolt11:e.bolt11,description:e.description,preimage:e.preimage,zapRequest:this})}determineRequiredNIP(){const e=[];return this.hasExternalIdentityClaimTag()&&e.push(39),this.hasExpirationTag()&&e.push(40),e}isReadyToPublish(){if(this.id==="")return{isReady:!1,reason:"Event has no ID."};if(this.pubkey==="")return{isReady:!1,reason:"Event has no pubkey."};if(this.sig==="")return{isReady:!1,reason:"Event has no signature."};const e=Es(this.content,this.kind);return e.isValid?{isReady:!0}:{isReady:!1,reason:e.error}}isReadyToPublishOrThrow(){const e=this.isReadyToPublish();if(!e.isReady)throw new Error(e.reason)}};function li(e){const t=new te({content:"",kind:9734});return t.addRelaysTag(e.relayUrls),t.addAmountTag(e.amount.toString()),t.addLnurlTag(e.lnurl),t.addPublicKeyTag(e.recipientPubkey),e.eventId&&t.addEventTag({eventId:e.eventId}),t}function di(e,t,n){const r=li(e);r.signAndGenerateId(n);const s=r.toURI();return{event:r,eventUri:s,invoiceUrl:Qs({callback:t,amount:e.amount,event:s,lnurl:e.lnurl})}}function fi(e){const t=e.zapRequest.tags.find(i=>i[0]==="p"),n=e.zapRequest.tags.find(i=>i[0]==="e"),r=Xs(e.zapRequest),s=new te({content:"",kind:9735,tags:[t,["bolt11",e.bolt11],["description",r]],created_at:e.zapRequest.created_at});return n&&s.addEventTag({eventId:n[1]}),e.preimage&&s.addTag(["preimage",e.preimage]),s}var be=class{constructor(e){this.ids=e==null?void 0:e.ids,this.authors=e==null?void 0:e.authors,this.kinds=e==null?void 0:e.kinds,this["#e"]=e==null?void 0:e["#e"],this["#p"]=e==null?void 0:e["#p"],this["#t"]=e==null?void 0:e["#t"],this.since=e==null?void 0:e.since,this.until=e==null?void 0:e.until,this.limit=e==null?void 0:e.limit}addId(e){this.ids||(this.ids=[]),this.ids.push(e)}addAuthor(e){this.authors||(this.authors=[]),this.authors.push(e)}addKind(e){this.kinds||(this.kinds=[]),this.kinds.push(e)}updateLimit(e){this.limit=e}toObj(){return JSON.parse(JSON.stringify(this))}},$n=class{constructor(e){this.subscriptions=[],this.url=e.url,this.read=e.read,this.write=e.write,this.requiresPOW=0,this.info=e.info,this.isEnabled=!0}isConnected(){return this.ws!==void 0&&this.ws.isConnected()}isReady(e){if(!this.isConnected()||!this.isEnabled)return!1;switch(e){case"read":return this.read;case"write":return this.write;case"any":return this.read||this.write;default:return!1}}supportsEvent(e){var s;const t=e.determineRequiredNIP(),n=((s=this.info)==null?void 0:s.supported_nips)||[];return console.log(`Required NIP: ${t.join(", ")}`,`Supported NIP: ${n.join(", ")}`),t.every(i=>n.includes(i))}supportsEventOrThrow(e){if(!this.supportsEvent(e))throw new Error(`Event ${e.id} is not supported by relay ${this.url}`)}addSubscription(e){this.subscriptions.push(e)}updateSubscription(e){const t=this.subscriptions.findIndex(n=>n.id===e.id);t!==-1&&(this.subscriptions[t]=e)}removeSubscription(e){this.subscriptions=this.subscriptions.map(t=>t.id===e?{...t,isActive:!1}:t),setTimeout(()=>{this.subscriptions=this.subscriptions.filter(t=>t.id!==e)},1e4)}getSubscription(e){const t=this.subscriptions.find(n=>n.id===e);return t?{...t,relayUrl:this.url}:null}getSubscriptions(e){return e&&e.isActive?this.subscriptions.filter(n=>n.isActive).map(n=>({...n,relayUrl:this.url})):this.subscriptions.map(n=>({...n,relayUrl:this.url}))}getInfo(e){return e==="default"?{url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW,isReady:this.isReady("any"),error:this.error}:{url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW,info:this.info,isReady:this.isReady("any"),error:this.error}}},hi=class{constructor(e){this.relays=[],this.addInitialRelays(e)}addInitialRelays(e){if(e&&(!this.relays||this.relays.length===0))for(const t of e)this.relays.push(new $n(t))}relaysForRequest(e){return e&&e.length>0?this.relays.filter(t=>e.includes(t.url)):this.relays}async waitForRelayToBeReady(e,t=0){return e.isReady("read")?!0:t>=5?(console.warn(`Relay ${e.url} is not ready after 5 retries. Skipping...`),console.log(`RELAY CLIENT: Relay ${e.url} is not ready. Skipping... (${t})`),!1):(await new Promise(n=>setTimeout(n,2e3)),this.waitForRelayToBeReady(e,t+1))}subscribe(e,t=0){const n=this.relaysForRequest(e.relayUrls),r=[];for(const s of n)this.waitForRelayToBeReady(s).then(i=>{var d;if(!i)return;const{relayUrls:o,...c}=e,a={...c,id:At(),relayUrl:s.url,created:Date.now(),isActive:!0};let u,l;if(e.type==="REQ")l={type:"REQ",subscriptionId:a.id,filters:JSON.parse(JSON.stringify(a.filters))},u=JSON.stringify([l.type,l.subscriptionId,l.filters]);else if(e.type==="COUNT"){const g=(d=s.info)==null?void 0:d.supported_nips;if(g&&!g.includes(45)){console.warn(`Relay ${s.url} does not support count command.`),a.error=`Relay ${s.url} does not support count command.`;return}l={type:"COUNT",subscriptionId:a.id,filters:JSON.parse(JSON.stringify(a.filters))},u=JSON.stringify([l.type,l.subscriptionId,l.filters])}else if(e.type==="AUTH")l={type:"AUTH",signedEvent:e.signedEvent},u=JSON.stringify([l.type,l.signedEvent]);else throw new Error(`Invalid subscription type: ${e.type}`);try{if(s.ws.sendMessage(u),s.addSubscription(a),e.type==="REQ"&&e.options){const g=e.options.timeoutIn;g&&(a.options={...e.options,view:e.options&&e.options.view?e.options.view:"",timeoutIn:g,timeoutAt:Date.now()+g,timeout:setTimeout(()=>{this.unsubscribe([a.id])},g)})}}catch(g){console.error(g)}});return r}unsubscribe(e){for(const t of this.relays){if(!t.isConnected())continue;const n=t.getSubscriptions();if(!n||n.length===0)continue;const r=n.filter(s=>e.includes(s.id));for(const s of r){const i={type:"CLOSE",subscriptionId:s.id};s.options&&s.options.timeout&&clearTimeout(s.options.timeout);try{t.ws.sendMessage(JSON.stringify([i.type,i.subscriptionId])),t.removeSubscription(s.id)}catch(o){console.error(o)}}}}unsubscribeAll(){this.relays.map(e=>{const t=e.getSubscriptions();t&&t.length>0&&this.unsubscribe(t.map(n=>n.id))})}getSubscription(e){for(const t of this.relays){const n=t.getSubscription(e);if(n)return n}}getSubscriptions(e){return this.relays.map(t=>t.getSubscriptions(e)).flat()}countSubscriptions(){return this.relays.map(e=>e.getSubscriptions().length).reduce((e,t)=>e+t,0)}updateSubscription(e){this.relays.map(t=>{t.url===e.relayUrl&&t.updateSubscription(e)})}countConnections(){let e=0;for(const t of this.relays)t.isConnected()&&e++;return e}getAuthChallenge(e){return this.relays.filter(n=>e.includes(n.url)).map(n=>({relayUrl:n.url,challenge:n.authChallenge}))}sendEvent(e){const t={type:"EVENT",data:e.event},n=this.relaysForRequest(e.relayUrls);console.log("RELAY CLIENT: Sending event",t.data,n);const r=[],s=JSON.stringify([t.type,t.data]);for(const i of n){const{relayUrls:o,...c}=e,a={id:At(),...c,relayUrl:i.url,send:!0,error:void 0},u=i.isReady("write"),l=i.supportsEvent(e.event);if(!u||!l){const d=u?`Event ${e.event.id} was not published because not all needed NIPS are supported`:`Relay ${i.url} is not ready for write operations. Skipping...`;a.send=!1,a.error=d,r.push(a);continue}console.log(`RELAY CLIENT: Sending event ${e.event.id} to ${i.url}.`,s),i.ws.sendMessage(s),r.push(a)}return r.length>0?r:void 0}sendQueueItems(e){var r;const t={type:"EVENT",data:(r=e.find(s=>s.event))==null?void 0:r.event},n=JSON.stringify([t.type,t.data]);for(const s of e){const i=this.relays.find(o=>o.url===s.relayUrl);i&&(console.log(`Sending queued event ${s.event.id} to ${i.url}.`,n),i.ws.sendMessage(n),s.send=!0)}return e}listen(e){for(const t of this.relays)t.isEnabled&&t.ws.listen(n=>{n[0]==="AUTH"&&(console.log(`Received auth challenge ${n[1]} from ${t.url}.`),t.authChallenge=n[1]),e({data:n,meta:t.getInfo("default")})})}disconnect(){this.unsubscribeAll(),setTimeout(()=>{var t;const e={subscriptions:this.countSubscriptions(),connections:this.countConnections()};console.log(`
  Stats:
  - Subscriptions: ${e.subscriptions}
  - Connections: ${e.connections}
      `);for(const n of this.relays)(t=n.ws)==null||t.disconnect();this.relays=[]},1e3)}},Be=class{constructor(e){this.pubkey=(e==null?void 0:e.pubkey)||void 0,this.claims=(e==null?void 0:e.claims)||[],this.data=(e==null?void 0:e.data)||{},this.lastUpdated=(e==null?void 0:e.lastUpdated)||0}loaded(){return this.data!==void 0}hasZapInfo(){return this.lightningZapInfo!==void 0}fromPublicKey(e){return this.pubkey=e,this}fromEvent(e,t=!0){const n=new te(e);if(n.kind!==0){if(t)throw new Error("wrong event kind");return}if(this.pubkey&&this.pubkey!==""&&n.pubkey!==this.pubkey){if(t)throw new Error("wrong event pubkey");return}if(this.pubkey=n.pubkey,this.lastUpdated=n.created_at,n.content&&n.content!==""){const s=ai(n.content);s&&(this.data=s)}const r=Mn(e);return r&&(this.claims=r),this}getNip05Url(){var t;const e=((t=this.data)==null?void 0:t.nip05)||void 0;if(e)return ni(e)}validateWellKnown(e){return e?Object.keys(e.names).find(n=>e.names[n]===this.pubkey)?(this.nip05isValid=!0,!0):(this.nip05isValid=!1,!1):!1}getLud16(){var e;return((e=this.data)==null?void 0:e.lud16)||void 0}getLud16Url(){const e=this.getLud16();if(e)return ti(e)}getLud06(){var e;return((e=this.data)==null?void 0:e.lud06)||void 0}getLud06Url(){const e=this.getLud06();if(e)return Ys(e)}getLud16Or06(){const e=this.getLud06();if(e)return{type:"lud06",url:e};const t=this.getLud16();if(t)return{type:"lud16",url:t}}getLud16Or06Url(){const e=this.getLud06Url();if(e)return{type:"lud06",url:e};const t=this.getLud16Url();if(t)return{type:"lud16",url:t}}getMetadataFilter(){const e=new be;return e.addAuthor(this.pubkey),e.addKind(0),e}toJson(){return{pubkey:this.pubkey,claims:this.claims,data:this.data,lightningZapInfo:this.lightningZapInfo,lastUpdated:this.lastUpdated,nip05isValid:this.nip05isValid}}fromJson(e){return this.pubkey=e.pubkey,this.claims=e.claims,this.data=e.data,this.lightningZapInfo=e.lightningZapInfo,this.lastUpdated=e.lastUpdated,this.nip05isValid=e.nip05isValid,this}};const gi=(e,t)=>t.some(n=>e instanceof n);let Hn,Wn;function yi(){return Hn||(Hn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function pi(){return Wn||(Wn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const jn=new WeakMap,It=new WeakMap,Fn=new WeakMap,kt=new WeakMap,Rt=new WeakMap;function wi(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(ue(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",o)});return t.then(n=>{n instanceof IDBCursor&&jn.set(n,e)}).catch(()=>{}),Rt.set(t,e),t}function bi(e){if(It.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});It.set(e,t)}let xt={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return It.get(e);if(t==="objectStoreNames")return e.objectStoreNames||Fn.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ue(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function mi(e){xt=e(xt)}function Ei(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(Ot(this),t,...n);return Fn.set(r,t.sort?t.sort():[t]),ue(r)}:pi().includes(e)?function(...t){return e.apply(Ot(this),t),ue(jn.get(this))}:function(...t){return ue(e.apply(Ot(this),t))}}function vi(e){return typeof e=="function"?Ei(e):(e instanceof IDBTransaction&&bi(e),gi(e,yi())?new Proxy(e,xt):e)}function ue(e){if(e instanceof IDBRequest)return wi(e);if(kt.has(e))return kt.get(e);const t=vi(e);return t!==e&&(kt.set(e,t),Rt.set(t,e)),t}const Ot=e=>Rt.get(e);function Ai(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(e,t),c=ue(o);return r&&o.addEventListener("upgradeneeded",a=>{r(ue(o.result),a.oldVersion,a.newVersion,ue(o.transaction),a)}),n&&o.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{i&&a.addEventListener("close",()=>i()),s&&a.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}const Ti=["get","getKey","getAll","getAllKeys","count"],Si=["put","add","delete","clear"],Ct=new Map;function Nn(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Ct.get(t))return Ct.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=Si.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Ti.includes(n)))return;const i=async function(o,...c){const a=this.transaction(o,s?"readwrite":"readonly");let u=a.store;return r&&(u=u.index(c.shift())),(await Promise.all([u[n](...c),s&&a.done]))[0]};return Ct.set(t,i),i}mi(e=>({...e,get:(t,n,r)=>Nn(t,n)||e.get(t,n,r),has:(t,n)=>!!Nn(t,n)||e.has(t,n)}));var Dn=class{constructor(){}connect(e){this.connection=new WebSocket(e)}isConnected(){return this.connection&&this.connection.readyState===this.connection.OPEN}sendMessage(e,t){const n=t||{retries:10,retryTimeout:100,retryCount:0};if(this.isConnected())this.connection.send(e);else{const r=n.retryCount+1;if(r===10)throw new Error(`Could not send message after ${r} retries`);setTimeout(()=>this.sendMessage(e,n),100)}}listen(e){this.connection.onmessage=t=>{e(JSON.parse(t.data))}}disconnect(){this.connection.close()}};async function Ve(e,t){try{let n=await Promise.race([fetch(e,{headers:t}),new Promise((s,i)=>setTimeout(()=>i(new Error("Timeout")),5e3))]);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(n){throw new Error(`Error making request: ${n}`)}}async function Ii(e){let t=e.replace(/^wss:\/\//i,"https://");console.log("###############"),console.log("Fetching relay information from",t),console.log("###############");const n=new AbortController;return setTimeout(()=>{n.abort()},5e3),Ve(t,{Accept:"application/nostr+json"})}var ki=class extends hi{constructor(e,t){super(e),(!t&&e||e&&t.connectManually!==!0)&&this.connectRelays()}connectRelays(){console.log(`=> Connecting to ${this.relays.length} relay(s) ...`);for(const e of this.relays)if(!e.isConnected()){console.log(`=> Connecting to ${e.url} ...`);try{e.ws=new Dn,e.ws.connect(e.url),e.ws.connection.onopen=()=>{console.log(`Websocket connected to ${e.url}`)},e.ws.connection.onclose=t=>{console.log(`WebSocket to ${e.url} closed.`,JSON.stringify(t))},e.ws.connection.onerror=t=>{console.log(`WebSocket disconnected from ${e.url}`,JSON.stringify(t)),e.error=JSON.stringify(t)}}catch(t){const n=t;console.error("Error connecting to relay",n.message),e.error=n.message}}}connectRelay(e){console.log(`=> Connecting to ${e.url} ...`);const t=new $n(e);try{t.ws=new Dn,t.ws.connect(t.url),t.ws.connection.onopen=()=>{console.log(`Websocket connected to ${t.url}`)},t.ws.connection.onclose=n=>{console.log(`WebSocket to ${t.url} closed.`,JSON.stringify(n))},t.ws.connection.onerror=n=>{console.log(`WebSocket disconnected from ${t.url}`,JSON.stringify(n)),t.error=JSON.stringify(n)}}catch(n){const r=n;console.error("Error connecting to relay",r.message),t.error=r.message}this.relays.push(t)}loadFromDiscovered(e){this.addInitialRelays(e.map(t=>({url:t.url,read:!0,write:!0}))),this.connectRelays()}async getRelayInformation(){const e=[];for(const t of this.relays)if(!t.info)try{t.info=await Ii(t.url),console.log(`Relay ${t.url} information`,t.info),e.push(t.getInfo("withInfo"))}catch(n){const r=n;t.error=r.message,console.error("Error getting relay information",r.message)}return e}},zn=class extends Be{constructor(e){super(e)}async makeZapRequest(e,t){const n=this.getLud16Or06Url();if(n)try{if(!this.hasZapInfo()){const o=await Ve(n.url);if(!Js(o))throw new Error("Lnurl endpoint does not allow Nostr payments. Expected to find 'allowsNostr' in response.");this.lightningZapInfo=o}console.log("LnurlEndpointResponse",this.lightningZapInfo);const r={...e,recipientPubkey:this.pubkey,lnurl:n.type==="lud16"?ei(this.getLud16()):this.getLud06()},s=di(r,this.lightningZapInfo.callback,t),i=await Ve(s.invoiceUrl);if(!Vs(r,i))throw new Error("Lnurl invoice response is invalid or does not match your request.");return console.log("LnurlInvoiceResponse",i),{...i,event:s.event}}catch(r){throw new Error(`Error making zap request: ${r}`)}else throw new Error("No lud16 or lud06 url found")}async makeNIP05Request(){const e=this.getNip05Url();if(e)try{return await Ve(e)}catch(t){throw new Error(`Error making NIP05 request: ${t}`)}else throw new Error("No nip05 url found")}};function Ri(e,t,n,r){if(t<1&&(console.log(`DATABASE: Migrating database from version ${t} to 1`),e.objectStoreNames.contains("users")||e.createObjectStore("users",{keyPath:"user.pubkey"}),e.objectStoreNames.contains("following")||e.createObjectStore("following",{keyPath:"user.pubkey"})),t<2&&(console.log(`DATABASE: Migrating database from version ${t} to 2`),e.objectStoreNames.contains("following")&&e.deleteObjectStore("following")),t<3&&(console.log(`DATABASE: Migrating database from version ${t} to 3`),e.objectStoreNames.contains("lists")||(e.createObjectStore("lists",{keyPath:"id"}),r.objectStore("lists").createIndex("users","userPubkeys",{multiEntry:!0}))),t<4){console.log(`DATABASE: Migrating database from version ${t} to 4`);const s=e.createObjectStore("events",{keyPath:"id"});s.createIndex("pubkey","pubkey",{unique:!1}),s.createIndex("kind","kind",{unique:!1}),s.createIndex("created_at","created_at",{unique:!1}),s.createIndex("kindAndPubkey",["kind","pubkey"],{unique:!1});const i=e.createObjectStore("tags",{keyPath:"id"});i.createIndex("eventId","eventId",{unique:!1}),i.createIndex("typeAndValue",["type","value"],{unique:!1})}}var Xe=24*60*60,qn=60,le=10*1e3;function de(e){const t=e.reactions.reduce((r,s)=>{const i=s!=null&&s.content?s.content:void 0;return i&&r[i]?r[i]+=1:i&&(r[i]=1),r},{});return{event:e.event,user:e.user,eventRelayUrls:e.eventRelayUrls,repliesCount:e.replies.length,reactionsCount:t,repostsCount:e.reposts.length,badgeAwardsCount:e.badgeAwards.length,mentionsCount:0,zapReceiptAmount:e.zapReceipts.reduce((r,s)=>r+Number(s.amount),0),zapReceiptCount:e.zapReceipts.length}}function xi(e){const t=e.since||Math.round(Date.now()/1e3-Xe),n=e.until||Math.round(Date.now()/1e3);if(t>n)throw new Error("Invalid range");return[t,n]}function Oi(e){const t=e.query,{filters:n}=t;let r;return t.filters.until&&t.filters.since&&(r=Xe*3),{type:Je.REQ,filters:{...n,since:r?n.until-r:n.since,until:n.until},options:{timeoutIn:qn*1e3,view:e.token,isLive:t.isLive}}}function Ci(e,t){return!e||e.length===0?!0:!t||t.length===0?!1:e.some(n=>t.includes(n))}var Bi=["e","p","t"];function Ue(e,t=10){const n=Object.entries(e).sort(([,r],[,s])=>s-r).slice(0,t);return Object.fromEntries(n)}function Zn(e,t){const n={...e};for(const[r,s]of Object.entries(t))n[r]=(n[r]||0)+s;return n}function Te(e){return{event:e,user:void 0,eventRelayUrls:void 0,reactions:[],reposts:[],badgeAwards:[],mentions:[],replies:[],zapReceipts:[]}}function Gn(e){if(e.kind===B.SHORT_TEXT_NOTE||e.kind===B.LONG_FORM_CONTENT){const t=new te(e).hasEventTags();if(t?t.find(r=>r.marker==="root"||r.marker==="reply"):void 0)return!1}return!0}function Bt(e,t){if(!(e.kinds&&e.kinds.includes(t.kind))||!(!e.authors||e.authors.includes(t.pubkey)))return!1;const s=On(t);return Ci(e["#t"],s)?(e.since&&e.until&&t.created_at>=e.since&&t.created_at<=e.until,!0):!1}var Ui=class{async init(){console.log("=> DATABASE: Initializing database..."),this.db=await Ai("nostrop",4,{upgrade(e,t,n,r){Ri(e,t,n,r)}})}async deleteAll(){if(!this.db)throw new Error("=> DATABASE: not ready");await this.db.clear("events"),await this.db.clear("users"),await this.db.clear("tags")}async getUser(e){if(!this.db)throw new Error("=> DATABASE: not ready");return this.db.get("users",e)}async getUsersByParam(e){if(!this.db)throw new Error("=> DATABASE: not ready");let r=await this.db.transaction("users","readonly").objectStore("users").openCursor();const s=[];for(;r;)r.value[e]===!0&&s.push(r.value),r=await r.continue();return s.map(i=>({...i,user:new zn(i.user)}))}async addUser(e){if(!this.db)throw new Error("=> DATABASE: not ready");return this.db.put("users",e)}async updateUser(e){if(!this.db)throw new Error("=> DATABASE: not ready");if(!e.user.pubkey)throw new Error("=> DATABASE: no pubkey provided");return this.db.put("users",{...e})}async countUsers(){if(!this.db)throw new Error("=> DATABASE: not ready");return this.db.count("users")}async getEvent(e){if(!this.db)throw new Error("=> DATABASE: not ready");return this.db.get("events",e)}async getEventsByPublicKeysAndKinds(e,t){var c;const n=(c=this.db)==null?void 0:c.transaction("events","readonly"),r=n==null?void 0:n.objectStore("events"),s=r==null?void 0:r.index("kindAndPubkey"),i=[];let o=0;for(const a of e.authors)for(const u of e.kinds){let l=await(s==null?void 0:s.openCursor([u,a],"prev"));for(;l;){const d=l.value,g=t&&t.includes(d.id),A=e.limit?i.length<e.limit:!0,T=Bt(e,d);if(!g&&Gn(d)&&T&&(o++,A&&i.push(d)),o>500)break;l=await l.continue()}}return[i,o]}async getEventsByTypesAndValues(e,t,n,r){var l;const s=(l=this.db)==null?void 0:l.transaction("tags","readonly"),i=s==null?void 0:s.objectStore("tags"),o=i==null?void 0:i.index("typeAndValue"),c=[],a=[];let u=0;for(const d of t){let g=await(o==null?void 0:o.openCursor([e,d],"prev"));for(;g;){const A=g.value;if(r&&r.includes(A.eventId)||c.push(A.eventId),u++,u>500)break;g=await g.continue()}}for(const d of c){const g=await this.getEvent(d);if(g){const A=r&&r.includes(g.id),T=n.limit?a.length<n.limit:!0,w=Bt(n,g);!A&&w&&(u++,T&&a.push(g))}}return[a,u]}async getEvents(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");const{kinds:n,authors:r,"#e":s,"#p":i,"#t":o,since:c=Date.now()-Xe,until:a=Date.now(),limit:u=20}=e,l=t&&t.eventIds?t.eventIds:[];if(r&&r.length>0&&n&&n.length>0)return this.getEventsByPublicKeysAndKinds(e,l);if(o&&o.length>0)return this.getEventsByTypesAndValues("t",o,e,l);if(s&&s.length>0)return this.getEventsByTypesAndValues("e",s,e,l);if(i&&i.length>0)return this.getEventsByTypesAndValues("p",i,e,l);let d=[],g=0;try{const w=this.db.transaction("events","readonly").objectStore("events").index("created_at");console.log(`RANGE --- ${new Date(c*1e3).toLocaleString()} -> ${new Date(a*1e3).toLocaleString()}`);let m=await w.openCursor(IDBKeyRange.bound(c,a),"prev");for(;m;){const E=m.value,R=l.includes(E.id),x=e.limit?d.length<e.limit:!0,S=Bt(e,E);if(!R&&Gn(E)&&S&&(g++,x&&d.push(E)),g>=500)break;m=await m.continue()}}catch(A){throw console.error("An error occurred:",A),A}return[d,g]}async lastEventTimestamp(e,t=B.SHORT_TEXT_NOTE){if(!this.db)throw new Error("=> DATABASE: not ready");if(e.authors&&e.authors.length>0){const o=await this.db.transaction("events","readonly").objectStore("events").index("kindAndPubkey").openCursor(IDBKeyRange.only([t,e.authors[0]]),"prev");return o?o.value.created_at:void 0}else{const o=await this.db.transaction("events","readonly").objectStore("events").index("kind").openCursor(IDBKeyRange.only(t),"prev");return o?o.value.created_at:void 0}}async getRelatedEvents(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");const o=(await this.db.transaction("tags","readonly").objectStore("tags").index("typeAndValue").getAll(["e",e])).map(l=>l.eventId),a=this.db.transaction("events","readonly").objectStore("events"),u=[];for(const l of o){const d=await a.get(l);d&&t.includes(d.kind)&&u.push(new te(d))}return u}async saveEvent(e){if(!this.db)throw new Error("=> DATABASE: not ready");try{await this.db.add("events",e)}catch(t){const n=t;n.name!=="ConstraintError"&&console.error("An error occurred:",n.message)}if(e.tags){const t=e.tags.filter(n=>Bi.includes(n[0]));if(t.length===0)return;for(const n of t)try{await this.db.add("tags",{eventId:e.id,id:`${e.id.slice(0,10)}-${n[0]}-${n[1].slice(0,10)}}`,type:n[0],value:n[1]})}catch(r){const s=r;s.name!=="ConstraintError"&&console.error("An error occurred:",s.message)}}}async saveEventAndDeleteOlderOfType(e){if(!this.db)throw new Error("=> DATABASE: not ready");const t=await this.getEventsByPublicKeysAndKinds(new be({authors:[e.pubkey],kinds:[e.kind],since:0,until:Date.now()})),n=e.created_at,r=t[0].filter(o=>o.created_at<n),s=t[0].filter(o=>o.created_at>=n),i=s.length>0?s.reduce((o,c)=>c.created_at>=o.created_at?c:o):null;for(const o of r)await this.db.delete("events",o.id);return i&&i.created_at>=n?i.id:this.db.add("events",e)}async deleteEventByPublicKey(e){if(!this.db)throw new Error("=> DATABASE: not ready");const n=this.db.transaction("events","readwrite").objectStore("events");let s=await n.index("pubkey").openCursor(e);const i=[];for(;s;){const u=s.value;u.pubkey===e&&(i.push(u.id),await n.delete(u.id)),s=await s.continue()}const c=this.db.transaction("tags","readwrite").objectStore("tags"),a=c.index("value");for(const u of i){let l=await a.openCursor(u);for(;l;){const d=l.value;d.value===u&&await c.delete(d.id),l=await l.continue()}}}async createList(e){if(!this.db)throw new Error("=> DATABASE: not ready");await this.db.add("lists",{...e,id:At()})}async updateList(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");const n=await this.db.get("lists",e);await this.db.put("lists",Object.assign(n,t))}async deleteList(e){if(!this.db)throw new Error("=> DATABASE: not ready");await this.db.delete("lists",e)}async getAllLists(){if(!this.db)throw new Error("=> DATABASE: not ready");const e=await this.db.getAll("lists");return await Promise.all(e.map(async n=>{if(n.userPubkeys){const r=await Promise.all(n.userPubkeys.map(async s=>await this.getUser(s)));return{...n,users:r}}else return n}))}async getList(e){if(!this.db)throw new Error("=> DATABASE: not ready");const t=await this.db.get("lists",e);if(t.userPubkeys){const n=[];for(const r of t.userPubkeys){const s=await this.getUser(r);s&&n.push(s)}return{...t,users:n}}else return t}async getListsWithUser(e){if(!this.db)throw new Error("=> DATABASE: not ready");return this.db.transaction("lists","readonly").objectStore("lists").index("users").getAll(e)}async addUserToList(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");const n=await this.db.get("lists",e);if(n&&n.userPubkeys)if(!n.userPubkeys.includes(t))n.userPubkeys.push(t),await this.updateList(e,n);else throw new Error("User already in list");else n.userPubkeys=[t],await this.updateList(e,n)}async removeUserFromList(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");const n=await this.db.get("lists",e);n&&n.userPubkeys&&(n.userPubkeys=n.userPubkeys.filter(r=>r!==t),await this.updateList(e,n))}async getPopularRelated(e,t){if(!this.db)throw new Error("=> DATABASE: not ready");let i=await this.db.transaction("events","readonly").objectStore("events").index("created_at").openCursor(IDBKeyRange.bound(e,t),"prev"),o=0,c=1e4,a={};for(;i;){o++;const{id:u,tags:l}=i.value,d=l.find(g=>g[0]==="e");if(d&&(a[d[1]]=(a[d[1]]||0)+1),o>c)break;i=await i.continue()}return a=Ue(a,50),a}async calculatePopular(e){const t=Math.round(Date.now()/1e3-(e||Xe*3)),n=Math.round(Date.now()/1e3),r=Date.now();let s={},i={};if(!this.db)throw new Error("=> DATABASE: not ready");const o=await this.getPopularRelated(t,n),a=this.db.transaction("events","readonly").objectStore("events");for(const l of Object.keys(o)){const d=await a.get(l);if(d){const{pubkey:g}=d;s[g]=(s[g]||0)+1,i[l]=(i[l]||0)+1}}s=Ue(s),i=Ue(i);const u=Date.now()-r;return console.log(`=> WORKER: Took ${u}ms to calculate popular`),{users:s,events:i}}},Li=class{constructor(e){this.eventsInMemory=[],this.eventsPublishingQueue=[],this.eventsQueryMemory={},this.popularUsers={},this.popularEvents={},this.status="loading",this.connecting=!1,this.componentStatus={relayClient:!1,database:!1},this.options=e||{},this.db=new Ui,this.eventsInMemory=[],this.eventsPublishingQueue=[],this.lastQuery=void 0,this.lastQueryHasNewerEvents=void 0}updateWorkerStatus(e,t){this.componentStatus[e]=t;let n;if(this.componentStatus.relayClient&&this.componentStatus.database?n="online":this.componentStatus.database?n="offline":n="loading",n!==this.status&&(console.log(`=> WORKER: Status change: ${this.status} => ${n}`),this.status=n,this.options.isInWebWorker)){const r={type:"status:change",data:this.status};postMessage(r)}}async init(){await this.db.init(),this.updateWorkerStatus("database",!0)}setUserPubkey(e){this.userPubkey=e}async connect(e,t){this.connecting=!0,this.relayClient=new ki(e),(t==null?void 0:t.autoLoadInfo)!==!1&&this.relayClient.getRelayInformation(),this.relayClient.listen(async n=>{await this.processEvent(n)}),this.updateWorkerStatus("relayClient",!0)}disconnect(){this.relayClient.disconnect(),this.eventsInMemory=[]}getRelays(){var e;return(e=this.relayClient)!=null&&e.relays?this.relayClient.relays.map(t=>t.getInfo("withInfo")):void 0}updateRelay(e,t){var n;(n=this.relayClient)==null||n.relays.map(r=>{if(r.url===e){typeof t.isEnabled<"u"&&(r.isEnabled=t.isEnabled),typeof t.read<"u"&&(r.read=t.read),typeof t.write<"u"&&(r.write=t.write);return}})}getSubscriptions(e){var t;return(t=this.relayClient)==null?void 0:t.getSubscriptions(e)}updateSubscription(e){var t;(t=this.relayClient)==null||t.updateSubscription(e),postMessage({type:"subscription:update",data:e})}async subscribe(e,t){if(console.log("=> WORKER: subscribe",e),!this.relayClient){console.warn("=> WORKER: Relay client not initialized. Will try again in 1s."),setTimeout(()=>{if(t<10){console.log("WORKER: Not retrying.");return}this.subscribe(e,t+1)},1e3);return}return this==null?void 0:this.relayClient.subscribe(e)}unsubscribe(e){var t;return(t=this.relayClient)==null?void 0:t.unsubscribe(e)}unsubscribeAll(){var e;return(e=this.relayClient)==null?void 0:e.unsubscribeAll()}unsubscribeByToken(e){const t=this.getSubscriptions();if(t)for(const n of t)n.options&&n.options.view===e&&this.unsubscribe([n.id])}async getUser(e){const t=await this.db.getUser(e);return t?{...t,user:new zn(t.user)}:void 0}async addUser(e){await this.db.addUser({...e})}async updateUser(e,t){const n=await this.db.getUser(e);await this.db.updateUser(Object.assign(n,t))}async countUsers(){return await this.db.countUsers()}async followUser(e){const t=await this.db.getUser(e);t&&await this.db.updateUser({...t,following:!0})}async unfollowUser(e){const t=await this.db.getUser(e);t&&await this.db.updateUser({...t,following:!1})}async getAllUsersFollowing(){return await this.db.getUsersByParam("following")}async updateUsersFollowingFromContacts(e){const t=ps(e);if(!t)return;const n=await this.getAllUsersFollowing();let r=[],s=[];if(n&&n.length>0){for(const i of n)t.find(c=>c.key===i.user.pubkey)||r.push(i.user.pubkey);for(const i of t)n.find(c=>c.user.pubkey===i.key)||s.push(i)}else s=t;for(const i of r)await this.unfollowUser(i);for(const i of s)await this.getUser(i.key)?await this.followUser(i.key):await this.addUser({user:new Be({pubkey:i.key}),following:!0,relayUrls:[i.relayUrl]});await this.requestInformation({source:"users",idsOrKeys:t.map(i=>i.key)},{timeoutIn:le})}async lastContactsUpdate(e){const t=await this.db.getEventsByPublicKeysAndKinds(new be({kinds:[B.CONTACTS],authors:[e],since:0,until:Date.now()/1e3}));return t[0].length>0?t[0][0].created_at:void 0}async blockUser(e){const t=await this.db.getUser(e);t&&await this.db.updateUser({...t,isBlocked:!0})}async unblockUser(e){const t=await this.db.getUser(e);t&&await this.db.updateUser({...t,isBlocked:!1})}async getAllUsersBlocked(){return await this.db.getUsersByParam("isBlocked")}async calculatePopular(e){const{users:t,events:n}=await this.db.calculatePopular();this.popularUsers=t,this.popularEvents=n,!(e&&e.isOffline)&&await this.requestInformation({source:"users",idsOrKeys:Object.keys(this.popularUsers)},{timeoutIn:le},[B.METADATA])}popularUsersFromMemory(){let e={};for(const t of this.eventsInMemory)t.user&&(e[t.user.pubkey]?e[t.user.pubkey]+=1:e[t.user.pubkey]=1);return e}async getPopularUsers(){const e=Object.entries(Ue(Zn(this.popularUsers,this.popularUsersFromMemory()))).map(n=>n[0]),t=[];for(const n of e){const r=await this.db.getUser(n);r?t.push(r):t.push({user:new Be({pubkey:n}),relayUrls:[]})}return t||void 0}poularEventsFromMemory(){let e={};for(const t of this.eventsInMemory)e[t.event.id]?e[t.event.id]+=1:e[t.event.id]=1;return e}async getPopularEvents(){const e=Object.entries(Ue(Zn(this.popularEvents,this.poularEventsFromMemory()))).map(n=>n[0]),t=[];for(const n of e){const r=await this.db.getEvent(n);r&&t.push(de(Te(r)))}return t||void 0}async createList(e){return await this.db.createList(e)}async updateList(e,t){return this.db.updateList(e,t)}async deleteList(e){return this.db.deleteList(e)}async getAllLists(){return this.db.getAllLists()}async getList(e){return this.db.getList(e)}async getListsWithUser(e){return this.db.getListsWithUser(e)}async addUserToList(e,t){return this.db.addUserToList(e,t)}async removeUserFromList(e,t){return this.db.removeUserFromList(e,t)}addQueueItems(e){for(const t of e)this.eventsPublishingQueue.find(n=>n.event.id===t.event.id&&n.relayUrl===t.relayUrl)||this.eventsPublishingQueue.push(t)}updateQueueItem(e){this.eventsPublishingQueue=this.eventsPublishingQueue.map(t=>t.event.id===e.event.id&&t.relayUrl===e.relayUrl?e:t)}getQueueItems(){return this.eventsPublishingQueue}async attachUser(e){const t=await this.db.getUser(e.event.pubkey);return{...e,user:t?t.user:void 0}}async attachRelatedEvents(e){var o,c;const t=await this.db.getRelatedEvents(e.event.id,[B.REACTION,B.ZAP_RECEIPT,B.SHORT_TEXT_NOTE]),n=[],r=[],s=[],i=new Set(e.zapReceipts.map(a=>a.id));for(const a of t)switch(a.kind){case B.REACTION:n.push(a);break;case B.SHORT_TEXT_NOTE:r.push(a);break;case B.ZAP_RECEIPT:if(!i.has(a.id)){i.add(a.id);try{const u=(o=a.tags)==null?void 0:o.find(l=>l[0]==="bolt11");if(u){const d=(c=Tt(u[1]).sections.find(g=>g.name==="amount"))==null?void 0:c.value;s.push({id:a.id,pubkey:a.pubkey,amount:d})}}catch(u){console.log("=> WORKER: Error decoding invoice",u)}}break}return e.reactions=[...e.reactions,...n],e.replies=[...e.replies,...r],e.zapReceipts=[...e.zapReceipts,...s],this.attachUser(e)}addEventToMemoryAndFrontend(e,t){if(this.eventsInMemory.push(e),this.options.isInWebWorker){const n={type:"event:new",view:t,data:de(e)};postMessage(n)}}updateEventInMemoryAndFrontend(e,t){const n=this.eventsInMemory.findIndex(r=>r.event.id===e.event.id);if(n!==-1&&(this.eventsInMemory[n]=e,this.options.isInWebWorker)){const r={type:"event:update",view:t,data:de(e)};postMessage(r)}}deleteEventsByPublicKey(e){this.eventsInMemory=this.eventsInMemory.filter(t=>t.event.pubkey!==e),this.db.deleteEventByPublicKey(e)}async _getEventsQueryProcessor({token:e,query:t}){const n=xi(t.filters),r=t.direction||"NEWER",s=r==="NEWER"?n[1]-n[0]:n[0]-n[1],i=t.reqCount?t.reqCount:0,o=t.remainInRange&&t.reqCount?this.eventsQueryMemory[i-1]:void 0,c=this.eventsInMemory.map(m=>m.event.id),a=o?[...o.eventIds,...c]:c,u=await this.db.getEvents(t.filters,{eventIds:a}),l=u[0],d=u[1];l.sort((m,E)=>E.created_at-m.created_at);const g=t.remainInRange?t.remainInRange-l.length:d-l.length;if(l.length>0){this.eventsQueryMemory[i]={eventIds:[...l.map(E=>E.id),...o?o.eventIds:[]]},o&&o.eventIds.length>0&&(this.eventsQueryMemory[i-1]={eventIds:[]});const m=l[l.length-1].created_at;return g>0?{events:l,next:{...t,filters:{...t.filters,since:t.filters.since,until:t.filters.until},reqCount:i+1,prevInterval:s,remainInRange:g,stickyInterval:t.stickyInterval,direction:r}}:{events:l,next:{...t,filters:{...t.filters,since:t.stickyInterval?t.filters.since+s:m,until:t.stickyInterval?t.filters.until+s:m+s},reqCount:i+1,prevInterval:s,stickyInterval:t.stickyInterval,direction:r}}}const A=!t.reqCount||t.reqCount===0,T=A?t.filters.since:t.filters.since+s,w=A?t.filters.until:t.filters.until+s;return{events:[],next:{...t,filters:{...t.filters,since:T,until:w},reqCount:i+1,prevInterval:s,stickyInterval:t.stickyInterval,direction:r}}}async notifyOfNewEvent(e){if(this.lastQuery===void 0||this.lastQueryHasNewerEvents>e.created_at)return;const t=this.lastQuery.query.filters,n=t.since&&t.since>0,r=e.created_at;n&&r>t.until-10*qn&&(this.lastQueryHasNewerEvents=r,this.options.isInWebWorker&&postMessage({type:"event:notify",data:de(Te(e))}))}async getEvents(e){(!e.query.reqCount||e.query.reqCount===0)&&(this.eventsInMemory=[],this.lastQueryHasNewerEvents=void 0),e.query.isOffline===!0?console.warn("=> WORKER: Offline mode"):(console.log("=> WORKER: Online mode"),await this.subscribe(Oi(e))),this.lastQuery=e,console.log("=> WORKER: getEvents",e);const t=await this._getEventsQueryProcessor(e);t.events&&t.events.length>0&&e.query.isOffline!==!0&&await this.processSelectedEvents(t.events,e.token,e.query.isLive);const n=Date.now(),r=[];for(const i of t.events){const o=await this.attachUser(Te(i));this.eventsInMemory.push(o),r.push(de(o))}const s=Date.now();return console.log(`=> WORKER: getEvents: ${t.events.length} events in ${(s-n)/1e3}s`),{...t,token:e.token,events:r}}async getEvent(e,t){let n=this.eventsInMemory.find(r=>r.event.id===e);if(!n){console.log("=> WORKER: Event not found in memory.",this.eventsInMemory.length,n);const r=await this.db.getEvent(e);r&&(n=Te(r))}if(n){await this.requestInformation({source:"events:related",idsOrKeys:[e]},{timeoutIn:le,view:t.view,isLive:!0});const r=await this.db.getUser(n.event.pubkey);return n.user=r?r.user:{pubkey:n.event.pubkey},r||await this.requestInformation({source:"users",idsOrKeys:[n.event.pubkey]},{timeoutIn:le,view:t.view,isLive:!0}),de(n)}if(!n&&(!(t!=null&&t.retryCount)||t.retryCount===0)){if(t.relayUrls)for(const r of t.relayUrls)this.relayClient.relays.find(i=>i.url===r)||this.relayClient.connectRelay({url:r,read:!0,write:!1});console.log("=> WORKER: Event not found in DB, requesting from relay."),await this.subscribe({type:Je.REQ,filters:new be({kinds:[B.SHORT_TEXT_NOTE,B.LONG_FORM_CONTENT],ids:[e]}),options:{timeoutIn:le,view:t!=null&&t.view?t.view:void 0,isLive:!0}});return}}mergeEventWithActive(e,t,n,r){var s,i;if(e.kind===B.ZAP_RECEIPT){const o=new te(e).hasEventTags(),c=o==null?void 0:o.find(u=>u.marker==="root"),a=(s=e.tags)==null?void 0:s.find(u=>u[0]==="bolt11");if(c&&a){for(const u of this.eventsInMemory)if(u.event.id===c.eventId)try{const d=(i=Tt(a[1]).sections.find(A=>A.name==="amount"))==null?void 0:i.value,g={id:e.id,pubkey:e.pubkey,amount:d};if(u.zapReceipts){if(u.zapReceipts.find(A=>A.id===g.id))return;u.zapReceipts.push(g)}else u.zapReceipts=[g];this.updateEventInMemoryAndFrontend(u,n);return}catch(l){console.log("=> WORKER: Error decoding invoice",l)}}}else if(e.kind===B.METADATA){const o={user:new Be,relayUrls:[t]};o.user.fromEvent(e);for(const c of this.eventsInMemory)c.event.pubkey===e.pubkey&&this.updateEventInMemoryAndFrontend({...c,user:o.user,eventRelayUrls:o.relayUrls},n)}else if(e.kind===B.REACTION){const o=new te(e).hasEventTags();if(!o)return;const c=o==null?void 0:o.filter(a=>a.eventId).map(a=>a.eventId);for(const a of this.eventsInMemory){if(!c.includes(a.event.id))continue;const u={id:e.id,pubkey:e.pubkey,content:e.content};if(a.reactions){if(a.reactions.find(l=>l.id===u.id))return;a.reactions.push(u)}else a.reactions=[u];this.updateEventInMemoryAndFrontend(a,n);return}}else if(e.kind===B.REPOST){const o=new te(e).hasEventTags();if(!o)return;const c=o==null?void 0:o.filter(a=>a.eventId).map(a=>a.eventId);for(const a of this.eventsInMemory){if(!c.includes(a.event.id))continue;const u={id:e.id,pubkey:e.pubkey};if(a.reposts){if(a.reposts.find(l=>l.id===u.id))return;a.reposts.push(u)}else a.reposts=[u];this.updateEventInMemoryAndFrontend(a,n);return}}else if(e.kind===B.SHORT_TEXT_NOTE||e.kind===B.LONG_FORM_CONTENT){const c=xn(e)?Rn(e):kn(e);if(c){const a=c==null?void 0:c.find(l=>l.marker==="root");if(a)for(const l of this.eventsInMemory){if(l.event.id!==a.eventId)continue;const d={id:e.id,kind:e.kind,pubkey:e.pubkey,content:e.content,created_at:e.created_at,sig:e.sig};if(l.replies){if(l.replies.find(g=>g.id===d.id))return;l.replies.push(d)}else l.replies=[d];this.updateEventInMemoryAndFrontend(l,n);return}const u=c==null?void 0:c.find(l=>l.marker==="reply");if(u)for(const l of this.eventsInMemory){if(l.event.id!==u.eventId)continue;const d={id:e.id,kind:e.kind,pubkey:e.pubkey,content:e.content,created_at:e.created_at,sig:e.sig};if(l.replies){if(l.replies.find(g=>g.id===d.id))return;l.replies.push(d)}else l.replies=[d];this.updateEventInMemoryAndFrontend(l,n);return}return}r?this.eventsInMemory.find(u=>u.event.id===e.id)||this.getUser(e.pubkey).then(u=>{const l={eventRelayUrls:[t],user:u?u.user:void 0,event:new te(e),reactions:[],reposts:[],badgeAwards:[],replies:[],mentions:[],zapReceipts:[]};this.addEventToMemoryAndFrontend(l,n)}):console.log("=> WORKER: NOT LIVE.",e.id),this.notifyOfNewEvent(e)}}async processRelayNotice(e,t,n){var r,s;if(e===z.OK){const i=t.data[1],o=t.data[2],c=t.data[3],a=this.eventsPublishingQueue.find(u=>u.event.id===i);a&&(this.updateQueueItem({...a,accepted:o,error:o===!1?c:void 0}),this.options.isInWebWorker&&postMessage({type:"relay:message",data:t}));return}else if(e===z.EOSE){n&&this.relayClient.updateSubscription({...n,eose:!0}),this.options.isInWebWorker&&postMessage({type:"relay:message",data:t});return}else if(e===z.COUNT){const i=(r=this.relayClient)==null?void 0:r.getSubscriptions(),o=i==null?void 0:i.find(c=>c.id===t.data[1]);o&&this.relayClient.updateSubscription({...o,result:JSON.stringify(t.data[2])});return}else if(e===z.NOTICE){const i=(s=this.relayClient)==null?void 0:s.getSubscriptions(),o=i==null?void 0:i.find(c=>c.id===t.data[1]);o&&this.relayClient.updateSubscription({...o,result:t.data[1]}),this.options.isInWebWorker&&postMessage({type:"relay:message",data:t});return}else if(e===z.AUTH){this.options.isInWebWorker&&postMessage({type:"relay:message",data:t});return}}async processEvent(e){var i,o,c;if(!e.data){console.log("=> WORKER: No data in payload",e);return}const t=e.data[0];if(t===z.EVENT){const a=e.data[2];if(this.eventsInMemory.find(l=>l.event.id===a.id))return}let n,r,s=!1;if((t===z.COUNT||t===z.EOSE||t===z.EVENT)&&(n=(i=this.relayClient)==null?void 0:i.getSubscription(e.data[1]),r=(o=n==null?void 0:n.options)==null?void 0:o.view,s=((c=n==null?void 0:n.options)==null?void 0:c.isLive)||!1,t===z.EVENT&&!ci(e.data[2]))){console.log("=> WORKER: Invalid event signature",e.data[2]);return}if((t===z.AUTH||t===z.OK||t===z.NOTICE||t===z.COUNT||t===z.EOSE)&&this.processRelayNotice(t,e,n),t===z.EVENT){const a=e.data[2].kind;if(a===B.METADATA){const u=e.data[2],l=new Be;l.fromEvent(u),this.db.getUser(u.pubkey).then(d=>{if(d){if(d.isBlocked)return;this.db.updateUser({...d,user:l})}else{const g={user:l,relayUrls:[e.meta.url]};this.db.addUser(g)}this.mergeEventWithActive(u,e.meta.url,r,s)})}else if(a===B.SHORT_TEXT_NOTE||a===B.LONG_FORM_CONTENT){const u=e.data[2];this.getUser(u.pubkey).then(l=>{(!l||!l.isBlocked)&&this.mergeEventWithActive(u,e.meta.url,r,s),l&&l.following&&this.db.saveEvent(u)})}else if(a===B.ZAP_RECEIPT||a===B.REACTION||a===B.REPOST){const u=e.data[2];this.getUser(u.pubkey).then(l=>{(!l||!l.isBlocked)&&this.mergeEventWithActive(u,e.meta.url,r,s)})}else if(a===B.CONTACTS){const u=e.data[2],l=await this.db.getUser(u.pubkey);if(l&&l.isBlocked)return;this.db.getUser(u.pubkey).then(d=>{d&&d.isBlocked||this.db.saveEventAndDeleteOlderOfType(u).then(g=>{g&&this.updateUsersFollowingFromContacts(u)})})}}}async processSelectedEvents(e,t,n){const r=[],s=[];for(const i of e)r.find(o=>o===i.pubkey)||await this.getUser(i.pubkey)||r.push(i.pubkey),s.find(o=>o===i.id)||s.push(i.id);await this.requestInformation({source:"users",idsOrKeys:r},{timeoutIn:le,view:t,isLive:n}),await this.requestInformation({source:"events:related",idsOrKeys:s},{timeoutIn:le,view:t,isLive:n})}async requestInformation(e,t,n){if(e.idsOrKeys.length===0)return;const r=e.idsOrKeys;console.log(`=> WORKER: Getting information for ${r.length} ${e.source}`,t);const s=[],i=50;for(let o=0;o<r.length;o+=i){const c=r.slice(o,o+i);let a;if(e.source==="events")a=new be({kinds:n||[B.SHORT_TEXT_NOTE,B.LONG_FORM_CONTENT,B.REACTION,B.REPOST,B.ZAP_RECEIPT],ids:c});else if(e.source==="events:related")a=new be({kinds:n||[B.SHORT_TEXT_NOTE,B.REACTION,B.REPOST,B.ZAP_RECEIPT],"#e":c});else if(e.source==="users")a=new be({kinds:n||[B.METADATA],authors:c});else throw new Error("Invalid source");const u=await this.subscribe({type:Je.REQ,filters:a,options:t});u&&s.push(...u)}}async getEventReplies(e,t,n){await this.requestInformation({source:"events:related",idsOrKeys:[e]},{timeoutIn:le,view:t,isLive:n});let r=await this.db.getRelatedEvents(e,[B.SHORT_TEXT_NOTE]).then(i=>Promise.all(i.map(async o=>de(Te(o)))));const s=this.eventsInMemory.find(i=>i.event.id===e);return s&&s.replies&&r.push(...s.replies.map(i=>de(Te(i)))),r=r.filter((i,o,c)=>o===c.findIndex(a=>a.event.id===i.event.id)),r.sort((i,o)=>o.event.created_at-i.event.created_at),r}async sendEvent(e){if(!this.relayClient)throw new Error("Client not initialized");const t=this.relayClient.sendEvent(e);if(t){const n=e.event.kind;[B.SHORT_TEXT_NOTE,B.LONG_FORM_CONTENT,B.RECOMMEND_RELAY,B.REACTION,B.REPOST].includes(n)&&this.mergeEventWithActive(e.event,t[0].relayUrl),this.addQueueItems(t);for(const s of t)this.updateQueueItem({...s});return t}else throw new Error("Failed to send event")}sendQueueItems(e){if(!this.relayClient)throw new Error("Client not initialized");this.addQueueItems(e);const t=this.relayClient.sendQueueItems(e);if(t)return t.map(n=>{this.updateQueueItem({...n})}),t;throw new Error("Failed to send event")}clearEvents(){this.eventsInMemory=[]}};const Pi=new Li({isInWebWorker:!0});Ye(Pi)})();

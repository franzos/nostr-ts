var fi=Object.defineProperty;var di=(Q,J,ae)=>J in Q?fi(Q,J,{enumerable:!0,configurable:!0,writable:!0,value:ae}):Q[J]=ae;var N=(Q,J,ae)=>(di(Q,typeof J!="symbol"?J+"":J,ae),ae);(function(){"use strict";var Q={};Object.defineProperty(Q,"__esModule",{value:!0}),Q.bech32m=pe=Q.bech32=void 0;const J="qpzry9x8gf2tvdw0s3jn54khce6mua7l",ae={};for(let e=0;e<J.length;e++){const t=J.charAt(e);ae[t]=e}function Ae(e){const t=e>>25;return(e&33554431)<<5^-(t>>0&1)&996825010^-(t>>1&1)&642813549^-(t>>2&1)&513874426^-(t>>3&1)&1027748829^-(t>>4&1)&705979059}function kt(e){let t=1;for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);if(r<33||r>126)return"Invalid prefix ("+e+")";t=Ae(t)^r>>5}t=Ae(t);for(let n=0;n<e.length;++n){const r=e.charCodeAt(n);t=Ae(t)^r&31}return t}function Ye(e,t,n,r){let s=0,i=0;const c=(1<<n)-1,o=[];for(let a=0;a<e.length;++a)for(s=s<<t|e[a],i+=t;i>=n;)i-=n,o.push(s>>i&c);if(r)i>0&&o.push(s<<n-i&c);else{if(i>=t)return"Excess padding";if(s<<n-i&c)return"Non-zero padding"}return o}function Un(e){return Ye(e,8,5,!0)}function _n(e){const t=Ye(e,5,8,!1);if(Array.isArray(t))return t}function $n(e){const t=Ye(e,5,8,!1);if(Array.isArray(t))return t;throw new Error(t)}function Bt(e){let t;e==="bech32"?t=1:t=734539939;function n(c,o,a){if(a=a||90,c.length+7+o.length>a)throw new TypeError("Exceeds length limit");c=c.toLowerCase();let u=kt(c);if(typeof u=="string")throw new Error(u);let p=c+"1";for(let d=0;d<o.length;++d){const E=o[d];if(E>>5)throw new Error("Non 5-bit word");u=Ae(u)^E,p+=J.charAt(E)}for(let d=0;d<6;++d)u=Ae(u);u^=t;for(let d=0;d<6;++d){const E=u>>(5-d)*5&31;p+=J.charAt(E)}return p}function r(c,o){if(o=o||90,c.length<8)return c+" too short";if(c.length>o)return"Exceeds length limit";const a=c.toLowerCase(),u=c.toUpperCase();if(c!==a&&c!==u)return"Mixed-case string "+c;c=a;const p=c.lastIndexOf("1");if(p===-1)return"No separator character for "+c;if(p===0)return"Missing prefix for "+c;const d=c.slice(0,p),E=c.slice(p+1);if(E.length<6)return"Data too short";let I=kt(d);if(typeof I=="string")return I;const A=[];for(let y=0;y<E.length;++y){const b=E.charAt(y),v=ae[b];if(v===void 0)return"Unknown character "+b;I=Ae(I)^v,!(y+6>=E.length)&&A.push(v)}return I!==t?"Invalid checksum for "+c:{prefix:d,words:A}}function s(c,o){const a=r(c,o);if(typeof a=="object")return a}function i(c,o){const a=r(c,o);if(typeof a=="object")return a;throw new Error(a)}return{decodeUnsafe:s,decode:i,encode:n,toWords:Un,fromWordsUnsafe:_n,fromWords:$n}}var pe=Q.bech32=Bt("bech32");Q.bech32m=Bt("bech32m");var Ot={};(function(e){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0;function t(l){if(!Number.isSafeInteger(l))throw new Error(`Wrong integer: ${l}`)}e.assertNumber=t;function n(...l){const h=(f,g)=>m=>f(g(m)),w=Array.from(l).reverse().reduce((f,g)=>f?h(f,g.encode):g.encode,void 0),S=l.reduce((f,g)=>f?h(f,g.decode):g.decode,void 0);return{encode:w,decode:S}}function r(l){return{encode:h=>{if(!Array.isArray(h)||h.length&&typeof h[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return h.map(w=>{if(t(w),w<0||w>=l.length)throw new Error(`Digit index outside alphabet: ${w} (alphabet: ${l.length})`);return l[w]})},decode:h=>{if(!Array.isArray(h)||h.length&&typeof h[0]!="string")throw new Error("alphabet.decode input should be array of strings");return h.map(w=>{if(typeof w!="string")throw new Error(`alphabet.decode: not string element=${w}`);const S=l.indexOf(w);if(S===-1)throw new Error(`Unknown letter: "${w}". Allowed: ${l}`);return S})}}}function s(l=""){if(typeof l!="string")throw new Error("join separator should be string");return{encode:h=>{if(!Array.isArray(h)||h.length&&typeof h[0]!="string")throw new Error("join.encode input should be array of strings");for(let w of h)if(typeof w!="string")throw new Error(`join.encode: non-string input=${w}`);return h.join(l)},decode:h=>{if(typeof h!="string")throw new Error("join.decode input should be string");return h.split(l)}}}function i(l,h="="){if(t(l),typeof h!="string")throw new Error("padding chr should be string");return{encode(w){if(!Array.isArray(w)||w.length&&typeof w[0]!="string")throw new Error("padding.encode input should be array of strings");for(let S of w)if(typeof S!="string")throw new Error(`padding.encode: non-string input=${S}`);for(;w.length*l%8;)w.push(h);return w},decode(w){if(!Array.isArray(w)||w.length&&typeof w[0]!="string")throw new Error("padding.encode input should be array of strings");for(let f of w)if(typeof f!="string")throw new Error(`padding.decode: non-string input=${f}`);let S=w.length;if(S*l%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;S>0&&w[S-1]===h;S--)if(!((S-1)*l%8))throw new Error("Invalid padding: string has too much padding");return w.slice(0,S)}}}function c(l){if(typeof l!="function")throw new Error("normalize fn should be function");return{encode:h=>h,decode:h=>l(h)}}function o(l,h,w){if(h<2)throw new Error(`convertRadix: wrong from=${h}, base cannot be less than 2`);if(w<2)throw new Error(`convertRadix: wrong to=${w}, base cannot be less than 2`);if(!Array.isArray(l))throw new Error("convertRadix: data should be array");if(!l.length)return[];let S=0;const f=[],g=Array.from(l);for(g.forEach(m=>{if(t(m),m<0||m>=h)throw new Error(`Wrong integer: ${m}`)});;){let m=0,_=!0;for(let C=S;C<g.length;C++){const M=g[C],O=h*m+M;if(!Number.isSafeInteger(O)||h*m/h!==m||O-M!==h*m)throw new Error("convertRadix: carry overflow");if(m=O%w,g[C]=Math.floor(O/w),!Number.isSafeInteger(g[C])||g[C]*w+m!==O)throw new Error("convertRadix: carry overflow");if(_)g[C]?_=!1:S=C;else continue}if(f.push(m),_)break}for(let m=0;m<l.length-1&&l[m]===0;m++)f.push(0);return f.reverse()}const a=(l,h)=>h?a(h,l%h):l,u=(l,h)=>l+(h-a(l,h));function p(l,h,w,S){if(!Array.isArray(l))throw new Error("convertRadix2: data should be array");if(h<=0||h>32)throw new Error(`convertRadix2: wrong from=${h}`);if(w<=0||w>32)throw new Error(`convertRadix2: wrong to=${w}`);if(u(h,w)>32)throw new Error(`convertRadix2: carry overflow from=${h} to=${w} carryBits=${u(h,w)}`);let f=0,g=0;const m=2**w-1,_=[];for(const C of l){if(t(C),C>=2**h)throw new Error(`convertRadix2: invalid data word=${C} from=${h}`);if(f=f<<h|C,g+h>32)throw new Error(`convertRadix2: carry overflow pos=${g} from=${h}`);for(g+=h;g>=w;g-=w)_.push((f>>g-w&m)>>>0);f&=2**g-1}if(f=f<<w-g&m,!S&&g>=h)throw new Error("Excess padding");if(!S&&f)throw new Error(`Non-zero padding: ${f}`);return S&&g>0&&_.push(f>>>0),_}function d(l){return t(l),{encode:h=>{if(!(h instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return o(Array.from(h),2**8,l)},decode:h=>{if(!Array.isArray(h)||h.length&&typeof h[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(o(h,l,2**8))}}}function E(l,h=!1){if(t(l),l<=0||l>32)throw new Error("radix2: bits should be in (0..32]");if(u(8,l)>32||u(l,8)>32)throw new Error("radix2: carry overflow");return{encode:w=>{if(!(w instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return p(Array.from(w),8,l,!h)},decode:w=>{if(!Array.isArray(w)||w.length&&typeof w[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(p(w,l,8,h))}}}function I(l){if(typeof l!="function")throw new Error("unsafeWrapper fn should be function");return function(...h){try{return l.apply(null,h)}catch{}}}function A(l,h){if(t(l),typeof h!="function")throw new Error("checksum fn should be function");return{encode(w){if(!(w instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const S=h(w).slice(0,l),f=new Uint8Array(w.length+l);return f.set(w),f.set(S,w.length),f},decode(w){if(!(w instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const S=w.slice(0,-l),f=h(S).slice(0,l),g=w.slice(-l);for(let m=0;m<l;m++)if(f[m]!==g[m])throw new Error("Invalid checksum");return S}}}e.utils={alphabet:r,chain:n,checksum:A,radix:d,radix2:E,join:s,padding:i},e.base16=n(E(4),r("0123456789ABCDEF"),s("")),e.base32=n(E(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),i(5),s("")),e.base32hex=n(E(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),i(5),s("")),e.base32crockford=n(E(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),c(l=>l.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=n(E(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),i(6),s("")),e.base64url=n(E(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),i(6),s(""));const y=l=>n(d(58),r(l),s(""));e.base58=y("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=y("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=y("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const b=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode(l){let h="";for(let w=0;w<l.length;w+=8){const S=l.subarray(w,w+8);h+=e.base58.encode(S).padStart(b[S.length],"1")}return h},decode(l){let h=[];for(let w=0;w<l.length;w+=11){const S=l.slice(w,w+11),f=b.indexOf(S.length),g=e.base58.decode(S);for(let m=0;m<g.length-f;m++)if(g[m]!==0)throw new Error("base58xmr: wrong padding");h=h.concat(Array.from(g.slice(g.length-f)))}return Uint8Array.from(h)}};const v=l=>n(A(4,h=>l(l(h))),e.base58);e.base58check=v;const R=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),B=[996825010,642813549,513874426,1027748829,705979059];function T(l){const h=l>>25;let w=(l&33554431)<<5;for(let S=0;S<B.length;S++)(h>>S&1)===1&&(w^=B[S]);return w}function L(l,h,w=1){const S=l.length;let f=1;for(let g=0;g<S;g++){const m=l.charCodeAt(g);if(m<33||m>126)throw new Error(`Invalid prefix (${l})`);f=T(f)^m>>5}f=T(f);for(let g=0;g<S;g++)f=T(f)^l.charCodeAt(g)&31;for(let g of h)f=T(f)^g;for(let g=0;g<6;g++)f=T(f);return f^=w,R.encode(p([f%2**30],30,5,!1))}function x(l){const h=l==="bech32"?1:734539939,w=E(5),S=w.decode,f=w.encode,g=I(S);function m(O,$,W=90){if(typeof O!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof O}`);if(!Array.isArray($)||$.length&&typeof $[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof $}`);const G=O.length+7+$.length;if(W!==!1&&G>W)throw new TypeError(`Length ${G} exceeds limit ${W}`);return O=O.toLowerCase(),`${O}1${R.encode($)}${L(O,$,h)}`}function _(O,$=90){if(typeof O!="string")throw new Error(`bech32.decode input should be string, not ${typeof O}`);if(O.length<8||$!==!1&&O.length>$)throw new TypeError(`Wrong string length: ${O.length} (${O}). Expected (8..${$})`);const W=O.toLowerCase();if(O!==W&&O!==O.toUpperCase())throw new Error("String must be lowercase or uppercase");O=W;const G=O.lastIndexOf("1");if(G===0||G===-1)throw new Error('Letter "1" must be present between prefix and data only');const oe=O.slice(0,G),ce=O.slice(G+1);if(ce.length<6)throw new Error("Data must be at least 6 characters long");const ee=R.decode(ce).slice(0,-6),Se=L(oe,ee,h);if(!ce.endsWith(Se))throw new Error(`Invalid checksum in ${O}: expected "${Se}"`);return{prefix:oe,words:ee}}const C=I(_);function M(O){const{prefix:$,words:W}=_(O,!1);return{prefix:$,words:W,bytes:S(W)}}return{encode:m,decode:_,decodeToBytes:M,decodeUnsafe:C,fromWords:S,fromWordsUnsafe:g,toWords:f}}e.bech32=x("bech32"),e.bech32m=x("bech32m"),e.utf8={encode:l=>new TextDecoder().decode(l),decode:l=>new TextEncoder().encode(l)},e.hex=n(E(4),r("0123456789abcdef"),s(""),c(l=>{if(typeof l!="string"||l.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof l} with length ${l.length}`);return l.toLowerCase()}));const k={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},U=`Invalid encoding type. Available types: ${Object.keys(k).join(", ")}`,D=(l,h)=>{if(typeof l!="string"||!k.hasOwnProperty(l))throw new TypeError(U);if(!(h instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return k[l].encode(h)};e.bytesToString=D,e.str=e.bytesToString;const P=(l,h)=>{if(!k.hasOwnProperty(l))throw new TypeError(U);if(typeof h!="string")throw new TypeError("stringToBytes() expects string");return k[l].decode(h)};e.stringToBytes=P,e.bytes=e.stringToBytes})(Ot);const{bech32:ne,hex:K,utf8:Pn}=Ot,Ct={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},Lt={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},Ut={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},_t={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},Ce=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],Mn={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},Hn=BigInt("2100000000000000000"),$t=BigInt(1e11),Xe={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},Pt={};for(let e=0,t=Object.keys(Xe);e<t.length;e++){const n=t[e],r=Xe[t[e]].toString();Pt[r]=n}const qn={1:e=>K.encode(ne.fromWordsUnsafe(e)),16:e=>K.encode(ne.fromWordsUnsafe(e)),13:e=>Pn.encode(ne.fromWordsUnsafe(e)),19:e=>K.encode(ne.fromWordsUnsafe(e)),23:e=>K.encode(ne.fromWordsUnsafe(e)),27:e=>K.encode(ne.fromWordsUnsafe(e)),6:Le,24:Le,3:zn,5:jn};function Wn(e){return t=>({tagCode:parseInt(e),words:ne.encode("unknown",t,Number.MAX_SAFE_INTEGER)})}function Le(e){return e.reverse().reduce((t,n,r)=>t+n*Math.pow(32,r),0)}function zn(e){const t=[];let n,r,s,i,c,o=ne.fromWordsUnsafe(e);for(;o.length>0;)n=K.encode(o.slice(0,33)),r=K.encode(o.slice(33,41)),s=parseInt(K.encode(o.slice(41,45)),16),i=parseInt(K.encode(o.slice(45,49)),16),c=parseInt(K.encode(o.slice(49,51)),16),o=o.slice(51),t.push({pubkey:n,short_channel_id:r,fee_base_msat:s,fee_proportional_millionths:i,cltv_expiry_delta:c});return t}function jn(e){const t=e.slice().reverse().map(s=>[!!(s&1),!!(s&2),!!(s&4),!!(s&8),!!(s&16)]).reduce((s,i)=>s.concat(i),[]);for(;t.length<Ce.length*2;)t.push(!1);const n={};Ce.forEach((s,i)=>{let c;t[i*2]?c="required":t[i*2+1]?c="supported":c="unsupported",n[s]=c});const r=t.slice(Ce.length*2);return n.extra_bits={start_bit:Ce.length*2,bits:r,has_required:r.reduce((s,i,c)=>c%2!==0?s||!1:s||i,!1)},n}function Mt(e,t){let n,r;if(e.slice(-1).match(/^[munp]$/))n=e.slice(-1),r=e.slice(0,-1);else{if(e.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");r=e}if(!r.match(/^\d+$/))throw new Error("Not a valid human readable amount");const s=BigInt(r),i=n?s*$t/Mn[n]:s*$t;if(n==="p"&&s%BigInt(10)!==BigInt(0)||i>Hn)throw new Error("Amount is outside of valid range");return t?i.toString():i}function Fn(e,t){if(typeof e!="string")throw new Error("Lightning Payment Request must be string");if(e.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");const n=[],r=ne.decode(e,Number.MAX_SAFE_INTEGER);e=e.toLowerCase();const s=r.prefix;let i=r.words,c=e.slice(s.length+1),o=i.slice(-104);i=i.slice(0,-104);let a=s.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(a&&!a[2]&&(a=s.match(/^ln(\S+)$/)),!a)throw new Error("Not a proper lightning payment request");n.push({name:"lightning_network",letters:"ln"});const u=a[1];let p;if(t){if(t.bech32===void 0||t.pubKeyHash===void 0||t.scriptHash===void 0||!Array.isArray(t.validWitnessVersions))throw new Error("Invalid network");p=t}else switch(u){case Ct.bech32:p=Ct;break;case Lt.bech32:p=Lt;break;case Ut.bech32:p=Ut;break;case _t.bech32:p=_t;break}if(!p||p.bech32!==u)throw new Error("Unknown coin bech32 prefix");n.push({name:"coin_network",letters:u,value:p});const d=a[2];let E;if(d){const T=a[3];E=Mt(d+T,!0),n.push({name:"amount",letters:a[2]+a[3],value:E})}else E=null;n.push({name:"separator",letters:"1"});const I=Le(i.slice(0,7));i=i.slice(7),n.push({name:"timestamp",letters:c.slice(0,7),value:I}),c=c.slice(7);let A,y,b,v;for(;i.length>0;){const T=i[0].toString();A=Pt[T]||"unknown_tag",y=qn[T]||Wn(T),i=i.slice(1),b=Le(i.slice(0,2)),i=i.slice(2),v=i.slice(0,b),i=i.slice(b),n.push({name:A,tag:c[0],letters:c.slice(0,1+2+b),value:y(v)}),c=c.slice(1+2+b)}n.push({name:"signature",letters:c.slice(0,104),value:K.encode(ne.fromWordsUnsafe(o))}),c=c.slice(104),n.push({name:"checksum",letters:c});let R={paymentRequest:e,sections:n,get expiry(){let T=n.find(L=>L.name==="expiry");if(T)return B("timestamp")+T.value},get route_hints(){return n.filter(T=>T.name==="route_hint").map(T=>T.value)}};for(let T in Xe)T!=="route_hint"&&Object.defineProperty(R,T,{get(){return B(T)}});return R;function B(T){let L=n.find(x=>x.name===T);return L?L.value:void 0}}var Gn={decode:Fn,hrpToMillisat:Mt};function Qe(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function Zn(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}function Ht(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function Dn(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Qe(e.outputLen),Qe(e.blockLen)}function Nn(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Jn(e,t){Ht(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const we={number:Qe,bool:Zn,bytes:Ht,hash:Dn,exists:Nn,output:Jn},Ke=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qt=e=>e instanceof Uint8Array,et=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),re=(e,t)=>e<<32-t|e>>>t;if(!(new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68))throw new Error("Non little-endian hardware is not supported");Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function Vn(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function tt(e){if(typeof e=="string"&&(e=Vn(e)),!qt(e))throw new Error(`expected Uint8Array, got ${typeof e}`);return e}function Yn(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!qt(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}class Wt{clone(){return this._cloneInto()}}function zt(e){const t=r=>e().update(tt(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function jt(e=32){if(Ke&&typeof Ke.getRandomValues=="function")return Ke.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}function Xn(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),i=BigInt(4294967295),c=Number(n>>s&i),o=Number(n&i),a=r?4:0,u=r?0:4;e.setUint32(t+a,c,r),e.setUint32(t+u,o,r)}class Qn extends Wt{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=et(this.buffer)}update(t){we.exists(this);const{view:n,buffer:r,blockLen:s}=this;t=tt(t);const i=t.length;for(let c=0;c<i;){const o=Math.min(s-this.pos,i-c);if(o===s){const a=et(t);for(;s<=i-c;c+=s)this.process(a,c);continue}r.set(t.subarray(c,c+o),this.pos),this.pos+=o,c+=o,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){we.exists(this),we.output(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:i}=this;let{pos:c}=this;n[c++]=128,this.buffer.subarray(c).fill(0),this.padOffset>s-c&&(this.process(r,0),c=0);for(let d=c;d<s;d++)n[d]=0;Xn(r,s-8,BigInt(this.length*8),i),this.process(r,0);const o=et(t),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=a/4,p=this.get();if(u>p.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)o.setUint32(4*d,p[d],i)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:i,destroyed:c,pos:o}=this;return t.length=s,t.pos=o,t.finished=i,t.destroyed=c,s%n&&t.buffer.set(r),t}}const Kn=(e,t,n)=>e&t^~e&n,er=(e,t,n)=>e&t^e&n^t&n,tr=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ue=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),le=new Uint32Array(64);class Ft extends Qn{constructor(){super(64,32,8,!1),this.A=ue[0]|0,this.B=ue[1]|0,this.C=ue[2]|0,this.D=ue[3]|0,this.E=ue[4]|0,this.F=ue[5]|0,this.G=ue[6]|0,this.H=ue[7]|0}get(){const{A:t,B:n,C:r,D:s,E:i,F:c,G:o,H:a}=this;return[t,n,r,s,i,c,o,a]}set(t,n,r,s,i,c,o,a){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=c|0,this.G=o|0,this.H=a|0}process(t,n){for(let d=0;d<16;d++,n+=4)le[d]=t.getUint32(n,!1);for(let d=16;d<64;d++){const E=le[d-15],I=le[d-2],A=re(E,7)^re(E,18)^E>>>3,y=re(I,17)^re(I,19)^I>>>10;le[d]=y+le[d-7]+A+le[d-16]|0}let{A:r,B:s,C:i,D:c,E:o,F:a,G:u,H:p}=this;for(let d=0;d<64;d++){const E=re(o,6)^re(o,11)^re(o,25),I=p+E+Kn(o,a,u)+tr[d]+le[d]|0,y=(re(r,2)^re(r,13)^re(r,22))+er(r,s,i)|0;p=u,u=a,a=o,o=c+I|0,c=i,i=s,s=r,r=I+y|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,c=c+this.D|0,o=o+this.E|0,a=a+this.F|0,u=u+this.G|0,p=p+this.H|0,this.set(r,s,i,c,o,a,u,p)}roundClean(){le.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class nr extends Ft{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const Ue=zt(()=>new Ft);zt(()=>new nr);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Gt=BigInt(0),_e=BigInt(1),rr=BigInt(2),$e=e=>e instanceof Uint8Array,sr=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function fe(e){if(!$e(e))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=sr[e[n]];return t}function Zt(e){const t=e.toString(16);return t.length&1?`0${t}`:t}function nt(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return BigInt(e===""?"0":`0x${e}`)}function Te(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let r=0;r<n.length;r++){const s=r*2,i=e.slice(s,s+2),c=Number.parseInt(i,16);if(Number.isNaN(c)||c<0)throw new Error("Invalid byte sequence");n[r]=c}return n}function Z(e){return nt(fe(e))}function rt(e){if(!$e(e))throw new Error("Uint8Array expected");return nt(fe(Uint8Array.from(e).reverse()))}function de(e,t){return Te(e.toString(16).padStart(t*2,"0"))}function Dt(e,t){return de(e,t).reverse()}function ir(e){return Te(Zt(e))}function z(e,t,n){let r;if(typeof t=="string")try{r=Te(t)}catch(i){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${i}`)}else if($e(t))r=Uint8Array.from(t);else throw new Error(`${e} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function ye(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!$e(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}function or(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function cr(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function ar(e){let t;for(t=0;e>Gt;e>>=_e,t+=1);return t}function ur(e,t){return e>>BigInt(t)&_e}const lr=(e,t,n)=>e|(n?_e:Gt)<<BigInt(t),st=e=>(rr<<BigInt(e-1))-_e,it=e=>new Uint8Array(e),Nt=e=>Uint8Array.from(e);function Jt(e,t,n){if(typeof e!="number"||e<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=it(e),s=it(e),i=0;const c=()=>{r.fill(1),s.fill(0),i=0},o=(...d)=>n(s,r,...d),a=(d=it())=>{s=o(Nt([0]),d),r=o(),d.length!==0&&(s=o(Nt([1]),d),r=o())},u=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const E=[];for(;d<t;){r=o();const I=r.slice();E.push(I),d+=r.length}return ye(...E)};return(d,E)=>{c(),a(d);let I;for(;!(I=E(u()));)a();return c(),I}}const fr={bigint:e=>typeof e=="bigint",function:e=>typeof e=="function",boolean:e=>typeof e=="boolean",string:e=>typeof e=="string",isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>typeof e=="function"&&Number.isSafeInteger(e.outputLen)};function Be(e,t,n={}){const r=(s,i,c)=>{const o=fr[i];if(typeof o!="function")throw new Error(`Invalid validator "${i}", expected function`);const a=e[s];if(!(c&&a===void 0)&&!o(a,e))throw new Error(`Invalid param ${String(s)}=${a} (${typeof a}), expected ${i}`)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(n))r(s,i,!0);return e}var dr=Object.freeze({__proto__:null,bitGet:ur,bitLen:ar,bitMask:st,bitSet:lr,bytesToHex:fe,bytesToNumberBE:Z,bytesToNumberLE:rt,concatBytes:ye,createHmacDrbg:Jt,ensureBytes:z,equalBytes:or,hexToBytes:Te,hexToNumber:nt,numberToBytesBE:de,numberToBytesLE:Dt,numberToHexUnpadded:Zt,numberToVarBytesBE:ir,utf8ToBytes:cr,validateObject:Be});/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const q=BigInt(0),H=BigInt(1),be=BigInt(2),hr=BigInt(3),ot=BigInt(4),Vt=BigInt(5),Yt=BigInt(8);BigInt(9),BigInt(16);function j(e,t){const n=e%t;return n>=q?n:t+n}function gr(e,t,n){if(n<=q||t<q)throw new Error("Expected power/modulo > 0");if(n===H)return q;let r=H;for(;t>q;)t&H&&(r=r*e%n),e=e*e%n,t>>=H;return r}function V(e,t,n){let r=e;for(;t-- >q;)r*=r,r%=n;return r}function ct(e,t){if(e===q||t<=q)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=j(e,t),r=t,s=q,i=H;for(;n!==q;){const o=r/n,a=r%n,u=s-i*o;r=n,n=a,s=i,i=u}if(r!==H)throw new Error("invert: does not exist");return j(s,t)}function pr(e){const t=(e-H)/be;let n,r,s;for(n=e-H,r=0;n%be===q;n/=be,r++);for(s=be;s<e&&gr(s,t,e)!==e-H;s++);if(r===1){const c=(e+H)/ot;return function(a,u){const p=a.pow(u,c);if(!a.eql(a.sqr(p),u))throw new Error("Cannot find square root");return p}}const i=(n+H)/be;return function(o,a){if(o.pow(a,t)===o.neg(o.ONE))throw new Error("Cannot find square root");let u=r,p=o.pow(o.mul(o.ONE,s),n),d=o.pow(a,i),E=o.pow(a,n);for(;!o.eql(E,o.ONE);){if(o.eql(E,o.ZERO))return o.ZERO;let I=1;for(let y=o.sqr(E);I<u&&!o.eql(y,o.ONE);I++)y=o.sqr(y);const A=o.pow(p,H<<BigInt(u-I-1));p=o.sqr(A),d=o.mul(d,A),E=o.mul(E,p),u=I}return d}}function wr(e){if(e%ot===hr){const t=(e+H)/ot;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(e%Yt===Vt){const t=(e-Vt)/Yt;return function(r,s){const i=r.mul(s,be),c=r.pow(i,t),o=r.mul(s,c),a=r.mul(r.mul(o,be),c),u=r.mul(o,r.sub(a,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return pr(e)}const yr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function br(e){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=yr.reduce((r,s)=>(r[s]="function",r),t);return Be(e,n)}function mr(e,t,n){if(n<q)throw new Error("Expected power > 0");if(n===q)return e.ONE;if(n===H)return t;let r=e.ONE,s=t;for(;n>q;)n&H&&(r=e.mul(r,s)),s=e.sqr(s),n>>=H;return r}function Er(e,t){const n=new Array(t.length),r=t.reduce((i,c,o)=>e.is0(c)?i:(n[o]=i,e.mul(i,c)),e.ONE),s=e.inv(r);return t.reduceRight((i,c,o)=>e.is0(c)?i:(n[o]=e.mul(i,n[o]),e.mul(i,c)),s),n}function at(e,t){const n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function vr(e,t,n=!1,r={}){if(e<=q)throw new Error(`Expected Fp ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:i}=at(e,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const c=wr(e),o=Object.freeze({ORDER:e,BITS:s,BYTES:i,MASK:st(s),ZERO:q,ONE:H,create:a=>j(a,e),isValid:a=>{if(typeof a!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof a}`);return q<=a&&a<e},is0:a=>a===q,isOdd:a=>(a&H)===H,neg:a=>j(-a,e),eql:(a,u)=>a===u,sqr:a=>j(a*a,e),add:(a,u)=>j(a+u,e),sub:(a,u)=>j(a-u,e),mul:(a,u)=>j(a*u,e),pow:(a,u)=>mr(o,a,u),div:(a,u)=>j(a*ct(u,e),e),sqrN:a=>a*a,addN:(a,u)=>a+u,subN:(a,u)=>a-u,mulN:(a,u)=>a*u,inv:a=>ct(a,e),sqrt:r.sqrt||(a=>c(o,a)),invertBatch:a=>Er(o,a),cmov:(a,u,p)=>p?u:a,toBytes:a=>n?Dt(a,i):de(a,i),fromBytes:a=>{if(a.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${a.length}`);return n?rt(a):Z(a)}});return Object.freeze(o)}function Ar(e,t,n=!1){e=z("privateHash",e);const r=e.length,s=at(t).nByteLength+8;if(s<24||r<s||r>1024)throw new Error(`hashToPrivateScalar: expected ${s}-1024 bytes of input, got ${r}`);const i=n?rt(e):Z(e);return j(i,t-H)+H}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Tr=BigInt(0),ut=BigInt(1);function xr(e,t){const n=(s,i)=>{const c=i.negate();return s?c:i},r=s=>{const i=Math.ceil(t/s)+1,c=2**(s-1);return{windows:i,windowSize:c}};return{constTimeNegate:n,unsafeLadder(s,i){let c=e.ZERO,o=s;for(;i>Tr;)i&ut&&(c=c.add(o)),o=o.double(),i>>=ut;return c},precomputeWindow(s,i){const{windows:c,windowSize:o}=r(i),a=[];let u=s,p=u;for(let d=0;d<c;d++){p=u,a.push(p);for(let E=1;E<o;E++)p=p.add(u),a.push(p);u=p.double()}return a},wNAF(s,i,c){const{windows:o,windowSize:a}=r(s);let u=e.ZERO,p=e.BASE;const d=BigInt(2**s-1),E=2**s,I=BigInt(s);for(let A=0;A<o;A++){const y=A*a;let b=Number(c&d);c>>=I,b>a&&(b-=E,c+=ut);const v=y,R=y+Math.abs(b)-1,B=A%2!==0,T=b<0;b===0?p=p.add(n(B,i[v])):u=u.add(n(T,i[R]))}return{p:u,f:p}},wNAFCached(s,i,c,o){const a=s._WINDOW_SIZE||1;let u=i.get(s);return u||(u=this.precomputeWindow(s,a),a!==1&&i.set(s,o(u))),this.wNAF(a,u,c)}}}function Xt(e){return br(e.Fp),Be(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...at(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Sr(e){const t=Xt(e);Be(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:Ir,hexToBytes:Rr}=dr,me={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(e){const{Err:t}=me;if(e.length<2||e[0]!==2)throw new t("Invalid signature integer tag");const n=e[1],r=e.subarray(2,n+2);if(!n||r.length!==n)throw new t("Invalid signature integer: wrong length");if(r[0]&128)throw new t("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return{d:Ir(r),l:e.subarray(n+2)}},toSig(e){const{Err:t}=me,n=typeof e=="string"?Rr(e):e;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new t("Invalid signature tag");if(n[1]!==r-2)throw new t("Invalid signature: incorrect length");const{d:s,l:i}=me._parseInt(n.subarray(2)),{d:c,l:o}=me._parseInt(i);if(o.length)throw new t("Invalid signature: left bytes after parsing");return{r:s,s:c}},hexFromSig(e){const t=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const p=u.toString(16);return p.length&1?`0${p}`:p},r=t(n(e.s)),s=t(n(e.r)),i=r.length/2,c=s.length/2,o=n(i),a=n(c);return`30${n(c+i+4)}02${a}${s}02${o}${r}`}},se=BigInt(0),Y=BigInt(1);BigInt(2);const Qt=BigInt(3);BigInt(4);function kr(e){const t=Sr(e),{Fp:n}=t,r=t.toBytes||((A,y,b)=>{const v=y.toAffine();return ye(Uint8Array.from([4]),n.toBytes(v.x),n.toBytes(v.y))}),s=t.fromBytes||(A=>{const y=A.subarray(1),b=n.fromBytes(y.subarray(0,n.BYTES)),v=n.fromBytes(y.subarray(n.BYTES,2*n.BYTES));return{x:b,y:v}});function i(A){const{a:y,b}=t,v=n.sqr(A),R=n.mul(v,A);return n.add(n.add(R,n.mul(A,y)),b)}if(!n.eql(n.sqr(t.Gy),i(t.Gx)))throw new Error("bad generator point: equation left != right");function c(A){return typeof A=="bigint"&&se<A&&A<t.n}function o(A){if(!c(A))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function a(A){const{allowedPrivateKeyLengths:y,nByteLength:b,wrapPrivateKey:v,n:R}=t;if(y&&typeof A!="bigint"){if(A instanceof Uint8Array&&(A=fe(A)),typeof A!="string"||!y.includes(A.length))throw new Error("Invalid key");A=A.padStart(b*2,"0")}let B;try{B=typeof A=="bigint"?A:Z(z("private key",A,b))}catch{throw new Error(`private key must be ${b} bytes, hex or bigint, not ${typeof A}`)}return v&&(B=j(B,R)),o(B),B}const u=new Map;function p(A){if(!(A instanceof d))throw new Error("ProjectivePoint expected")}class d{constructor(y,b,v){if(this.px=y,this.py=b,this.pz=v,y==null||!n.isValid(y))throw new Error("x required");if(b==null||!n.isValid(b))throw new Error("y required");if(v==null||!n.isValid(v))throw new Error("z required")}static fromAffine(y){const{x:b,y:v}=y||{};if(!y||!n.isValid(b)||!n.isValid(v))throw new Error("invalid affine point");if(y instanceof d)throw new Error("projective point not allowed");const R=B=>n.eql(B,n.ZERO);return R(b)&&R(v)?d.ZERO:new d(b,v,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){const b=n.invertBatch(y.map(v=>v.pz));return y.map((v,R)=>v.toAffine(b[R])).map(d.fromAffine)}static fromHex(y){const b=d.fromAffine(s(z("pointHex",y)));return b.assertValidity(),b}static fromPrivateKey(y){return d.BASE.multiply(a(y))}_setWindowSize(y){this._WINDOW_SIZE=y,u.delete(this)}assertValidity(){if(this.is0()){if(t.allowInfinityPoint)return;throw new Error("bad point: ZERO")}const{x:y,y:b}=this.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not FE");const v=n.sqr(b),R=i(y);if(!n.eql(v,R))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y}=this.toAffine();if(n.isOdd)return!n.isOdd(y);throw new Error("Field doesn't support isOdd")}equals(y){p(y);const{px:b,py:v,pz:R}=this,{px:B,py:T,pz:L}=y,x=n.eql(n.mul(b,L),n.mul(B,R)),k=n.eql(n.mul(v,L),n.mul(T,R));return x&&k}negate(){return new d(this.px,n.neg(this.py),this.pz)}double(){const{a:y,b}=t,v=n.mul(b,Qt),{px:R,py:B,pz:T}=this;let L=n.ZERO,x=n.ZERO,k=n.ZERO,U=n.mul(R,R),D=n.mul(B,B),P=n.mul(T,T),l=n.mul(R,B);return l=n.add(l,l),k=n.mul(R,T),k=n.add(k,k),L=n.mul(y,k),x=n.mul(v,P),x=n.add(L,x),L=n.sub(D,x),x=n.add(D,x),x=n.mul(L,x),L=n.mul(l,L),k=n.mul(v,k),P=n.mul(y,P),l=n.sub(U,P),l=n.mul(y,l),l=n.add(l,k),k=n.add(U,U),U=n.add(k,U),U=n.add(U,P),U=n.mul(U,l),x=n.add(x,U),P=n.mul(B,T),P=n.add(P,P),U=n.mul(P,l),L=n.sub(L,U),k=n.mul(P,D),k=n.add(k,k),k=n.add(k,k),new d(L,x,k)}add(y){p(y);const{px:b,py:v,pz:R}=this,{px:B,py:T,pz:L}=y;let x=n.ZERO,k=n.ZERO,U=n.ZERO;const D=t.a,P=n.mul(t.b,Qt);let l=n.mul(b,B),h=n.mul(v,T),w=n.mul(R,L),S=n.add(b,v),f=n.add(B,T);S=n.mul(S,f),f=n.add(l,h),S=n.sub(S,f),f=n.add(b,R);let g=n.add(B,L);return f=n.mul(f,g),g=n.add(l,w),f=n.sub(f,g),g=n.add(v,R),x=n.add(T,L),g=n.mul(g,x),x=n.add(h,w),g=n.sub(g,x),U=n.mul(D,f),x=n.mul(P,w),U=n.add(x,U),x=n.sub(h,U),U=n.add(h,U),k=n.mul(x,U),h=n.add(l,l),h=n.add(h,l),w=n.mul(D,w),f=n.mul(P,f),h=n.add(h,w),w=n.sub(l,w),w=n.mul(D,w),f=n.add(f,w),l=n.mul(h,f),k=n.add(k,l),l=n.mul(g,f),x=n.mul(S,x),x=n.sub(x,l),l=n.mul(S,h),U=n.mul(g,U),U=n.add(U,l),new d(x,k,U)}subtract(y){return this.add(y.negate())}is0(){return this.equals(d.ZERO)}wNAF(y){return I.wNAFCached(this,u,y,b=>{const v=n.invertBatch(b.map(R=>R.pz));return b.map((R,B)=>R.toAffine(v[B])).map(d.fromAffine)})}multiplyUnsafe(y){const b=d.ZERO;if(y===se)return b;if(o(y),y===Y)return this;const{endo:v}=t;if(!v)return I.unsafeLadder(this,y);let{k1neg:R,k1:B,k2neg:T,k2:L}=v.splitScalar(y),x=b,k=b,U=this;for(;B>se||L>se;)B&Y&&(x=x.add(U)),L&Y&&(k=k.add(U)),U=U.double(),B>>=Y,L>>=Y;return R&&(x=x.negate()),T&&(k=k.negate()),k=new d(n.mul(k.px,v.beta),k.py,k.pz),x.add(k)}multiply(y){o(y);let b=y,v,R;const{endo:B}=t;if(B){const{k1neg:T,k1:L,k2neg:x,k2:k}=B.splitScalar(b);let{p:U,f:D}=this.wNAF(L),{p:P,f:l}=this.wNAF(k);U=I.constTimeNegate(T,U),P=I.constTimeNegate(x,P),P=new d(n.mul(P.px,B.beta),P.py,P.pz),v=U.add(P),R=D.add(l)}else{const{p:T,f:L}=this.wNAF(b);v=T,R=L}return d.normalizeZ([v,R])[0]}multiplyAndAddUnsafe(y,b,v){const R=d.BASE,B=(L,x)=>x===se||x===Y||!L.equals(R)?L.multiplyUnsafe(x):L.multiply(x),T=B(this,b).add(B(y,v));return T.is0()?void 0:T}toAffine(y){const{px:b,py:v,pz:R}=this,B=this.is0();y==null&&(y=B?n.ONE:n.inv(R));const T=n.mul(b,y),L=n.mul(v,y),x=n.mul(R,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql(x,n.ONE))throw new Error("invZ was invalid");return{x:T,y:L}}isTorsionFree(){const{h:y,isTorsionFree:b}=t;if(y===Y)return!0;if(b)return b(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:y,clearCofactor:b}=t;return y===Y?this:b?b(d,this):this.multiplyUnsafe(t.h)}toRawBytes(y=!0){return this.assertValidity(),r(d,this,y)}toHex(y=!0){return fe(this.toRawBytes(y))}}d.BASE=new d(t.Gx,t.Gy,n.ONE),d.ZERO=new d(n.ZERO,n.ONE,n.ZERO);const E=t.nBitLength,I=xr(d,t.endo?Math.ceil(E/2):E);return{CURVE:t,ProjectivePoint:d,normPrivateKeyToScalar:a,weierstrassEquation:i,isWithinCurveOrder:c}}function Br(e){const t=Xt(e);return Be(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function Or(e){const t=Br(e),{Fp:n,n:r}=t,s=n.BYTES+1,i=2*n.BYTES+1;function c(f){return se<f&&f<n.ORDER}function o(f){return j(f,r)}function a(f){return ct(f,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:p,weierstrassEquation:d,isWithinCurveOrder:E}=kr({...t,toBytes(f,g,m){const _=g.toAffine(),C=n.toBytes(_.x),M=ye;return m?M(Uint8Array.from([g.hasEvenY()?2:3]),C):M(Uint8Array.from([4]),C,n.toBytes(_.y))},fromBytes(f){const g=f.length,m=f[0],_=f.subarray(1);if(g===s&&(m===2||m===3)){const C=Z(_);if(!c(C))throw new Error("Point is not on curve");const M=d(C);let O=n.sqrt(M);const $=(O&Y)===Y;return(m&1)===1!==$&&(O=n.neg(O)),{x:C,y:O}}else if(g===i&&m===4){const C=n.fromBytes(_.subarray(0,n.BYTES)),M=n.fromBytes(_.subarray(n.BYTES,2*n.BYTES));return{x:C,y:M}}else throw new Error(`Point of length ${g} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),I=f=>fe(de(f,t.nByteLength));function A(f){const g=r>>Y;return f>g}function y(f){return A(f)?o(-f):f}const b=(f,g,m)=>Z(f.slice(g,m));class v{constructor(g,m,_){this.r=g,this.s=m,this.recovery=_,this.assertValidity()}static fromCompact(g){const m=t.nByteLength;return g=z("compactSignature",g,m*2),new v(b(g,0,m),b(g,m,2*m))}static fromDER(g){const{r:m,s:_}=me.toSig(z("DER",g));return new v(m,_)}assertValidity(){if(!E(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!E(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(g){return new v(this.r,this.s,g)}recoverPublicKey(g){const{r:m,s:_,recovery:C}=this,M=k(z("msgHash",g));if(C==null||![0,1,2,3].includes(C))throw new Error("recovery id invalid");const O=C===2||C===3?m+t.n:m;if(O>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const $=C&1?"03":"02",W=u.fromHex($+I(O)),G=a(O),oe=o(-M*G),ce=o(_*G),ee=u.BASE.multiplyAndAddUnsafe(W,oe,ce);if(!ee)throw new Error("point at infinify");return ee.assertValidity(),ee}hasHighS(){return A(this.s)}normalizeS(){return this.hasHighS()?new v(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Te(this.toDERHex())}toDERHex(){return me.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Te(this.toCompactHex())}toCompactHex(){return I(this.r)+I(this.s)}}const R={isValidPrivateKey(f){try{return p(f),!0}catch{return!1}},normPrivateKeyToScalar:p,randomPrivateKey:()=>{const f=t.randomBytes(n.BYTES+8),g=Ar(f,r);return de(g,t.nByteLength)},precompute(f=8,g=u.BASE){return g._setWindowSize(f),g.multiply(BigInt(3)),g}};function B(f,g=!0){return u.fromPrivateKey(f).toRawBytes(g)}function T(f){const g=f instanceof Uint8Array,m=typeof f=="string",_=(g||m)&&f.length;return g?_===s||_===i:m?_===2*s||_===2*i:f instanceof u}function L(f,g,m=!0){if(T(f))throw new Error("first arg must be private key");if(!T(g))throw new Error("second arg must be public key");return u.fromHex(g).multiply(p(f)).toRawBytes(m)}const x=t.bits2int||function(f){const g=Z(f),m=f.length*8-t.nBitLength;return m>0?g>>BigInt(m):g},k=t.bits2int_modN||function(f){return o(x(f))},U=st(t.nBitLength);function D(f){if(typeof f!="bigint")throw new Error("bigint expected");if(!(se<=f&&f<U))throw new Error(`bigint expected < 2^${t.nBitLength}`);return de(f,t.nByteLength)}function P(f,g,m=l){if(["recovered","canonical"].some(ve=>ve in m))throw new Error("sign() legacy options not supported");const{hash:_,randomBytes:C}=t;let{lowS:M,prehash:O,extraEntropy:$}=m;M==null&&(M=!0),f=z("msgHash",f),O&&(f=z("prehashed msgHash",_(f)));const W=k(f),G=p(g),oe=[D(G),D(W)];if($!=null){const ve=$===!0?C(n.BYTES):$;oe.push(z("extraEntropy",ve,n.BYTES))}const ce=ye(...oe),ee=W;function Se(ve){const Ie=x(ve);if(!E(Ie))return;const On=a(Ie),Re=u.BASE.multiply(Ie).toAffine(),te=o(Re.x);if(te===se)return;const ke=o(On*o(ee+te*G));if(ke===se)return;let Cn=(Re.x===te?0:2)|Number(Re.y&Y),Ln=ke;return M&&A(ke)&&(Ln=y(ke),Cn^=1),new v(te,Ln,Cn)}return{seed:ce,k2sig:Se}}const l={lowS:t.lowS,prehash:!1},h={lowS:t.lowS,prehash:!1};function w(f,g,m=l){const{seed:_,k2sig:C}=P(f,g,m),M=t;return Jt(M.hash.outputLen,M.nByteLength,M.hmac)(_,C)}u.BASE._setWindowSize(8);function S(f,g,m,_=h){var Re;const C=f;if(g=z("msgHash",g),m=z("publicKey",m),"strict"in _)throw new Error("options.strict was renamed to lowS");const{lowS:M,prehash:O}=_;let $,W;try{if(typeof C=="string"||C instanceof Uint8Array)try{$=v.fromDER(C)}catch(te){if(!(te instanceof me.Err))throw te;$=v.fromCompact(C)}else if(typeof C=="object"&&typeof C.r=="bigint"&&typeof C.s=="bigint"){const{r:te,s:ke}=C;$=new v(te,ke)}else throw new Error("PARSE");W=u.fromHex(m)}catch(te){if(te.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(M&&$.hasHighS())return!1;O&&(g=t.hash(g));const{r:G,s:oe}=$,ce=k(g),ee=a(oe),Se=o(ce*ee),ve=o(G*ee),Ie=(Re=u.BASE.multiplyAndAddUnsafe(W,Se,ve))==null?void 0:Re.toAffine();return Ie?o(Ie.x)===G:!1}return{CURVE:t,getPublicKey:B,getSharedSecret:L,sign:w,verify:S,ProjectivePoint:u,Signature:v,utils:R}}class Kt extends Wt{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,we.hash(t);const r=tt(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let c=0;c<i.length;c++)i[c]^=54;this.iHash.update(i),this.oHash=t.create();for(let c=0;c<i.length;c++)i[c]^=106;this.oHash.update(i),i.fill(0)}update(t){return we.exists(this),this.iHash.update(t),this}digestInto(t){we.exists(this),we.bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:i,blockLen:c,outputLen:o}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=c,t.outputLen=o,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const en=(e,t,n)=>new Kt(e,t).update(n).digest();en.create=(e,t)=>new Kt(e,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Cr(e){return{hash:e,hmac:(t,...n)=>en(e,t,Yn(...n)),randomBytes:jt}}function Lr(e,t){const n=r=>Or({...e,...Cr(r)});return Object.freeze({...n(t),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Pe=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Me=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),tn=BigInt(1),He=BigInt(2),nn=(e,t)=>(e+t/He)/t;function rn(e){const t=Pe,n=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),c=BigInt(23),o=BigInt(44),a=BigInt(88),u=e*e*e%t,p=u*u*e%t,d=V(p,n,t)*p%t,E=V(d,n,t)*p%t,I=V(E,He,t)*u%t,A=V(I,s,t)*I%t,y=V(A,i,t)*A%t,b=V(y,o,t)*y%t,v=V(b,a,t)*b%t,R=V(v,o,t)*y%t,B=V(R,n,t)*p%t,T=V(B,c,t)*A%t,L=V(T,r,t)*u%t,x=V(L,He,t);if(!lt.eql(lt.sqr(x),e))throw new Error("Cannot find square root");return x}const lt=vr(Pe,void 0,void 0,{sqrt:rn}),ft=Lr({a:BigInt(0),b:BigInt(7),Fp:lt,n:Me,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=Me,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-tn*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=n,c=BigInt("0x100000000000000000000000000000000"),o=nn(i*e,t),a=nn(-r*e,t);let u=j(e-o*n-a*s,t),p=j(-o*r-a*i,t);const d=u>c,E=p>c;if(d&&(u=t-u),E&&(p=t-p),u>c||p>c)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:d,k1:u,k2neg:E,k2:p}}}},Ue),qe=BigInt(0),sn=e=>typeof e=="bigint"&&qe<e&&e<Pe,Ur=e=>typeof e=="bigint"&&qe<e&&e<Me,on={};function We(e,...t){let n=on[e];if(n===void 0){const r=Ue(Uint8Array.from(e,s=>s.charCodeAt(0)));n=ye(r,r),on[e]=n}return Ue(ye(n,...t))}const dt=e=>e.toRawBytes(!0).slice(1),ht=e=>de(e,32),gt=e=>j(e,Pe),Oe=e=>j(e,Me),pt=ft.ProjectivePoint,_r=(e,t,n)=>pt.BASE.multiplyAndAddUnsafe(e,t,n);function wt(e){let t=ft.utils.normPrivateKeyToScalar(e),n=pt.fromPrivateKey(t);return{scalar:n.hasEvenY()?t:Oe(-t),bytes:dt(n)}}function cn(e){if(!sn(e))throw new Error("bad x: need 0 < x < p");const t=gt(e*e),n=gt(t*e+BigInt(7));let r=rn(n);r%He!==qe&&(r=gt(-r));const s=new pt(e,r,tn);return s.assertValidity(),s}function an(...e){return Oe(Z(We("BIP0340/challenge",...e)))}function $r(e){return wt(e).bytes}function Pr(e,t,n=jt(32)){const r=z("message",e),{bytes:s,scalar:i}=wt(t),c=z("auxRand",n,32),o=ht(i^Z(We("BIP0340/aux",c))),a=We("BIP0340/nonce",o,s,r),u=Oe(Z(a));if(u===qe)throw new Error("sign failed: k is zero");const{bytes:p,scalar:d}=wt(u),E=an(p,s,r),I=new Uint8Array(64);if(I.set(p,0),I.set(ht(Oe(d+E*i)),32),!un(I,r,s))throw new Error("sign: Invalid signature produced");return I}function un(e,t,n){const r=z("signature",e,64),s=z("message",t),i=z("publicKey",n,32);try{const c=cn(Z(i)),o=Z(r.subarray(0,32));if(!sn(o))return!1;const a=Z(r.subarray(32,64));if(!Ur(a))return!1;const u=an(ht(o),dt(c),s),p=_r(c,a,Oe(-u));return!(!p||!p.hasEvenY()||p.toAffine().x!==o)}catch{return!1}}const Mr=(()=>({getPublicKey:$r,sign:Pr,verify:un,utils:{randomPrivateKey:ft.utils.randomPrivateKey,lift_x:cn,pointToBytes:dt,numberToBytesBE:de,bytesToNumberBE:Z,taggedHash:We,mod:j}}))();let ze;const Hr=new Uint8Array(16);function qr(){if(!ze&&(ze=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ze))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ze(Hr)}const F=[];for(let e=0;e<256;++e)F.push((e+256).toString(16).slice(1));function Wr(e,t=0){return(F[e[t+0]]+F[e[t+1]]+F[e[t+2]]+F[e[t+3]]+"-"+F[e[t+4]]+F[e[t+5]]+"-"+F[e[t+6]]+F[e[t+7]]+"-"+F[e[t+8]]+F[e[t+9]]+"-"+F[e[t+10]]+F[e[t+11]]+F[e[t+12]]+F[e[t+13]]+F[e[t+14]]+F[e[t+15]]).toLowerCase()}var ln={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function yt(e,t,n){if(ln.randomUUID&&!t&&!e)return ln.randomUUID();e=e||{};const r=e.random||(e.rng||qr)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){n=n||0;for(let s=0;s<16;++s)t[n+s]=r[s];return t}return Wr(r)}var X=(e=>(e[e.METADATA=0]="METADATA",e[e.SHORT_TEXT_NOTE=1]="SHORT_TEXT_NOTE",e[e.RECOMMEND_RELAY=2]="RECOMMEND_RELAY",e[e.CONTACTS=3]="CONTACTS",e[e.ENCRYPTED_DIRECT_MESSAGES=4]="ENCRYPTED_DIRECT_MESSAGES",e[e.EVENT_DELETION=5]="EVENT_DELETION",e[e.REPOST=6]="REPOST",e[e.REACTION=7]="REACTION",e[e.BADGE_AWARD=8]="BADGE_AWARD",e[e.GENERIC_REPOST=16]="GENERIC_REPOST",e[e.CHANNEL_CREATION=40]="CHANNEL_CREATION",e[e.CHANNEL_METADATA=41]="CHANNEL_METADATA",e[e.CHANNEL_MESSAGE=42]="CHANNEL_MESSAGE",e[e.CHANNEL_HIDE_MESSAGE=43]="CHANNEL_HIDE_MESSAGE",e[e.CHANNEL_MUTE_USER=44]="CHANNEL_MUTE_USER",e[e.FILE_METADATA=1063]="FILE_METADATA",e[e.LIVE_CHAT_MESSAGE=1311]="LIVE_CHAT_MESSAGE",e[e.REPORTING=1984]="REPORTING",e[e.LABEL=1985]="LABEL",e[e.ZAP_REQUEST=9734]="ZAP_REQUEST",e[e.ZAP_RECEIPT=9735]="ZAP_RECEIPT",e[e.MUTE_LIST=1e4]="MUTE_LIST",e[e.PIN_LIST=10001]="PIN_LIST",e[e.RELAY_LIST_METADATA=10002]="RELAY_LIST_METADATA",e[e.WALLET_INFO=13194]="WALLET_INFO",e[e.CLIENT_AUTHENTICATION=22242]="CLIENT_AUTHENTICATION",e[e.WALLET_REQUEST=23194]="WALLET_REQUEST",e[e.WALLET_RESPONSE=23195]="WALLET_RESPONSE",e[e.NOSTR_CONNECT=24133]="NOSTR_CONNECT",e[e.HTTP_AUTH=27235]="HTTP_AUTH",e[e.CATEGORIZED_PEOPLE_LIST=3e4]="CATEGORIZED_PEOPLE_LIST",e[e.CATEGORIZED_BOOKMARK_LIST=30001]="CATEGORIZED_BOOKMARK_LIST",e[e.PROFILE_BADGES=30008]="PROFILE_BADGES",e[e.BADGE_DEFINITION=30009]="BADGE_DEFINITION",e[e.CREATE_OR_UPDATE_A_STALL=30017]="CREATE_OR_UPDATE_A_STALL",e[e.CREATE_OR_UPDATE_A_PRODUCT=30018]="CREATE_OR_UPDATE_A_PRODUCT",e[e.LONG_FORM_CONTENT=30023]="LONG_FORM_CONTENT",e[e.DRAFT_LONG_FORM_CONTENT=30024]="DRAFT_LONG_FORM_CONTENT",e[e.APPLICATION_SPECIFIC_DATA=30078]="APPLICATION_SPECIFIC_DATA",e[e.LIVE_EVENT=30311]="LIVE_EVENT",e[e.CLASSIFIED_LISTING=30402]="CLASSIFIED_LISTING",e[e.DRAFT_CLASSIFIED_LISTING=30403]="DRAFT_CLASSIFIED_LISTING",e[e.HANDLER_RECOMMENDATION=31989]="HANDLER_RECOMMENDATION",e[e.HANDLER_INFORMATION=31990]="HANDLER_INFORMATION",e))(X||{}),fn=(e=>(e.GITHUB="github",e.TWITTER="twitter",e.MASTODON="mastodon",e.TELEGRAM="telegram",e))(fn||{}),he=(e=>(e.AUTH="AUTH",e.COUNT="COUNT",e.EOSE="EOSE",e.EVENT="EVENT",e.NOTICE="NOTICE",e.OK="OK",e))(he||{});function zr(e){return Gn.decode(e)}function jr(e){let t=0;for(let n=0;n<e.length;n++){const r=parseInt(e[n],16);if(r===0)t+=4;else{t+=Math.clz32(r)-28;break}}return t}function Fr(e){const t=e.tags.filter(r=>r[0]==="amount");if(t.length===0)return;const n=[];for(const r of t)r.length>0&&n.push(r[1]);return n&&n.length>0?n:void 0}function Gr(e){return["amount",e]}function Zr(e){let t=!1,n="";for(const r of e.tags)r.find(i=>i==="content-warning")&&(t=!0,r.length===2&&r[0]==="content-warning"&&(n=r[1]),r.length===3&&r[2]==="content-warning"&&r[0]==="l"&&(n=r[1]));if(t)return n}function Dr(e){return/^(wss?):\/\/([a-zA-Z0-9.-]+)(:\d+)?(\/[a-zA-Z0-9_/.-]*)?$/.test(e)}function Nr(e,t){if(!dn(e,t))return;const n=/(.*)?(wss:\/\/[a-zA-Z0-9.-]+)/,r=/(nostr:[a-fA-F0-9]{64})/g;let s;if(s=n.exec(e),s){const o=s[1]?s[1].trim():void 0;return{type:"relayUrl",relayUrl:s[2],message:o}}let i,c=[];for(;(i=r.exec(e))!==null;)c.push(i[1].split(":")[1]);if(c.length>0){const o=e.replace(r,"").trim();return{type:"nostr",publicKeys:c,message:o}}}function Jr(e){if(e.type){if(e.type==="relayUrl")return e.relayUrl;if(e.type==="nostr"){if(!e.publicKeys)return e.message;for(const n of e.publicKeys)if(n.length!==64)throw new Error(`Invalid key length: ${n}`);const t=e.publicKeys.map(n=>`nostr:${n}`).join(" ");return e.message?`${e.message} ${t}`:t}}else return e.message}function dn(e,t){if(!e||e==="")return{isValid:!0};if(t===6)try{return JSON.parse(e),{isValid:!0}}catch(n){return console.error(n),{isValid:!1,error:"Invalid JSON format"}}else if(t===2&&!Dr(e))return{isValid:!1,error:`Expected a valid websocket URL, got ${e}.`};return Vr(e)?{isValid:!1,error:"HTML tags are not allowed"}:Yr(e)?{isValid:!1,error:"Line breaks are not allowed"}:{isValid:!0}}function Vr(e){return/<[^>]*>/.test(e)}function Yr(e){return e.includes(`
`)}function Xr(e){const t=Kr(e.tags);if(t)return t}function Qr(e){const{kind:t,pubkey:n,identifier:r,relay:s}=e;return s?[`a:${t}:${n}:${r}, ${s}`]:[`a:${t}:${n}:${r}`]}function Kr(e){if(!e)return;let t=[];for(let n of e){if(!Array.isArray(n)||n.length<2||n.length>3||n[0]!=="a")continue;let r=n[1].split(":");if(r.length!==3)continue;let s=r[0],i=r[1],c=r[2],o;n.length===3&&(o=n[2]),t.push({kind:s,pubkey:i,identifier:c,relay:o})}if(t.length!==0)return t}function es(e){const t=e.tags.filter(n=>n[0]==="expiration");if(t.length!==0)return parseInt(t[0][1])}function ts(e){const t=[],n=e.tags.filter(r=>r[0]==="d");if(n.length!==0){for(const r of n){let s=r[1]||"";t.includes(s)||t.push(s)}return t&&t.length>0?t:void 0}}function ns(e){return["d",e]}function rs(e){const t=e.tags.filter(r=>r[0]==="lnurl");if(t.length===0)return;const n=[];for(const r of t)r.length>0&&n.push(r[1]);return n&&n.length>0?n:void 0}function ss(e){return["lnurl",e]}function is(e){const t=e.tags.filter(n=>n[0]==="nonce");if(t.length!==0)return[parseInt(t[0][1]),parseInt(t[0][2])]}function os(e){const t=e.tags.filter(r=>r[0]==="p");if(t.length===0)return;const n=[];for(const r of t)n.push(r[1]);return n}function cs(e){const t=e.tags.filter(r=>r[0]==="relays");if(t.length===0)return;const n=[];for(const r of t){const s=r.splice(1);n.push(s)}return n}function as(e){if(e.kind!==1984)throw new Error(`Event is not a report: ${e.kind}. Expected 1984.`);const t=e.tags.filter(o=>o[0]==="p");if(!t||t.length===0)return;let n;const r=e.tags.filter(o=>o[0]==="e");r.length>0&&r[0].length>0&&(n=r[0][1]);let s;t[0].length===3?s=t[0][2]:r.length>0&&r[0].length===3&&(s=r[0][2]);let i;return t[0].length>0&&(i=t[0][1]),!s||!i?void 0:{eventId:n,kind:s,publicKey:i,content:e.content&&e.content!==""?e.content:void 0}}function us(e){const{eventId:t,kind:n,publicKey:r}=e;if(!n)throw new Error("Report must have a kind.");if(!r)throw new Error("Report must mention a public key.");if(n==="impersonation"&&t)throw new Error("Impersonation reports should refer to a person, not an event.");const s=[];return t?(s.push(["e",t,n]),r&&s.push(["p",r])):r&&s.push(["p",r,n]),s}function ls(e){const t=e.tags.filter(n=>n[0]==="subject");if(t.length!==0)return t[0][1]}function fs(e){return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}var ds=new TextEncoder;new TextDecoder("utf-8");function hs(e){const t=Ue(ds.encode(e));return fe(t)}function gs({callback:e,amount:t,event:n,lnurl:r}){return`${e}?amount=${t}&nostr=${n}&lnurl=${r}`}function ps(e){if(e.allowsNostr&&e.nostrPubkey)return!0}function ws(e,t){const n=e.amount?e.amount:void 0,r=e.lnurl?e.lnurl:void 0;if(!n||!r)return!0;const s=zr(t.pr);let i;const c=s.sections.find(o=>o.name==="amount");if(c)i=c.value;else return!1;return!(n&&n.toString()!==i)}function ys(e){const t=new ie(e),n=t.hasPublicKeyTags();if(!n)throw new Error("No pubkey tags found");if(e.kind!==9734)throw new Error("Event is not a zap request");const r=n[0],s=t.hasRelaysTag(),i={pubkey:r,content:"",id:t.id,sig:t.sig,kind:t.kind,tags:t.tags,relays:s};return JSON.stringify(i)}var bs=new TextEncoder,hn=new TextDecoder;function ms(e){let t=/,*?((lnurl)([0-9]{1,}[a-z0-9]+){1})/.exec(e.toLowerCase());return t?t[1]:null}function Es(e){if(e=e.trim(),e.toLowerCase().slice(0,6)==="lnurl1"){const{words:t}=pe.decode(e,2e4),n=new Uint8Array(pe.fromWords(t));return hn.decode(n)}else if(e.slice(0,9)==="lnurlc://"||e.slice(0,9)==="lnurlw://"||e.slice(0,9)==="lnurlp://"||e.slice(0,10)==="keyauth://"){let[t,n]=e.split("://");return(n.match(/\.onion($|\W)/)?"http":"https")+"://"+n}else if(e.slice(0,8)==="https://"){let t=ms(e);if(t){const{words:n}=pe.decode(t,2e4),r=new Uint8Array(pe.fromWords(n));return hn.decode(r)}return e}throw new Error(`invalid url ${e}`)}function vs(e){const t=bs.encode(e),n=pe.toWords(new Uint8Array(t));return pe.encode("lnurl",n,2e4)}function gn(e){return e.endsWith(".onion")}function As(e){const[t,n]=e.split("@");return`${gn(n)?"http":"https"}://${n}/.well-known/lnurlp/${t}`}function Ts(e){const[t,n]=e.split("@");return`${gn(n)?"http":"https"}://${n}/.well-known/nostr.json?name=${t}`}function pn(e){return/^[a-z0-9\.\-_\/@]*$/.test(e)}function xs(e){return e.toLowerCase()}function Ss(e,t){const n=Mr.sign(e,t);return fe(n)}function Is(e){try{const t=JSON.parse(e);return{name:t.name??null,display_name:t.display_name??null,picture:t.picture??null,banner:t.banner??null,nip05:t.nip05??null,website:t.website??null,about:t.about??null,image:t.image??null,npub:t.npub??null,lud16:t.lud16??null,lud06:t.lud06??null}}catch(t){return console.error("Unable to parse user metadata string",t),null}}var Rs=class{constructor(e){if(e){if(!pn(e.identity))throw new Error("Invalid identity. Valid: a-z, 0-9, -, _, @");this.type=e.type,this.identity=xs(e.identity),this.proof=e.proof}}toTag(){switch(this.type){case"github":return["i",`github:${this.identity}`,this.proof];case"twitter":return["i",`twitter:${this.identity}`,this.proof];case"mastodon":return["i",`mastodon:${this.identity}`,this.proof];case"telegram":return["i",`telegram:${this.identity}`,this.proof];default:throw new Error(`Unknown claim type ${this.type}. Valid: github, twitter, mastodon, telegram`)}}fromTag(e){if(wn(e))return this.type=e[1].split(":")[0],this.identity=e[1].split(":")[1],this.proof=e[2],this}};function wn(e){return!(e.length!==3||!Object.values(fn).includes(e[1].split(":")[0])||!pn(e[1].split(":")[1]))}function yn(e){const t=e.tags.filter(r=>r[0]==="i"&&wn(r));if(t.length===0)return;const n=[];for(const r of t){const s=new Rs;s.fromTag(r),n.push(s)}return n}var ie=class{constructor(e){this.id=e.id?e.id:"",this.pubkey=e.pubkey?e.pubkey:"",this.created_at=e.created_at?e.created_at:Math.floor(Date.now()/1e3),this.kind=e.kind!=null?e.kind:1,this.tags=e.tags&&e.tags.length>0?e.tags:[],this.content=e.content,this.sig=e.sig?e.sig:""}generateId(){if(this.pubkey==="")throw new Error("Cannot generate event ID without a public key");const e=fs(this.toJson());this.id=hs(e)}sign(e){this.pubkey=e.publicKey,this.sig=Ss(this.id,e.privateKey)}signAndGenerateId(e){this.sign(e),this.generateId()}toJson(){const e={};for(const[t,n]of Object.entries(this))n!==void 0&&(e[t]=n);return e}toURI(){return encodeURI(JSON.stringify(this.toJson()))}proofOfWork(e){let t=0;for(;;){if(this.replaceNonceTag([e,t]),this.generateId(),jr(this.id)>=e){console.log("Proof of work complete");break}t++}}mentionUsers(e){if(!this.extractContent())this.content=Jr({message:this.content,publicKeys:e});else throw new Error("Already has motified content")}hasMentions(){const e=this.extractContent();if(!(!e||!e.publicKeys||e.publicKeys.length<1))return e.publicKeys}setContentWithoutChecks(e){return this.content=e,this}extractContent(){return Nr(this.content,this.kind)}addTag(e){this.tags||(this.tags=[]),this.tags.push(e)}removeTag(e){this.tags&&(this.tags=this.tags.filter(t=>t[0]!==e[0]&&t[1]!==e[1]))}addEventTag(e,t){const n=["e",e];t&&(n[1]=`${n[1]}, ${t}`),this.addTag(n)}hasEventTags(){const e=this.tags.filter(t=>t[0]==="e");if(e.length!==0)return e.map(t=>{const n=t[1].split(","),r=n[0].trim(),s=n[1]?n[1].trim():void 0;return{eventId:r,relayUrl:s}})}addPublicKeyTag(e,t){const n=["p",e];t&&(n[1]=`${n[1]}, ${t}`),this.addTag(n)}hasPublicKeyTags(){return os(this)}addRelaysTag(e){const t=this.tags.filter(n=>n[0]==="relays");if(t.length===0)this.tags.push(["relays",...e]);else for(const n of t)n.splice(1,0,...e)}hasRelaysTag(){return cs(this)}addEventCoordinatesTag(e){this.addTag(Qr(e))}hasEventCoordinatesTags(){return Xr(this)}addIdentifierTag(e){this.addTag(ns(e))}hasIdentifierTags(){return ts(this)}addLnurlTag(e){this.addTag(ss(e))}hasLnurlTags(){return rs(this)}addAmountTag(e){this.addTag(Gr(e))}hasAmountTags(){return Fr(this)}addKindTag(e){this.addTag(["k",e.toString()])}addExpirationTag(e){if(this.hasExpirationTag())throw new Error("Event already has an expiration.");this.addTag(["expiration",e.toString()])}hasExpirationTag(){return es(this)}addSubjectTag(e){if(this.kind!==1)throw new Error(`Event kind ${this.kind} should not have a subject.`);if(this.hasSubjectTag())throw new Error("Event already has a subject.");this.addTag(["subject",e])}hasSubjectTag(){return ls(this)}addNonceTag(e){if(this.hasNonceTag())throw new Error("Event already has a nonce.");if(e.length!==2)throw new Error("Nonce must be an array of 2 numbers: [miningResult, difficulty]");const t=e[0].toString(),n=e[1].toString();this.addTag(["nonce",t,n])}hasNonceTag(){return is(this)}replaceNonceTag(e){this.hasNonceTag()&&(this.tags=this.tags.filter(n=>n[0]!=="nonce")),this.addNonceTag(e)}addContentWarningTag(e){if(this.hasContentWarningTag())throw new Error("Event already has a content warning.");this.addTag(["content-warning",e||""])}hasContentWarningTag(){return Zr(this)}addExternalIdentityClaimTag(e){this.addTag(e.toTag())}hasExternalIdentityClaimTag(){return yn(this)}addReportTags(e){if(this.kind!==1984)throw new Error(`Event kind ${this.kind} should not have a report. Expected 1984.`);if(this.hasReportTags())throw new Error("Event already has report tags.");us(e).forEach(n=>this.addTag(n))}hasReportTags(){return as(this)}newZapReceipt(e){if(this.kind!==9734)throw new Error(`Event kind ${this.kind} should not have a zap receipt. Expected 9734.`);return Os({bolt11:e.bolt11,description:e.description,preimage:e.preimage,zapRequest:this})}determineRequiredNIP(){const e=[];return this.hasExternalIdentityClaimTag()&&e.push(39),this.hasExpirationTag()&&e.push(40),e}isReadyToPublish(){if(this.id==="")return{isReady:!1,reason:"Event has no ID."};if(this.pubkey==="")return{isReady:!1,reason:"Event has no pubkey."};if(this.sig==="")return{isReady:!1,reason:"Event has no signature."};const e=dn(this.content,this.kind);return e.isValid?{isReady:!0}:{isReady:!1,reason:e.error}}isReadyToPublishOrThrow(){const e=this.isReadyToPublish();if(!e.isReady)throw new Error(e.reason)}};function ks(e){const t=new ie({content:"",kind:9734});return t.addRelaysTag(e.relayUrls),t.addAmountTag(e.amount.toString()),t.addLnurlTag(e.lnurl),t.addPublicKeyTag(e.recipientPubkey),e.eventId&&t.addEventTag(e.eventId),t}function Bs(e,t,n){const r=ks(e);r.signAndGenerateId(n);const s=r.toURI();return{event:r,eventUri:s,invoiceUrl:gs({callback:t,amount:e.amount,event:s,lnurl:e.lnurl})}}function Os(e){const t=e.zapRequest.tags.find(i=>i[0]==="p"),n=e.zapRequest.tags.find(i=>i[0]==="e"),r=ys(e.zapRequest),s=new ie({content:"",kind:9735,tags:[t,["bolt11",e.bolt11],["description",r]],created_at:e.zapRequest.created_at});return n&&s.addEventTag(n[1]),e.preimage&&s.addTag(["preimage",e.preimage]),s}var je=class{constructor(e){this.ids=e==null?void 0:e.ids,this.authors=e==null?void 0:e.authors,this.kinds=e==null?void 0:e.kinds,this["#e"]=e==null?void 0:e["#e"],this["#p"]=e==null?void 0:e["#p"],this.since=e==null?void 0:e.since,this.until=e==null?void 0:e.until,this.limit=e==null?void 0:e.limit}addId(e){this.ids||(this.ids=[]),this.ids.push(e)}addAuthor(e){this.authors||(this.authors=[]),this.authors.push(e)}addKind(e){this.kinds||(this.kinds=[]),this.kinds.push(e)}updateLimit(e){this.limit=e}toJson(){return JSON.parse(JSON.stringify(this))}},Cs=class{constructor(e){this.commands=[],this.subscriptions=[],this.id=e.id?e.id:yt(),this.url=e.url,this.read=e.read,this.write=e.write,this.requiresPOW=0,this.info=e.info,this.isEnabled=!0}isConnected(){return this.ws!==void 0&&this.ws.isConnected()}supportsEvent(e){var s;const t=e.determineRequiredNIP();console.log(`Required NIP: ${t.join(", ")}`);const n=((s=this.info)==null?void 0:s.supported_nips)||[];return console.log(`Supported NIP: ${n.join(", ")}`),t.every(i=>n.includes(i))}supportsEventOrThrow(e){if(!this.supportsEvent(e))throw new Error(`Event ${e.id} is not supported by relay ${this.id}`)}addCommand(e){this.commands.push(e)}updateCommandFromRelayMessage(e){if(e.data[0]==="COUNT"){const t=this.commands.findIndex(n=>n.subscriptionId===e.data[1]&&n.response==null);t!==-1&&(this.commands[t].response=e.data[2],this.commands[t].success=!0)}else if(e.data[0]==="NOTICE"){const t=this.commands.findIndex(n=>n.eventId&&n.response==null);t!==-1&&(this.commands[t].response=e.data[1])}else if(e.data[0]==="OK"){const t=this.commands.findIndex(n=>n.eventId===e.data[1]&&n.response==null);t!==-1&&(this.commands[t].response=e.data[3],this.commands[t].success=e.data[2])}}addSubscription(e){this.subscriptions.push(e)}removeSubscription(e){this.subscriptions=this.subscriptions.filter(t=>t.subscriptionId!==e)}hasSubscription(e){return this.subscriptions.find(t=>t.subscriptionId===e)!==void 0}getSubscription(e){const t=this.subscriptions.find(n=>n.subscriptionId===e);return t||null}getInfo(e){return e==="default"?{id:this.id,url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW}:{id:this.id,url:this.url,read:this.read,write:this.write,powRequired:this.requiresPOW,info:this.info}}},Ls=class{constructor(e){this.relays=[],this.addInitialRelays(e)}addInitialRelays(e){if(e&&(!this.relays||this.relays.length===0))for(const t of e)this.relays.push(new Cs(t))}sendSubscribe(e,t,n){var i;const r=JSON.stringify([e.type,e.subscriptionId,e.filters]),s=[];for(const c of this.relays)if(c.isEnabled){if(e.type==="COUNT"){const o=(i=c.info)==null?void 0:i.supported_nips;if(o&&!o.includes(45)){console.warn(`Relay ${c.id} does not support count command.`);continue}}try{c.ws.sendMessage(r);const o={url:c.url,connectionId:c.id,subscriptionId:t,type:e.type,filters:e.filters,options:{timeoutAt:n==null?void 0:n.timeoutAt,timeout:n==null?void 0:n.timeout,view:n==null?void 0:n.view}};c.addSubscription(o),s.push(o)}catch(o){console.error(o)}}return s}subscribe(e){const t=(e==null?void 0:e.subscriptionId)||yt(),n=e!=null&&e.filters?e.filters.toJson():{};console.log("=> Subscribing to events",e,t);const r={type:"REQ",subscriptionId:t,filters:n};return this.sendSubscribe(r,t,e==null?void 0:e.options)}count(e){const t=(e==null?void 0:e.subscriptionId)||yt(),n=e!=null&&e.filters?e.filters.toJson():{},r={type:"COUNT",subscriptionId:t,filters:n},s=this.sendSubscribe(r,t,e==null?void 0:e.options);for(const i of s){const c=this.relays.find(o=>o.id===i.connectionId);c&&c.addCommand({connectionId:i.connectionId,subscriptionId:i.subscriptionId,request:r})}return s}unsubscribe(e,t){const n={type:"CLOSE",subscriptionId:e},r=JSON.stringify([n.type,n.subscriptionId]);for(const s of this.relays)if(s.isEnabled&&(t&&s.id===t||!t)){const i=s.getSubscription(e);if(i){i.options&&i.options.timeout&&clearTimeout(i.options.timeout);try{s.ws.sendMessage(r),s.removeSubscription(e)}catch(c){console.error(c)}}}}unsubscribeAll(){for(const e of this.relays){if(e.isConnected())continue;const t=e.subscriptions.map(n=>n.subscriptionId);for(const n of t)this.unsubscribe(n,e.id)}}getSubscriptions(){const e=[];for(const t of this.relays)e.push(...t.subscriptions);return e}countSubscriptions(){let e=0;for(const t of this.relays)e+=t.subscriptions.length;return e}countConnections(){let e=0;for(const t of this.relays)t.isConnected()&&e++;return e}countCommands(){let e=0,t=0;for(const n of this.relays)e+=n.commands.length,t+=n.commands.filter(r=>r.response!==null).length;return{total:e,completed:t}}sendEvent(e,t){const n={type:"EVENT",data:e},r=JSON.stringify([n.type,n.data]),s=[],c=(t?this.relays.filter(o=>t.includes(o.id)):this.relays).filter(o=>o.isEnabled&&o.write);if(c.length===0){console.log("No relays enabled, not sending event",e);return}console.log(`Sending event ${e.id} to ${c.length} relays`,e);for(const o of c)o.isEnabled&&(o.supportsEvent(e)?(o.ws.sendMessage(r),o.addCommand({connectionId:o.id,eventId:e.id,request:n}),s.push({eventId:e.id,relay:o.getInfo("default"),error:null}),console.log(`Sent event to ${o.url}`,n)):(console.log(`Event ${e.id} not published to ${o.url} because not all needed NIPS are supported`,n),s.push({eventId:e.id,relay:o.getInfo("withInfo"),error:`Event ${e.id} not published to ${o.url} because not all needed NIPS are supported`})));if(s.length!==0)return s}listen(e){for(const t of this.relays)t.isEnabled&&t.ws.listen(n=>{t.updateCommandFromRelayMessage({data:n}),e({data:n,meta:t.getInfo("default")})})}disconnect(){var r;const{completed:e,total:t}=this.countCommands(),n={commands:{total:t,completed:e},subscriptions:this.countSubscriptions(),connections:this.countConnections()};console.log(`
Stats:
- Commands: ${n.commands.completed}/${n.commands.total}
- Subscriptions: ${n.subscriptions}
- Connections: ${n.connections}
    `);for(const s of this.relays)(r=s.ws)==null||r.disconnect()}},bt=class{constructor(e){this.pubkey=(e==null?void 0:e.pubkey)||void 0,this.claims=(e==null?void 0:e.claims)||[],this.data=(e==null?void 0:e.data)||{},this.lastUpdated=(e==null?void 0:e.lastUpdated)||0}loaded(){return this.data!==void 0}hasZapInfo(){return this.lightningZapInfo!==void 0}fromPublicKey(e){return this.pubkey=e,this}fromEvent(e,t=!0){const n=new ie(e);if(n.kind!==0){if(t)throw new Error("wrong event kind");return}if(this.pubkey&&this.pubkey!==""&&n.pubkey!==this.pubkey){if(t)throw new Error("wrong event pubkey");return}if(this.pubkey=n.pubkey,this.lastUpdated=n.created_at,n.content&&n.content!==""){const s=Is(n.content);s&&(this.data=s)}const r=yn(e);return r&&(this.claims=r),this}getNip05Url(){var t;const e=((t=this.data)==null?void 0:t.nip05)||void 0;if(e)return Ts(e)}validateWellKnown(e){return e?Object.keys(e.names).find(n=>e.names[n]===this.pubkey)?(this.nip05isValid=!0,!0):(this.nip05isValid=!1,!1):!1}getLud16(){var e;return((e=this.data)==null?void 0:e.lud16)||void 0}getLud16Url(){const e=this.getLud16();if(e)return As(e)}getLud06(){var e;return((e=this.data)==null?void 0:e.lud06)||void 0}getLud06Url(){const e=this.getLud06();if(e)return Es(e)}getLud16Or06(){const e=this.getLud06();if(e)return{type:"lud06",url:e};const t=this.getLud16();if(t)return{type:"lud16",url:t}}getLud16Or06Url(){const e=this.getLud06Url();if(e)return{type:"lud06",url:e};const t=this.getLud16Url();if(t)return{type:"lud16",url:t}}getMetadataFilter(){const e=new je;return e.addAuthor(this.pubkey),e.addKind(0),e}toJson(){return{pubkey:this.pubkey,claims:this.claims,data:this.data,lightningZapInfo:this.lightningZapInfo,lastUpdated:this.lastUpdated,nip05isValid:this.nip05isValid}}fromJson(e){return this.pubkey=e.pubkey,this.claims=e.claims,this.data=e.data,this.lightningZapInfo=e.lightningZapInfo,this.lastUpdated=e.lastUpdated,this.nip05isValid=e.nip05isValid,this}},Us=class{constructor(){}connect(e){this.connection=new WebSocket(e)}isConnected(){return this.connection&&this.connection.readyState===this.connection.OPEN}sendMessage(e,t){const n=t||{retries:10,retryTimeout:100,retryCount:0};if(this.isConnected())this.connection.send(e);else{const r=n.retryCount+1;if(r===10)throw new Error(`Could not send message after ${r} retries`);setTimeout(()=>this.sendMessage(e,n),100)}}listen(e){this.connection.onmessage=t=>{e(JSON.parse(t.data))}}disconnect(){this.connection.close()}};async function Fe(e,t){try{let n=await Promise.race([fetch(e,{headers:t}),new Promise((s,i)=>setTimeout(()=>i(new Error("Timeout")),5e3))]);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(n){throw new Error(`Error making request: ${n}`)}}async function _s(e){let t=e.replace(/^wss:\/\//i,"https://");console.log("###############"),console.log("Fetching relay information from",t),console.log("###############");const n=new AbortController;return setTimeout(()=>{n.abort()},5e3),Fe(t,{Accept:"application/nostr+json"})}var $s=class extends Ls{constructor(e,t){super(e),(!t&&e||e&&t.connectManually!==!0)&&this.connectRelays()}connectRelays(){console.log(`=> Connecting to ${this.relays.length} relay(s) ...`);for(const e of this.relays)if(!e.isConnected())try{e.ws=new Us,e.ws.connect(e.url),e.ws.connection.onopen=()=>{`${e.id}${e.url}`},e.ws.connection.onclose=t=>{console.log(`WebSocket ID ${e.id} error: `,t)},e.ws.connection.onerror=t=>{console.log(`WebSocket ID ${e.id} disconnected from ${e.url}`,t.code,t.reason)}}catch(t){console.error("Error connecting to relay",t)}}loadFromDiscovered(e){this.addInitialRelays(e.map(t=>({url:t.url,read:!0,write:!0}))),this.connectRelays()}async getRelayInformation(){const e=[];for(const t of this.relays)if(!t.info)try{t.info=await _s(t.url),console.log(`Relay ${t.url} information`,t.info),e.push(t.getInfo("withInfo"))}catch(n){console.error("Error getting relay information",n)}return e}},Ps=class extends bt{constructor(e){super(e)}async makeZapRequest(e,t){const n=this.getLud16Or06Url();if(n)try{if(!this.hasZapInfo()){const c=await Fe(n.url);if(!ps(c))throw new Error("Lnurl endpoint does not allow Nostr payments. Expected to find 'allowsNostr' in response.");this.lightningZapInfo=c}console.log("LnurlEndpointResponse",this.lightningZapInfo);const r={...e,recipientPubkey:this.pubkey,lnurl:n.type==="lud16"?vs(this.getLud16()):this.getLud06()},s=Bs(r,this.lightningZapInfo.callback,t),i=await Fe(s.invoiceUrl);if(!ws(r,i))throw new Error("Lnurl invoice response is invalid or does not match your request.");return console.log("LnurlInvoiceResponse",i),{...i,event:s.event}}catch(r){throw new Error(`Error making zap request: ${r}`)}else throw new Error("No lud16 or lud06 url found")}async makeNIP05Request(){const e=this.getNip05Url();if(e)try{return await Fe(e)}catch(t){throw new Error(`Error making NIP05 request: ${t}`)}else throw new Error("No nip05 url found")}};const Ms=(e,t)=>t.some(n=>e instanceof n);let bn,mn;function Hs(){return bn||(bn=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function qs(){return mn||(mn=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const En=new WeakMap,mt=new WeakMap,vn=new WeakMap,Et=new WeakMap,vt=new WeakMap;function Ws(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",c)},i=()=>{n(ge(e.result)),s()},c=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",c)});return t.then(n=>{n instanceof IDBCursor&&En.set(n,e)}).catch(()=>{}),vt.set(t,e),t}function zs(e){if(mt.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",c),e.removeEventListener("abort",c)},i=()=>{n(),s()},c=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",c),e.addEventListener("abort",c)});mt.set(e,t)}let At={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return mt.get(e);if(t==="objectStoreNames")return e.objectStoreNames||vn.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ge(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function js(e){At=e(At)}function Fs(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const r=e.call(Tt(this),t,...n);return vn.set(r,t.sort?t.sort():[t]),ge(r)}:qs().includes(e)?function(...t){return e.apply(Tt(this),t),ge(En.get(this))}:function(...t){return ge(e.apply(Tt(this),t))}}function Gs(e){return typeof e=="function"?Fs(e):(e instanceof IDBTransaction&&zs(e),Ms(e,Hs())?new Proxy(e,At):e)}function ge(e){if(e instanceof IDBRequest)return Ws(e);if(Et.has(e))return Et.get(e);const t=Gs(e);return t!==e&&(Et.set(e,t),vt.set(t,e)),t}const Tt=e=>vt.get(e);function Zs(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const c=indexedDB.open(e,t),o=ge(c);return r&&c.addEventListener("upgradeneeded",a=>{r(ge(c.result),a.oldVersion,a.newVersion,ge(c.transaction),a)}),n&&c.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),o.then(a=>{i&&a.addEventListener("close",()=>i()),s&&a.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),o}const Ds=["get","getKey","getAll","getAllKeys","count"],Ns=["put","add","delete","clear"],xt=new Map;function An(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(xt.get(t))return xt.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=Ns.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Ds.includes(n)))return;const i=async function(c,...o){const a=this.transaction(c,s?"readwrite":"readonly");let u=a.store;return r&&(u=u.index(o.shift())),(await Promise.all([u[n](...o),s&&a.done]))[0]};return xt.set(t,i),i}js(e=>({...e,get:(t,n,r)=>An(t,n)||e.get(t,n,r),has:(t,n)=>!!An(t,n)||e.has(t,n)}));const Js=25;/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Tn=Symbol("Comlink.proxy"),Vs=Symbol("Comlink.endpoint"),Ys=Symbol("Comlink.releaseProxy"),St=Symbol("Comlink.finalizer"),Ge=Symbol("Comlink.thrown"),xn=e=>typeof e=="object"&&e!==null||typeof e=="function",Xs={canHandle:e=>xn(e)&&e[Tn],serialize(e){const{port1:t,port2:n}=new MessageChannel;return It(e,t),[n,[n]]},deserialize(e){return e.start(),ti(e)}},Qs={canHandle:e=>xn(e)&&Ge in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},Sn=new Map([["proxy",Xs],["throw",Qs]]);function Ks(e,t){for(const n of e)if(t===n||n==="*"||n instanceof RegExp&&n.test(t))return!0;return!1}function It(e,t=globalThis,n=["*"]){t.addEventListener("message",function r(s){if(!s||!s.data)return;if(!Ks(n,s.origin)){console.warn(`Invalid origin '${s.origin}' for comlink proxy`);return}const{id:i,type:c,path:o}=Object.assign({path:[]},s.data),a=(s.data.argumentList||[]).map(Ee);let u;try{const p=o.slice(0,-1).reduce((E,I)=>E[I],e),d=o.reduce((E,I)=>E[I],e);switch(c){case"GET":u=d;break;case"SET":p[o.slice(-1)[0]]=Ee(s.data.value),u=!0;break;case"APPLY":u=d.apply(p,a);break;case"CONSTRUCT":{const E=new d(...a);u=oi(E)}break;case"ENDPOINT":{const{port1:E,port2:I}=new MessageChannel;It(e,I),u=ii(E,[E])}break;case"RELEASE":u=void 0;break;default:return}}catch(p){u={value:p,[Ge]:0}}Promise.resolve(u).catch(p=>({value:p,[Ge]:0})).then(p=>{const[d,E]=Je(p);t.postMessage(Object.assign(Object.assign({},d),{id:i}),E),c==="RELEASE"&&(t.removeEventListener("message",r),In(t),St in e&&typeof e[St]=="function"&&e[St]())}).catch(p=>{const[d,E]=Je({value:new TypeError("Unserializable return value"),[Ge]:0});t.postMessage(Object.assign(Object.assign({},d),{id:i}),E)})}),t.start&&t.start()}function ei(e){return e.constructor.name==="MessagePort"}function In(e){ei(e)&&e.close()}function ti(e,t){return Rt(e,[],t)}function Ze(e){if(e)throw new Error("Proxy has been released and is not useable")}function Rn(e){return xe(e,{type:"RELEASE"}).then(()=>{In(e)})}const De=new WeakMap,Ne="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(De.get(e)||0)-1;De.set(e,t),t===0&&Rn(e)});function ni(e,t){const n=(De.get(t)||0)+1;De.set(t,n),Ne&&Ne.register(e,t,e)}function ri(e){Ne&&Ne.unregister(e)}function Rt(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(i,c){if(Ze(r),c===Ys)return()=>{ri(s),Rn(e),r=!0};if(c==="then"){if(t.length===0)return{then:()=>s};const o=xe(e,{type:"GET",path:t.map(a=>a.toString())}).then(Ee);return o.then.bind(o)}return Rt(e,[...t,c])},set(i,c,o){Ze(r);const[a,u]=Je(o);return xe(e,{type:"SET",path:[...t,c].map(p=>p.toString()),value:a},u).then(Ee)},apply(i,c,o){Ze(r);const a=t[t.length-1];if(a===Vs)return xe(e,{type:"ENDPOINT"}).then(Ee);if(a==="bind")return Rt(e,t.slice(0,-1));const[u,p]=kn(o);return xe(e,{type:"APPLY",path:t.map(d=>d.toString()),argumentList:u},p).then(Ee)},construct(i,c){Ze(r);const[o,a]=kn(c);return xe(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:o},a).then(Ee)}});return ni(s,e),s}function si(e){return Array.prototype.concat.apply([],e)}function kn(e){const t=e.map(Je);return[t.map(n=>n[0]),si(t.map(n=>n[1]))]}const Bn=new WeakMap;function ii(e,t){return Bn.set(e,t),e}function oi(e){return Object.assign(e,{[Tn]:!0})}function Je(e){for(const[t,n]of Sn)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:r},s]}return[{type:"RAW",value:e},Bn.get(e)||[]]}function Ee(e){switch(e.type){case"HANDLER":return Sn.get(e.name).deserialize(e.value);case"RAW":return e.value}}function xe(e,t,n){return new Promise(r=>{const s=ci();e.addEventListener("message",function i(c){!c.data||!c.data.id||c.data.id!==s||(e.removeEventListener("message",i),r(c.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)})}function ci(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}class ai{constructor(){N(this,"_priority");N(this,"_background");N(this,"_current");this._priority=[],this._background=[],this._current=Promise.resolve()}enqueuePriority(t){const n=this._current.then(()=>t());return this._priority.push(n),this._current=n.catch(()=>{}),n}enqueueBackground(t){const n=this._current.then(()=>t());return this._background.push(n),this._current=n.catch(()=>{}),n}clearPriority(){this._priority=[]}clearBackground(){this._background=[]}async process(){for(;this._priority.length>0||this._background.length>0;){const t=this._priority.shift()||this._background.shift();t&&await t}this._current=Promise.resolve()}clear(){this._priority=[],this._background=[],this._current=Promise.resolve()}}const Ve=new ai;class ui{constructor(t){N(this,"connected");N(this,"db");N(this,"client");N(this,"eventsMap",new Map);N(this,"maxEvents");N(this,"checkedUsers",[]);N(this,"checkedEvents",[]);N(this,"eventsPublishingQueue",[]);N(this,"followingUserIds",[]);this.connected=!1,this.db=null,this.client=null,this.maxEvents=(t==null?void 0:t.maxEvents)||Js}async init(){this.db=await Zs("nostr-client",1,{upgrade(t){t.createObjectStore("users",{keyPath:"pubkey"}),t.createObjectStore("following",{keyPath:"pubkey"})}})}async connect(t,n){this.client=new $s(t),(n==null?void 0:n.autoLoadInfo)!==!1&&await this.client.getRelayInformation(),this.client.listen(async r=>{var s;await((s=this.addEvent)==null?void 0:s.call(this,r))})}disconnect(){var t,n;(t=this.client)==null||t.unsubscribeAll(),(n=this.client)==null||n.disconnect(),this.eventsMap.clear(),this.connected=!1}getRelays(){var t;return(t=this.client)!=null&&t.relays?this.client.relays.map(n=>n.getInfo("withInfo")):[]}async getSubscriptions(){var t;return((t=this.client)==null?void 0:t.getSubscriptions())||[]}async subscribe(t){var n;return(n=this.client)==null?void 0:n.subscribe({...t,filters:new je(t.filters)})}unsubscribe(t){var n;return(n=this.client)==null?void 0:n.unsubscribe(t)}unsubscribeAll(){var t;return(t=this.client)==null?void 0:t.unsubscribeAll()}setMaxEvents(t){this.maxEvents=t}async getUser(t){if(!this.db)throw new Error("DB not initialized");const n=await this.db.get("users",t);if(n)return new Ps(n)}async addUser(t){if(!this.db)throw new Error("DB not initialized");await this.db.put("users",t)}async updateUser(t){if(!this.db)throw new Error("DB not initialized");await this.db.put("users",t)}async countUsers(){if(!this.db)throw new Error("DB not initialized");return await this.db.count("users")}async addEvent(t){var r;if(!t.data)return;const n=t.data[0];if(n===he.AUTH||n===he.OK||n===he.NOTICE||n===he.COUNT||n===he.EOSE){if(postMessage({type:"relay:message",data:t}),n===he.OK){const s=t.data[1],i=t.data[2],c=t.data[3],o=this.eventsPublishingQueue.find(a=>a.event.id===s);if(o){const a=t.meta.id;for(const u of o.relays)u.id===a&&(u.accepted=i,u.error=i===!1?c:void 0);postMessage({type:"event:queue:update",data:o})}}return}if(n===he.EVENT){const s=t.data[2].kind;if(s===X.SHORT_TEXT_NOTE||s===X.LONG_FORM_CONTENT)Ve.enqueuePriority(async()=>{const i=t.data[2];if(this.eventsMap.size>=this.maxEvents)return;if(!(i.id?this.eventsMap.has(i.id):!1)&&i.pubkey){let o;const a=await this.getUser(i.pubkey);a?o={event:new ie(i),user:a,eventRelayUrls:[t.meta.url]}:o={event:new ie(i),eventRelayUrls:[t.meta.url]},this.eventsMap.set(o.event.id,o),postMessage({type:"event:new",data:o})}});else if(s===X.METADATA){const i=new bt;i.fromEvent(t.data[2]);const c=await this.getUser(i.pubkey);c?(await this.updateUser(i),await this.updateUserFollowing(c)):(await this.addUser(i),await this.updateUserFollowing(i));for(const o of this.eventsMap.values())((r=o.user)==null?void 0:r.pubkey)===i.pubkey&&(o.user=i,postMessage({type:"event:update",data:o}))}else s===X.REACTION?Ve.enqueueBackground(async()=>{const i=new ie(t.data[2]),c=i.hasEventTags();if(c){for(const o of this.eventsMap.values())if(c.find(a=>a.eventId===o.event.id)){o.reactions?o.reactions.push(i):o.reactions=[i],console.log(`Reaction event added to event ${o.event.id}`),postMessage({type:"event:update",data:o});return}}}):s===X.REPOST&&Ve.enqueueBackground(async()=>{const i=new ie(t.data[2]),c=i.hasEventTags();if(!c){console.log("No response found for repost event");return}for(const o of this.eventsMap.values())if(c.find(a=>a.eventId===o.event.id)){o.reposts?o.reposts.push(i):o.reposts=[i],console.log(`Repost event found for ${o.event.id}`),postMessage({type:"event:update",data:o});return}})}}getEventById(t){return this.eventsMap.get(t)}async sendEvent(t,n){if(!this.client)throw new Error("Client not initialized");const r=new ie(t),s=this.client.sendEvent(r,n);if(s){(t.kind===X.SHORT_TEXT_NOTE||t.kind===X.LONG_FORM_CONTENT||t.kind===X.RECOMMEND_RELAY)&&(this.eventsMap.set(r.id,{event:r,eventRelayUrls:s.map(c=>c.relay.url)}),postMessage({type:"event:new",data:{event:r,eventRelayUrls:s.map(c=>c.relay.url)}}));const i={event:r,send:!0,relays:s.map(c=>({id:c.relay.id,send:!0}))};return this.eventsPublishingQueue.push(i),postMessage({type:"event:queue:update",data:i}),s}else throw new Error("Failed to send event")}clearEvents(){console.log("WORKER: CLEAR EVENTS"),Ve.clearPriority(),this.eventsMap.clear(),this.checkedEvents=[],this.checkedUsers=[]}async followUser(t){if(!this.db)throw new Error("DB not initialized");const n=await this.db.get("users",t),r=await this.db.get("following",t);if(n&&!r)this.db.add("following",n);else if(!n&&!r){const s=new bt({pubkey:t});await this.db.put("following",s),await this.requestInformation("users",[t])}this.followingUserIds.push(t)}async unfollowUser(t){if(!this.db)throw new Error("DB not initialized");await this.db.delete("following",t),this.followingUserIds=this.followingUserIds.filter(n=>n!==t)}async followingUser(t){if(!this.db)throw new Error("DB not initialized");return!!await this.db.get("following",t)}async getAllUsersFollowing(){if(!this.db)throw new Error("DB not initialized");const t=await this.db.getAll("following");return this.followingUserIds=t.map(n=>n.pubkey),t}async updateUserFollowing(t){if(!this.db)throw new Error("DB not initialized");await this.db.get("following",t.pubkey)&&await this.db.put("following",t)}async requestInformation(t,n,r){if(n.length===0)return;const s=(r==null?void 0:r.timeout)||1e4;let i=[];if(t==="events"){if(i=n.filter(o=>!this.checkedEvents.includes(o)),i.length===0)return;this.checkedEvents=[...this.checkedEvents,...i]}else if(t==="users"){if(i=n.filter(o=>!this.checkedUsers.includes(o)),i.length===0)return;this.checkedUsers=[...this.checkedUsers,...i]}console.log(`=> Getting information for ${i.length} ${t}`);const c=[];for(let o=0;o<i.length;o+=25){const a=i.slice(o,o+25);let u;if(t==="events")u=new je({kinds:[X.REACTION,X.REPOST],"#e":i});else if(t==="users")u=new je({kinds:[X.METADATA],authors:a});else throw new Error("Invalid source");const p=await this.subscribe({filters:u});p&&c.push(...p)}c.length===0&&setTimeout(()=>{for(const o of c)this.unsubscribe(o.subscriptionId)},s)}async hasSubscriptionForEventIds(t,n){var i;if(!this.client)throw new Error("Client not initialized");const r=(i=this.client)==null?void 0:i.getSubscriptions();if(!r)return;const s=[];if(n)for(const c of t){const o=r.find(a=>{var u,p;return((u=a.filters["#e"])==null?void 0:u.includes(c))&&((p=a.filters.kinds)==null?void 0:p.some(d=>n.includes(d)))});o&&s.push(o.subscriptionId)}else for(const c of t){const o=r.find(a=>{var u;return(u=a.filters["#e"])==null?void 0:u.includes(c)});o&&s.push(o.subscriptionId)}return s.length>0?s:void 0}}const li=new ui;It(li)})();
